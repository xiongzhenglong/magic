Game9G=function(){this.gameid=null;this.game=null;this.isGameReady=false;this.cpid=null;this.spid=null;this.sp=null;this.isSpReady=false;this.source=null;this.animalid=null;this.roomid=null;this.logid=null;this.wechatid=null;this.abid=null;this.action=null;this.data=null;this.fromid=null;this.fromuser=null;this.baseurl="http://g.idods.cn";this.gameurl=null;this.homeurl=null;this.gzurl=null;this.moreurl=null;this.score=null;this.scoreName=null;this.shareDomain=null;this.shareDomains=["g.idods.cn","g.idods.cn","g.idods.cn"];this.shareData={imgurl:"http://game.9g.com/icon.png",link:this.baseurl,title:"9G游戏",content:"9G游戏"};this.app=null;this.ui=null;this.chat=null;this.site=null;this.user=null;this.isUserReady=false;this.isNewUser=false;this.event=null;this.pay=null;this.credit=null;this.pkuid=null;this.pklastuser=null;this.isReady=false;this.pk=null;this.roleid=null;this.role=null;this.isRoleReady=false;this.events={};this.options={init:true,loading:true,menu:true,ball:false,chat:true,open:false,spid:null,frame:null,pay:false,pk:false,start:function(){console.log("game start");return true},restart:function(){console.log("game restart");return true},gameover:function(){console.log("game over");return true}};this.utils=new Game9GUtils(this);this.startTime=new Date().getTime();this.loadingComplete=false;switch(arguments.length){case 0:break;case 1:if(typeof arguments[0]=="boolean")this.options.init=arguments[0];if(typeof arguments[0]=="string")this.gameid=arguments[0];if(typeof arguments[0]=="object")this.options=this.utils.extend(this.options,arguments[0]);break;case 2:this.gameid=arguments[0];if(typeof arguments[1]=="string")this.cpid=arguments[1];if(typeof arguments[1]=="object")this.options=this.utils.extend(this.options,arguments[1]);break};this.isInit=this.options.init;this.isLoading=(this.gameid!=null&&this.options.loading);this.isMenu=this.options.menu;this.isBall=(this.options.ball||this.utils.getAppType()=="kwhlx");this.isChat=(this.utils.getOrigin()==this.baseurl&&this.utils.getAppType()!="9g"&&this.utils.getAppType()!="pengpeng"&&this.options.chat);this.isOpen=this.options.open;this.spid=this.options.spid||null;this.frameid=this.options.frame;this.frameWin=null;this.isPay=this.options.pay;this.isPk=this.options.pk;this.auth=new Game9GAuth(this);this.init()};Game9G.prototype.init=function(){var _this=this;this.initSpid(this.spid);this.source=this.utils.getParameter("source");this.animalid=this.utils.getParameter("animalid");this.roomid=this.utils.getParameter("roomid");this.logid=this.utils.getParameter("logid");this.wechatid=this.utils.getParameter("wechatid");this.abid=this.utils.getParameter("abid");this.action=this.utils.getParameter("action");var data=this.utils.getParameter("data");if(data!=null){try{this.data=JSON.parse(decodeURIComponent(data))}catch(e){this.data=data}};this.fromid=this.utils.getParameter("id");this.isNewUser=(this.utils.getParameter("f")=="zf");this.homeurl=this.baseurl+"/gototop.html?r="+Math.random()+(this.spid?"&spid="+this.spid:"");this.gzurl=this.baseurl+"/goto9g.html?r="+Math.random()+(this.spid?"&spid="+this.spid:"");this.moreurl=(this.isNewUser?this.gzurl:this.homeurl);this.shareDomain=this.shareDomains[parseInt(Math.random()*this.shareDomains.length)];this.pkuid=this.utils.getParameter("pkuid");this.pklastuser=this.utils.getParameter("pklastuser");this.initSite();this.ui=new Game9GUI(this);if(this.isInit&&this.isBall){this.ui.showBall()};switch(this.utils.getAppType()){case"wx":this.app=new Game9GWx(this);break;case"qq":this.app=new Game9GQQ(this);break;case"9g":this.app=new Game9GApp(this);break;case"pengpeng":this.app=new Game9GPengPeng(this);break;case"uc":this.app=new Game9GUC(this);break;case"zhongsou":this.app=new Game9GZhongsou(this);break;case"gfan":this.app=new Game9GGfan(this);break;case"kwhlx":this.app=new Game9GKuaiwanHuluxia(this);break;case"ggzs":this.app=new Game9GGgzs(this);break};if(!this.isInit)return;if(this.gameid){this.initGame()};if(this.spid){this.initSp()};this.initUser();this.initSns();this.initLog();this.initCss();if(this.isPay){this.pay=new Game9GPay(this)};if(!this.isKuaiWan){this.initBindPhone()};this.initBindTip();this.initTopEvents();this.initFrameEvents();setTimeout(function(){_this.spCheck()},500)};Game9G.prototype.initSite=function(){this.isSite=false;if(this.gameid&&this.isOpen&&this.utils.getAppType()!="9g"&&this.utils.getAppType()!="pengpeng"&&(!this.spid||this.spid=="9g"||this.spid=="qing"||this.spid=="pea"||this.spid=="wanyou")){this.isBall=true;this.isChat=true;this.isSite=true}};Game9G.prototype.initGame=function(){var _this=this;this.gameurl="/gamecenter.html?gameid="+this.gameid+(this.spid?"&spid="+this.spid:"")+(localStorage.myuid?"&id="+localStorage.myuid:"")+"&f=zf";this.shareData.imgurl="http://game.9g.com/"+this.gameid+"/icon.png";this.shareData.link=this.baseurl+this.gameurl;if(this.utils.getAppType()=="wx"){this.gameurl+=("&domain="+this.shareDomain);this.shareData.link="http://"+parseInt(Math.random()*100000)+"."+this.gameid+"."+this.shareDomain+this.gameurl};if(this.isLoading&&!this.spid)this.utils.loading();if(this.isMenu){if(this.spid&&this.spid!="uc"&&this.spid!="9g"){}else if(this.utils.getAppType()=="9g"){}else if(this.utils.getAppType()=="pengpeng"){}else if(this.isPk){}else if(this.isOpen){}else{this.ui.showStart()}};if(this.utils.getAppType()=="9g"&&this.utils.isIOS()){setTimeout(function(){window.location="appcall::setbackurl::"+_this.baseurl+"/app/games.html?r="+Math.random()},1000)};this.connect();this.getGameInfo(this.gameid,function(data){if(data&&data.gameid){_this.game=_this.utils.extend(_this.game,data);_this.isGameReady=true;_this.dispatchEvent("gameReady",_this.game);if(_this.utils.getAppType()=="9g"||_this.utils.getAppType()=="pengpeng"){_this.app.onInitGame()}}});if(this.utils.getAppType()=="wx"&&(!this.spid||this.spid=="9g"||this.spid=="qing"||this.spid=="pea"||this.spid=="wanyou")||this.isKuaiWan||this.isHenKuai){this.initBall()};this.initGameBack();setTimeout(function(){_this.utils.showAd()},3500);_czc.push(["_setCustomVar","用户",(this.isNewUser?"新用户":"老用户"),1]);_czc.push(["_setCustomVar","gameid",this.gameid,1]);_czc.push(["_setCustomVar","spid",this.spid,1]);if(this.utils.getAppType()=="wx"){_czc.push(["_setCustomVar","wx_ver",this.app.version,1])}};Game9G.prototype.initGameBack=function(){if(typeof history["pushState"]!="function")return;if(this.utils.getAppType()=="9g"||this.utils.getAppType()=="pengpeng")return;if(this.spid&&this.spid!="9g"&&this.spid!="qing"&&this.spid!="pea"&&this.spid!="wanyou")return;if(localStorage.gameBackTipDate&&localStorage.gameBackTipDate==this.utils.formatDate(new Date(),"yyyy-MM-dd"))return;var _this=this;history.pushState({title:document.title,url:location.href},document.title,location.href);window.addEventListener("popstate",function(e){if(history.state)return;_this.ui.showGameBack()});};Game9G.prototype.onGameReady=function(callback){if(this.isGameReady){callback&&callback.call(null,this.game)}else{this.addEventListener("gameReady",callback)}};Game9G.prototype.initSpid=function(spid){if(spid){this.spid=spid}else{if(!/\/game\/pay(_\w+)?\.html/.test(location.href)){this.spid=this.utils.getParameter("spid")}};if(!this.spid)this.spid=this.getDefaultSpid();if(this.spid==undefined||this.spid=="")this.spid=null;if(this.spid!=null){sessionStorage.spid=this.spid}else if(sessionStorage.spid){this.spid=sessionStorage.spid};if(this.gameid&&this.spid&&!spid&&this.utils.getParameter("spid")==null){var url=this.utils.setParameter(location.href,"spid",this.spid);window.location.replace(url)};this.isKuaiWan=(this.spid!=null&&(this.spid=="kw"||this.spid.indexOf("kw_")==0));this.isHenKuai=(this.spid!=null&&(this.spid=="1"||this.spid.indexOf("henkuai")==0));this.isOpenSp=(this.spid=="game6"||this.spid=="aiwanh5"||this.spid=="peagame"||this.spid=="sixty"||this.spid=="layabox");if(this.isOpenSp){this.baseurl=this.getGameServer()};if(this.spid=="60h5")this.isLoading=false};Game9G.prototype.initSp=function(){var _this=this;if(this.isKuaiWan){this.initKuaiwan()};this.getSp(this.spid,function(data){var customLoading=false;var loading=function(){if(_this.isLoading){if(_this.isHenKuai){if(!_this.sp)_this.sp={};_this.sp.loading="http://game.9g.com/img/henkuai_9g.jpg";_this.utils.loadingSp();return};if(customLoading){_this.utils.loadingSp()}else{_this.utils.loading()}}};var ready=function(){_this.isSpReady=true;_this.dispatchEvent("spReady",_this.sp);if(_this.sp.loading)customLoading=true;loading()};if(data&&data.spid){_this.sp=data;if(data.parent&&!data.logo&&!data.loading){_this.getSp(data.parent,function(data){_this.sp.logo=data.logo;_this.sp.loading=data.loading;ready()})}else{ready()}}else{if(_this.isKuaiWan){_this.getSp("kw",function(data){_this.sp={spid:_this.spid};_this.sp.parent="kw";_this.sp.spname=data.spname;_this.sp.logo=data.logo;_this.sp.loading=data.loading;ready()})}else{loading()}}});this.onSpReady(function(){if(!_this.gameid){_this.shareData.link=_this.utils.setParameter(_this.shareData.link,"spid",_this.spid);if(_this.sp.spname){_this.shareData.content=_this.sp.spname};if(_this.sp.logo){_this.shareData.imgurl=_this.sp.logo}}else{if(_this.sp.spname){_this.shareData.content=_this.sp.spname}}})};Game9G.prototype.getWxAppId=function(){if(this.spid=="game6")return"wx093dfa177501b406";if(this.spid=="aiwanh5")return"wxe05ff32481dad99b";if(this.spid=="peagame")return"wxa96b1e63792ce3ec";if(this.spid=="sixty")return"wx6871f420cac35959";if(this.spid=="layabox")return"wx7c7908cfe6ec84b1";return"wxe0fb670c408a3705";};Game9G.prototype.getDefaultSpid=function(){if(location.hostname=="kw.idods.cn"||location.hostname=="kw.henkuai.com")return"kw";if(location.hostname=="game.fzqylp.com.cn"||location.hostname=="game.liuzhiping.com.cn"||location.hostname=="game.tgysw.net"||location.hostname=="game.lxjre.com"||location.hostname=="game.aikiddy.com"||location.hostname=="m.tianxinjiaolian.com"||location.hostname=="game.jingyuetuan.net")return"game6";if(location.hostname=="m.7885279.com")return"aiwanh5";if(location.hostname=="m.peagame.net"||location.hostname=="game.ptgcw.net"||location.hostname=="m.2987992.com"||location.hostname=="game.rtfnw.net"||location.hostname=="game.aitiboy.net"||location.hostname=="game.zuizuiyou.net"||location.hostname=="game.yinshuya.net"||location.hostname=="game.douqu126.net")return"peagame";if(location.hostname=="m.shachihuyu.com")return"sixty";if(location.hostname=="m.mokupi.cn"||location.hostname=="m.mousili.cn"||location.hostname=="m.gameyun901.net")return"layabox";return null;};Game9G.prototype.getGameServer=function(){if(this.isKuaiWan)return"http://kw.henkuai.com";if(this.spid=="game6")return"http://game.jingyuetuan.net";if(this.spid=="aiwanh5")return"http://m.7885279.com";if(this.spid=="peagame")return"http://game.douqu126.net";if(this.spid=="sixty")return"http://m.shachihuyu.com";if(this.spid=="layabox")return"http://m.gameyun901.net";return this.baseurl;};Game9G.prototype.getWxServer=function(){if(this.spid=="game6")return"http://wx.hkxf.org.cn";if(this.spid=="aiwanh5")return"http://wx.youxi135.net";if(this.spid=="peagame")return"http://wx.peagame.net";if(this.spid=="sixty")return"http://wx.shachihuyu.com";if(this.spid=="layabox")return"http://wx.mokupi.cn";return"http://wx.9g.com";};Game9G.prototype.getPayServer=function(){if(this.spid=="game6")return"http://pay.hkxf.org.cn";if(this.spid=="aiwanh5")return"http://pay.youxi135.net";if(this.spid=="peagame")return"http://pay.peagame.net";if(this.spid=="sixty")return"http://pay.shachihuyu.com";if(this.spid=="layabox")return"http://pay.mokupi.cn";return"http://pay.9g.com";};Game9G.prototype.onSpReady=function(callback){if(this.isSpReady){callback&&callback.call(null,this.sp)}else{this.addEventListener("spReady",callback)}};Game9G.prototype.initKuaiwan=function(){this.shareData.title="快玩游戏";this.shareData.content="快玩游戏"};Game9G.prototype.initUser=function(){var _this=this;this.auth.getUser(function(data){if(data){_this.isUserReady=true;_this.dispatchEvent("userReady",_this.user)}})};Game9G.prototype.onUserReady=function(callback){if(this.isUserReady){callback&&callback.call(null,this.user)}else{this.addEventListener("userReady",callback)}};Game9G.prototype.initSns=function(){var _this=this;this.getRoleList(function(){_this.isRoleReady=true;_this.dispatchEvent("roleReady",_this.role)});if(this.isChat){this.chat=new Game9GChat(this)}};Game9G.prototype.onRoleReady=function(callback){if(this.isRoleReady){callback&&callback.call(null,this.role)}else{this.addEventListener("roleReady",callback)}};Game9G.prototype.onLoadingComplete=function(callback){if(this.isLoading){if(this.loadingComplete){callback&&callback.call(null)}else{this.addEventListener("loadingComplete",callback)}}else{callback&&callback.call(null)}};Game9G.prototype.initBall=function(){if(!this.ui.start){this.ui.showBall()}};Game9G.prototype.initLog=function(){var _this=this;setTimeout(function(){_this.utils.logView()},500);setTimeout(function(){_this.utils.heartbeat()},1000)};Game9G.prototype.initBindPhone=function(){var _this=this;var frame=document.getElementById(this.frameid);window.addEventListener("message",function(e){if(typeof e.data!="object")return;switch(e.data.action){case"bindPhone":var redirect=e.data.redirect||(_this.gameid?_this.baseurl+"/gamecenter.html?gameid="+_this.gameid:location.href);_this.bindPhone({success:function(data){data.action="bindPhone:success";if(data.token){_this.postMessageTop({action:"token",token:data.token})};_this.postMessageFrame(data)},redirect:redirect,cancel:function(){_this.postMessageFrame({action:"bindPhone:cancel"})}});break}})};Game9G.prototype.initBindTip=function(){if(this.gameid&&this.spid&&localStorage.myuid&&localStorage.token){try{if(Base64.decode(localStorage.myuid).indexOf("wap-")==0){if(this.spid.indexOf("xcy")==0){var max=2;var interval=1000*60*3;if(this.isTest())interval=1000*5;var _this=this;setTimeout(function(){if(_this.user.phone)return;_this.showBindTip(1,max,interval)},interval)}}}catch(e){console.log(e)}}};Game9G.prototype.showBindTip=function(count,max,interval){var _this=this;this.utils.dialog({content:"您的帐号目前尚未绑定任何登录方式，是否立即绑定？",buttons:[{label:"绑定QQ",bgcolor:"#D2602D",click:function(){var redirect=_this.baseurl+"/gamecenter.html?gameid="+_this.gameid+(_this.spid?"&spid="+_this.spid:"");_this.bindQq(redirect)}},{label:"绑定手机",bgcolor:"#4CAB56",click:function(){_this.bindPhone({success:function(data){_this.utils.alert("恭喜绑定成功！您下次可以使用手机号 "+data.phone+" 登录了。")}})}},{label:(count<max?"稍候提示":"不再提示"),bgcolor:"#CCC",click:function(){if(count<max){setTimeout(function(){_this.showBindTip(++count,max,interval)},interval)}}}]})};Game9G.prototype.initTopEvents=function(){this.postMessageTop({action:"init",gameid:this.gameid,spid:this.spid});var _this=this;this.addEventListener("gameReady",function(){_this.postMessageTop({action:"gameReady",game:_this.game})});this.addEventListener("spReady",function(){_this.postMessageTop({action:"spReady",sp:_this.sp})});this.addEventListener("userReady",function(){_this.postMessageTop({action:"userReady",user:_this.user})});this.addEventListener("roleReady",function(){_this.postMessageTop({action:"roleReady",roleid:_this.roleid,role:_this.role})})};Game9G.prototype.initFrameEvents=function(){var _this=this;window.addEventListener("message",function(e){if(e.source==window)return;if(typeof e.data!="object")return;switch(e.data.action){case"init:frame":if(e.data.frameDeep)_this.frameWin=e.source;break;case"share:setShareData":var shareData={title:e.data.title,content:e.data.content};if(e.data.imgurl)shareData.imgurl=e.data.imgurl;if(e.data.link)shareData.link=_this.baseurl+"/share.html?url="+encodeURIComponent(e.data.link)+(_this.spid?"&spid="+_this.spid:"");_this.setShareData(shareData);break;case"share:showShareTip":_this.shareBranch();break;case"share:getFromUser":_this.auth.getFromUser(function(user){var u=user?{uid:user.uid,nickname:user.nickname}:null;_this.postMessageFrame({action:"share:getFromUser:callback",user:u})});break;case"add:shortcut":_this.addShortcut(function(result){_this.postMessageFrame({action:"add:shortcut:callback",result:result})});break;case"check:subscribe":_this.checkSubscribe(function(isSubscribe){_this.postMessageFrame({action:"check:subscribe:result",result:isSubscribe?1:0})});break;case"goto:subscribe":_this.subscribeBranch();break;case"game:createRole":_this.createRole(e.data.role,function(data){_this.postMessageFrame({action:"game:createRole:callback",data:data})});break}});if(window!=top&&this.spid=="60h5"){window.addEventListener("message",function(e){if(e.source==window)return;if(typeof e.data!="object")return;switch(e.data.action){case"share:ok":_this.postShareOK();break;case"pay:callback":_this.pay&&_this.pay.payCallback(e.data.status);break;case"pay:cancel":_this.pay&&_this.pay.payCancel();break}})}};Game9G.prototype.postMessageTop=function(data){if(top!=window)top.postMessage(data,"*")};Game9G.prototype.postMessageFrame=function(data){var frame=document.getElementById(this.frameid);if(this.frameWin){this.frameWin.postMessage(data,"*")}else if(frame){frame.contentWindow.postMessage(data,"*")}else{window.postMessage(data,"*")}};Game9G.prototype.initCss=function(){if(this.utils.isAndroid()){var width=window.innerWidth;var height=window.innerHeight;var getCssLink=function(){var css="http://game.9g.com/css/game9g.css";return"http://pp.9g.com/tools/csshacker?url="+encodeURIComponent(css)+"&width="+width+"&height="+height};var link=document.createElement("link");link.rel="stylesheet";link.type="text/css";link.href=getCssLink();var body=null;var addLink=function(){body=document.getElementsByTagName("body")[0];if(body){body.appendChild(link)}else{setTimeout(addLink,500)}};addLink();var count=0;var check=function(){setTimeout(function(){count++;var w=window.innerWidth;var h=window.innerHeight;if(w!=width||h!=height){width=w;height=h;link.href=getCssLink();console.log("css hacker reset: width = "+width+", height = "+height)};check()},count<10?1000:3000)};check();}};Game9G.prototype.spCheck=function(){if(location.href.indexOf("sp_block.html")!=-1)return;var _this=this;this.utils.ajax("http://wx.9g.com/open/sp_check.jsp?token="+(localStorage.token||"")+"&spid="+(this.spid||""),function(data){if(data.errcode==-1){window.location.replace(_this.baseurl+"/app/sp_block.html?spid="+_this.spid+(_this.sp&&_this.sp.spname?"&spname="+encodeURIComponent(_this.sp.spname):""))}})};Game9G.prototype.showSite=function(id){if(!this.site){var site=new Game9GSite(this);site.select(id||"ka");setTimeout(function(){site.show()},100);this.site=site}else{this.site.show(id)}};Game9G.prototype.setBallMenuItems=function(list){if(!this.ui.ball||!this.ui.ball.menu)return;this.ui.ball.menu.clear();this.ui.ball.menu.addItems(list)};Game9G.prototype.addBallMenuItem=function(data){if(!this.ui.ball||!this.ui.ball.menu)return;this.ui.ball.menu.addItem(data)};Game9G.prototype.startPk=function(){if(!this.isRoleReady){var _this=this;this.addEventListener("roleReady",function(){_this.startPk()})}else{console.log("start pk");this.pk=new Game9GPK(this)}};Game9G.prototype.addEventListener=function(){var type=arguments[0];var callback=arguments[1];var once=(arguments.length==3?arguments[2]:false);if(!this.events[type])this.events[type]=[];this.events[type].push({once:once,callback:callback})};Game9G.prototype.on=function(){var types=arguments[0];var callback=arguments[1];var once=(arguments.length==3?arguments[2]:false);var a=types.split(" ");for(var i=0;i<a.length;i++){var type=a[i];this.addEventListener(type,callback,once)}};Game9G.prototype.dispatchEvent=function(){var type=arguments[0];var params=[];var i;if(arguments.length>1){for(i=1;i<arguments.length;i++){params.push(arguments[i])}};var list=this.events[type];var onces=[];if(list){for(i=0;i<list.length;i++){var item=list[i];var once=item.once;var callback=item.callback;if(params.length>0){callback.apply(this,params)}else{callback.call(this)};if(once){onces.push(i)}}while(onces.length>0){var index=onces.pop();list.splice(index,1)}}};Game9G.prototype.connect=function(){var url;var _this=this;if(localStorage.accessToken){url="http://wx.9g.com/auth/connect2?gameid="+this.gameid+"&access_token="+localStorage.accessToken+(this.spid?"&spid="+this.spid:"")+(this.fromid?"&uid="+this.fromid:"");this.utils.ajax(url,function(data){if(data.errcode){_this.auth.clear();_this.user=null}else{localStorage.myuid=data.uid;_this.user=_this.utils.extend(_this.user,data.user);_this.game=_this.utils.extend(_this.game,data.game);}})}else{url="http://wx.9g.com/auth/connect3?gameid="+this.gameid+(this.spid?"&spid="+this.spid:"")+(this.utils.getParameter("f")=="zf"?"&f=zf":"");this.utils.ajax(url,function(data){_this.game=_this.utils.extend(_this.game,data.game);})}};Game9G.prototype.bonus=function(){};Game9G.prototype.checkSubscribe=function(callback){if(!localStorage.myuid){callback&&callback.call(null,false);return};var url="http://wx.9g.com/app/checksubscribe?uid="+localStorage.myuid+"&r="+Math.random();this.utils.ajax(url,function(data){if(data&&data.subscribe){callback&&callback.call(null,true)}else{callback&&callback.call(null,false)}})};Game9G.prototype.getGameInfo=function(gameid,callback){this.utils.ajax("http://wx.9g.com/app/gameinfo?gameid="+gameid,callback)};Game9G.prototype.getGameDetail=function(gameid,callback){this.utils.ajax("http://wx.9g.com/app/gamedetail?gameid="+gameid,callback)};Game9G.prototype.getEventUrl=function(){return this.baseurl+"/app/event.html?r="+Math.random()};Game9G.prototype.getEventToday=function(callback){var url="http://wx.9g.com/event/getevent?gameid="+this.gameid+(localStorage.myuid?"&uid="+localStorage.myuid:"");var _this=this;this.utils.ajax(url,function(data){if(data.user)_this.user=_this.utils.extend(_this.user,data.user);if(data.game)_this.game=_this.utils.extend(_this.game,data.game);if(data.event)_this.event=data.event;if(_this.user&&(_this.spid==null||_this.spid=="uc")){};callback&&callback.apply(_this)})};Game9G.prototype.setShareData=function(shareData){if(shareData)this.shareData=this.utils.extend(this.shareData,shareData);if(this.app&&this.app.setShareData)this.app.setShareData()};Game9G.prototype.share=function(){this.app&&this.app.share()};Game9G.prototype.shareBranch=function(){var _this=this;switch(this.spid){case"sina":window.shareSina&&window.shareSina.call(null,this.shareData);break;case"iqiyi":var msg={position:"game_share",data:"show"};window.parent.postMessage(msg,"*");setTimeout(function(){_this.postShareOK()},5000);break;case"qqbrowser":window.shareQQBrowser&&window.shareQQBrowser.call(null,this.shareData);break;case"60h5":window.parent.postMessage({action:"share:setShareData",title:this.shareData.title,content:this.shareData.content},"*");window.parent.postMessage({action:"share:showShareTip"},"*");break;default:if(typeof window["shareChannel"]=="function"){window.shareChannel.call(null,this.shareData)}else{this.utils.shareTip(true)};break}};Game9G.prototype.postShareOK=function(){this.utils.closeShareTip();this.postMessageFrame({action:"share:ok"})};Game9G.prototype.addShortcut=function(callback){window.addShortcut&&window.addShortcut.call(null,callback)};Game9G.prototype.subscribeBranch=function(){var options={};switch(this.spid){case"falaomiao":options.qrcode="http://game.9g.com/img/qrcode_falaomiao.jpg";break;default:break};this.ui.showSubscribe(options)};Game9G.prototype.createRole=function(role,callback){if(!localStorage.token)return;var url="http://wx.9g.com/app/gamerole?gameid="+this.gameid+"&token="+localStorage.token+(this.wechatid?"&wechatid="+this.wechatid:"")+(this.abid?"&abid="+this.abid:"");this.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9G.prototype.shareLog=function(options,callback){var url="http://wx.9g.com/app/gameshare";if(options.gameid)url=this.utils.setParameter(url,"gameid",options.gameid);if(options.spid)url=this.utils.setParameter(url,"spid",options.spid);if(localStorage.token)url=this.utils.setParameter(url,"token",localStorage.token);if(options.id)url=this.utils.setParameter(url,"id",options.id);if(this.fromid)url=this.utils.setParameter(url,"fromid",this.fromid);if(options.source)url=this.utils.setParameter(url,"source",options.source);if(options.type)url=this.utils.setParameter(url,"type",options.type);if(options.domain)url=this.utils.setParameter(url,"domain",options.domain);this.utils.ajax(url,function(data){callback&&callback.apply(null)})};Game9G.prototype.shareFlow=function(){var _this=this;if(this.utils.getAppType()=="wx"&&this.isNewUser&&!!this.spid&&this.spid!="9g"&&this.spid!="uc"&&this.spid!="zhongsou"&&this.spid!="51h5"){if(this.app&&!this.app.shareOK)this.app.shareOK=function(){window.location=_this.moreurl};this.utils.shareTip();return};if(this.event){if(this.event.gameid==this.gameid){if(this.app&&!this.app.shareOK)this.app.shareOK=function(){if(!_this.isSubmitted||_this.isSubmitted&&_this.score!=_this.autoScore){_this.submit(function(){window.location=_this.moreurl})}else{window.location=_this.moreurl}};this.utils.shareTip()}else{if(this.app&&!this.app.shareOK)this.app.shareOK=function(){window.location=_this.moreurl};this.utils.shareTip()}}else{if(this.app&&!this.app.shareOK)this.app.shareOK=function(){window.location=_this.moreurl};this.utils.shareTip()}};Game9G.prototype.entry=function(gameid,callback){var _this=this;var url="http://wx.9g.com/app/gameentry?gameid="+gameid+(this.spid?"&spid="+this.spid:"")+(localStorage.token?"&token="+localStorage.token:"");this.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9G.prototype.loadReady=function(gameid,callback){var _this=this;var url="http://wx.9g.com/app/gameload?gameid="+gameid+(localStorage.token?"&token="+localStorage.token:"");this.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9G.prototype.autoSubmit=function(callback){var _this=this;if(localStorage.myuid&&this.score!=null&&this.score>0){if(!this.isSubmitted||this.isSubmitted&&(this.gameOrder=="asc"&&this.score<this.rankScore||this.gameOrder=="desc"&&this.score>this.rankScore)){this.submit(function(data){if(data.success){_this.isSubmitted=true;_this.gameOrder=data.order;_this.rankScore=data.refreshRankScore||data.lastRankScore==-1?_this.score:data.lastRankScore;_this.autoScore=_this.score;if(_this.app&&_this.app.onAutoSubmit)_this.app.onAutoSubmit.call(null,data);callback&&callback.call(null,data)}})}}};Game9G.prototype.submit=function(callback){if(!localStorage.myuid){return};if(this.score==null||isNaN(this.score)){return};var pkuid=(this.fromid&&this.fromid!=localStorage.myuid?this.fromid:"");var notice="";if(pkuid&&!this.notice){notice="y";this.notice=true};var pklastuser=(this.pklastuser?"y":"");var a=[this.gameid,localStorage.myuid,this.score,encodeURIComponent(this.scoreName),encodeURIComponent(this.shareData.title),pkuid,notice,pklastuser];var _this=this;this.utils.onCryptoJSReady(function(){var data=Base64.encode(_this.utils.encrypt("game9gcom2014123",a.join("|")));var url="http://wx.9g.com/event/submit?data="+data+(_this.source?"&source="+_this.source:"");_this.utils.ajax(url,function(data){if(data.success){callback&&callback.call(null,data)}else{_this.utils.debug("提交失败")}})})};Game9G.prototype.ready=function(){if(this.isReady)return;console.log("game ready");this.isReady=true;if(this.isPk){if(this.isLoading){var duration=new Date()-this.startTime;var interval=2500-duration;if(interval<10)interval=10;var _this=this;setTimeout(function(){_this.startPk()},interval)}else{this.startPk()}}};Game9G.prototype.progress=function(data){console.log("game progress: "+JSON.stringify(data));if(this.isPk){this.pk.progress(data)}};Game9G.prototype.finish=function(data){console.log("game over: "+JSON.stringify(data));if(this.isPk){this.pk.finish(data)}};Game9G.prototype.getRoleList=function(callback){if(!localStorage.token)return;var _this=this;this.utils.ajax("http://pp.9g.com/im/getrolelist?token="+localStorage.token,function(data){if(data&&data.role_id){_this.roleid=data.role_id;for(var i=0;i<data.list.length;i++){var role=data.list[i];if(role.role_id==data.role_id){_this.role=role;break}};callback&&callback.call(null)}})};Game9G.prototype.getRole=function(roleid,callback){var url="http://pp.9g.com/im/getrole?role_id="+roleid;this.utils.ajax(url,function(data){if(data&&data.role_id){callback&&callback.call(null,data)}})};Game9G.prototype.getRoles=function(roleids,callback){var url="http://pp.9g.com/im/getroles";for(var i=0;i<roleids.length;i++){url+=(i==0?"?":"&");url+=("role_id="+roleids[i])};this.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9G.prototype.addFeed=function(type,topic,json,callback){if(!localStorage.token)return;var url="http://pp.9g.com/im/addfeed?token="+localStorage.token+"&type="+type+(topic?"&topic="+topic:"")+"&content="+encodeURIComponent(JSON.stringify(json));this.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9G.prototype.addFeedGame=function(callback){if(!this.game)return;var topic=null;topic=this.game.gameName;var json={gameid:this.gameid,gamename:this.game.gameName,gameurl:this.gameurl,gameicon:this.game.gameIcon,text:this.shareData.title};this.addFeed(3,topic,json,callback)};Game9G.prototype.addFeedComment=function(feedId,content,callback){if(!localStorage.token)return;var url="http://pp.9g.com/im/addfeedcomment?token="+localStorage.token+"&feed_id="+feedId+"&content="+encodeURIComponent(content);this.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9G.prototype.chooseGame=function(callback){var _this=this;this.utils.ajax("http://pp.9g.com/im/gethotgames",function(data){_this.ui.showChooseGame(data,function(game){callback&&callback.call(null,game)})})};Game9G.prototype.getGamePlay=function(uid,gameid,callback){var url="http://wx.9g.com/sns/getgameplay?uid="+uid+"&gameid="+gameid;this.utils.ajax(url,function(data){if(data.id){callback&&callback.call(null,data)}})};Game9G.prototype.getCredit=function(callback){if(!localStorage.token)return;var url="http://wx.9g.com/credit/getcredit?token="+localStorage.token;var _this=this;this.utils.ajax(url,function(data){if(data&&data.credit!=undefined){_this.credit=data.credit;callback&&callback.call(null,data.credit)}})};Game9G.prototype.getSp=function(spid,callback){this.utils.ajax("http://wx.9g.com/open/getsp?spid="+spid,function(data){callback&&callback.call(null,data)})};Game9G.prototype.loginQq=function(redirect){var fromurl=this.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(redirect);window.location="http://wx.9g.com/open/loginqq?fromurl="+encodeURIComponent(fromurl)+(this.spid?"&spid="+this.spid:"")};Game9G.prototype.bindQq=function(redirect){var fromurl=this.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(redirect);window.location="http://wx.9g.com/open/loginqq?fromurl="+encodeURIComponent(fromurl)+(localStorage.token?"&token="+localStorage.token:"")+(this.spid?"&spid="+this.spid:"")};Game9G.prototype.bindPhone=function(options){var defaults={success:null,redirect:location.href,cancel:null};options=this.utils.extend(defaults,options);if(this.user){options.action="bindPhone";if(this.user.phone){options.step="result"}else{options.step="form"}}else{options.action="login";options.step="form"};this.ui.showBindPhone(options)};Game9G.prototype.loginRegister=function(phone,password,callback){var _this=this;var url="http://wx.9g.com/app/login?phone="+phone+"&password="+Base64.encode(password);this.utils.ajax(url,function(data){if(!data){alert("登录失败");return};if(data.errcode){switch(data.errcode){case 40004:if(!_this.checkPhonePassword(phone,password))return;callback&&callback.call(null,"register");break;case 40007:alert("密码错误");break;default:alert("登录失败");break}}else{callback&&callback.call(null,"login",data)}})};Game9G.prototype.registerVerify=function(phone,password,code,callback){if(!code){alert("请输入验证码");return};var _this=this;this.checkVcode(phone,code,function(result){if(result){var url="http://wx.9g.com/app/register?phone="+phone+"&password="+Base64.encode(password)+(_this.spid?"&spid="+_this.spid:"");_this.utils.ajax(url,function(data){if(!data){alert("注册失败");return};if(data.errcode){alert("注册失败："+data.errmsg+"（"+data.errcode+"）")}else{data.phone=phone;callback&&callback.call(null,data)}})}else{alert("验证码错误")}})};Game9G.prototype.checkPhonePassword=function(phone,password){if(!phone||isNaN(phone)||phone.length!=11){alert("请输入有效的手机号");return false};if(password.length<6){alert("请设置不少于6位的密码");return false};return true};Game9G.prototype.bindPhoneCheck=function(phone,password,callback){if(!this.checkPhonePassword(phone,password))return;this.utils.ajax("http://wx.9g.com/app/checkphone?phone="+phone,function(data){if(data&&data.exist==1){alert("这个手机号已经被绑定了，请输入其它的手机号。")}else{callback&&callback.call(null)}})};Game9G.prototype.bindPhoneVerify=function(phone,password,code,callback){if(!code){alert("请输入验证码");return};var _this=this;this.checkVcode(phone,code,function(result){if(result){var url="http://wx.9g.com/app/bindphone?phone="+phone+"&password="+Base64.encode(password)+"&token="+localStorage.token;_this.utils.ajax(url,function(data){if(data&&data.uid){if(_this.user)_this.user.phone=phone;data.token=localStorage.token;data.phone=phone;callback&&callback.call(null,data)}else if(data&&data.errcode){alert("绑定失败："+data.errmsg+"（"+data.errcode+"）")}else{alert("绑定失败")}})}else{alert("验证码错误")}})};Game9G.prototype.resetPasswordCheck=function(phone,password,callback){if(!this.checkPhonePassword(phone,password))return;this.utils.ajax("http://wx.9g.com/app/checkphone?phone="+phone,function(data){if(data&&data.exist==1){callback&&callback.call(null,true)}else{if(confirm("这个手机号还没有注册，是否立即注册？")){callback&&callback.call(null,false)}}})};Game9G.prototype.resetPasswordVerify=function(phone,password,code,callback){if(!code){alert("请输入验证码");return};var _this=this;this.resetPassword(phone,password,code,function(data){if(data.success){callback&&callback.call(null)}else if(data.error){alert(data.error)}else{alert("重设密码失败")}})};Game9G.prototype.sendVcode=function(phone,content,callback){this.utils.ajax("http://pp.9g.com/sms/checkcode?action=send&mobile="+phone+"&id="+this.utils.getSessionId()+"&content="+content,function(data){callback&&callback.call(null,data)})};Game9G.prototype.checkVcode=function(phone,code,callback){this.utils.ajax("http://pp.9g.com/sms/checkcode?action=check&mobile="+phone+"&code="+code,function(data){var result=(data&&data.errCode==0)?true:false;callback&&callback.call(null,result)})};Game9G.prototype.resetPassword=function(phone,password,code,callback){this.utils.ajax("http://pp.9g.com/sms/resetpass?phone="+phone+"&password="+Base64.encode(password)+"&code="+code,function(data){callback&&callback.call(null,data)})};Game9G.prototype.getCaptchaCode=function(img){img.src="http://wx.9g.com/captcha/getcode?id="+this.utils.getSessionId()};Game9G.prototype.checkCaptchaCode=function(content,callback){this.utils.ajax("http://wx.9g.com/captcha/checkcode?id="+this.utils.getSessionId()+"&content="+content,function(data){callback&&callback.call(null,data)})};Game9G.prototype.loginUser=function(options){var defaults={success:null,redirect:location.href,cancel:null};options=this.utils.extend(defaults,options);options.action="login";options.step="form";this.ui.showLoginUser(options)};Game9G.prototype.checkUsernamePassword=function(username,password){if(!username||username.length<6){alert("用户名至少6位，由字母、数字和下划线组成，且必须以字母开头。");return false};if(password.length<6){alert("请设置不少于6位的密码");return false};return true};Game9G.prototype.loginUsernamePassword=function(username,password,callback){var _this=this;var url="http://wx.9g.com/app/login?username="+username+"&password="+Base64.encode(password);this.utils.ajax(url,function(data){if(!data){alert("登录失败");return};if(data.errcode){switch(data.errcode){case 40007:alert("密码错误");break;default:alert("登录失败："+data.errmsg+"（"+data.errcode+"）");break}}else{callback&&callback.call(null,data)}})};Game9G.prototype.registerUsernamePassword=function(username,password,callback){var _this=this;var url="http://wx.9g.com/app/register?username="+encodeURIComponent(username)+"&password="+Base64.encode(password)+(this.spid?"&spid="+this.spid:"");this.utils.ajax(url,function(data){if(!data){alert("注册失败");return};if(data.errcode){alert("注册失败："+data.errmsg+"（"+data.errcode+"）")}else{callback&&callback.call(null,data)}})};Game9G.prototype.isTest=function(){return(this.utils.getParameter("istest")=="y"||localStorage.istest=="y"||this.action=="debug"||localStorage.myuid=="b1Atb251RGNNZktTeTRCdXp3NDFCMkpoNzR0OA=="||localStorage.myuid=="b1Atb251T1ZmS0VubEhKSXdxTi1NQ3NuV2xvZw=="||localStorage.myuid=="Z2Zhbi05V0d3MkJ4QkhhZW9VZU9LTWh5VE5TZA==")};Game9GAuth=function(game9g){this.game9g=game9g;this.useTrans=true};Game9GAuth.prototype.check=function(options){this.game9g.dispatchEvent("debug","check");var defaults={level:"id",action:null,redirect:location.href,success:null,fail:null};options=this.game9g.utils.extend(defaults,options);if(this.game9g.utils.getPath()=="/gamecenter.html"||this.game9g.utils.getPath().match(/\/[^\/]+\/game\.html/i)){this.useTrans=false};this.game9g.dispatchEvent("debug","useTrans="+this.useTrans);if(this.checkError()){this.game9g.dispatchEvent("debug","checkError");options.fail&&options.fail.apply(null);return};if(this.checkOkLoad(options,1)){this.game9g.dispatchEvent("debug","checkOkLoad");options.success&&options.success.apply(null);return};if(localStorage.token){this.compareAppToken()};if(this.game9g.utils.getParameter("auth")=="check"){if(!this.checkUrl()){options.fail&&options.fail.apply(null);return}};if(options.level=="id"&&!localStorage.accessToken){this.checkTask(options)}else if(options.level=="user"&&!localStorage.token){this.checkTask(options)}else{this.checkToken(options)}};Game9GAuth.prototype.checkToken=function(options){this.game9g.dispatchEvent("debug","checkToken");var url="http://wx.9g.com/app/check";if(options.level=="id")url+="?access_token="+localStorage.accessToken;if(options.level=="user")url+="?token="+localStorage.token;var _this=this;this.game9g.utils.ajax(url,function(data){var isOK=false;if(data&&data.success){if(options.action=="register"&&!data.token){isOK=false}else{isOK=true}};_this.game9g.dispatchEvent("debug","isOK="+isOK);if(isOK){_this.save(data);options.success&&options.success.apply(null)}else{if(_this.useTrans){var url=game9g.baseurl+"/auth/trans.app.html?logout=y&origin="+encodeURIComponent(options.redirect);_this.game9g.dispatchEvent("debug","transLogout");window.location.replace(url)}else{_this.clear();_this.checkTask(options)}}})};Game9GAuth.prototype.checkError=function(){if(sessionStorage.errcode&&sessionStorage.errmsg){this.game9g.utils.debug("errcode = "+sessionStorage.errcode+", errmsg = "+sessionStorage.errmsg);sessionStorage.removeItem("errcode");sessionStorage.removeItem("errmsg");this.clear();return true};return false};Game9GAuth.prototype.compareAppToken=function(){if(this.game9g.utils.getAppType()=="9g"||this.game9g.utils.getAppType()=="pengpeng"){var token=this.game9g.app.getToken();if(token!=null&&localStorage.token!=token){this.clear()}}};Game9GAuth.prototype.compareLocalToken=function(data){return true};Game9GAuth.prototype.save=function(data){this.game9g.dispatchEvent("debug","save");if(!data||typeof data!="object")return;if(data.accessToken)localStorage.accessToken=data.accessToken;if(data.token)localStorage.token=data.token;if(data.myuid)localStorage.myuid=data.myuid;if(data.wx9guid)localStorage.myuid=data.wx9guid;if(data.unionid)localStorage.unionid=data.unionid;if(data.realuid)localStorage.realuid=data.realuid;if(data.token){this.game9g.dispatchEvent("tokenReady",data.token)}};Game9GAuth.prototype.clear=function(){this.game9g.dispatchEvent("debug","clear");localStorage.removeItem("accessToken");localStorage.removeItem("token");localStorage.removeItem("myuid");localStorage.removeItem("unionid");localStorage.removeItem("realuid")};Game9GAuth.prototype.checkUrl=function(){var errcode=this.game9g.utils.getParameter("errcode");var errmsg=this.game9g.utils.getParameter("errmsg");var accessToken=this.game9g.utils.getParameter("access_token");var token=this.game9g.utils.getParameter("token");var myuid=this.game9g.utils.getParameter("myuid");var unionid=this.game9g.utils.getParameter("unionid");if(errcode!=null||errmsg!=null){this.game9g.utils.debug("checkUrl: errcode = "+errcode+", errmsg = "+errmsg);this.game9g.dispatchEvent("debug","checkUrlError");this.clear();return false}else{this.game9g.dispatchEvent("debug","checkUrlStore");this.save({"accessToken":accessToken,"token":token,"myuid":myuid,"unionid":unionid});return true}};Game9GAuth.prototype.checkOkSave=function(options,data){};Game9GAuth.prototype.checkOkLoad=function(options,sec){return false};Game9GAuth.prototype.checkTask=function(options){this.game9g.dispatchEvent("debug","checkTask");switch(options.level){case"id":if(this.game9g.utils.getAppType()=="wx"){if(this.game9g.isOpenSp){this.game9g.dispatchEvent("debug","A1");this.wxOpenOAuth(options.redirect,"snsapi_base")}else{this.game9g.dispatchEvent("debug","A2");this.wxGetBase(options.action,options.redirect)}}else if(this.game9g.utils.getAppType()=="9g"||this.game9g.utils.getAppType()=="pengpeng"){this.game9g.dispatchEvent("debug","A3");this.game9g.app.login(options.redirect)}else if(this.game9g.utils.getAppType()=="ggzs"){this.game9g.dispatchEvent("debug","A4");this.game9g.app.login(options)}else if(options.action=="register"){this.game9g.dispatchEvent("debug","A5");this.registerWap(options.redirect)}else{this.game9g.dispatchEvent("debug","A6");options.fail&&options.fail.apply(null)};break;case"user":if(this.game9g.utils.getAppType()=="wx"){if(this.game9g.isOpenSp){this.game9g.dispatchEvent("debug","B1");this.wxOpenOAuth(options.redirect,"snsapi_base")}else{if(!localStorage.accessToken){this.game9g.dispatchEvent("debug","B2");this.wxGetBase(options.action,options.redirect)}else{this.game9g.dispatchEvent("debug","B3");this.wxGetUser(options.redirect)}}}else if(this.game9g.utils.getAppType()=="9g"||this.game9g.utils.getAppType()=="pengpeng"){this.game9g.dispatchEvent("debug","B4");this.game9g.app.login(options.redirect)}else if(this.game9g.utils.getAppType()=="ggzs"){this.game9g.dispatchEvent("debug","B5");this.game9g.app.login(options)}else if(options.action=="register"){this.game9g.dispatchEvent("debug","B6");this.registerWap(options.redirect)}else{this.game9g.dispatchEvent("debug","B7");this.loginForm(options.redirect)};break}};Game9GAuth.prototype.getUser=function(callback){var _this=this;if(!localStorage.token){this.game9g.addEventListener("tokenReady",function(){_this.getUser(callback)},true);return};var url="http://wx.9g.com/app/getuser?token="+localStorage.token;this.game9g.utils.ajax(url,function(data){if(data.errcode){_this.game9g.user=null}else{_this.game9g.user=_this.game9g.utils.extend(_this.game9g.user,data);callback&&callback.call(null,data)}})};Game9GAuth.prototype.getUserSession=function(callback){if(!localStorage.token){callback&&callback.call(null,null)}else{var url="http://wx.9g.com/app/getusersession?token="+localStorage.token;this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data)})}};Game9GAuth.prototype.clearUserSession=function(type,callback){if(!localStorage.token){callback&&callback.call(null,null)}else{var url="http://wx.9g.com/app/clearusersession?type="+type+"&token="+localStorage.token;this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data)})}};Game9GAuth.prototype.getFromUser=function(){var id=this.game9g.fromid;var callback=null;switch(arguments.length){case 1:if(typeof arguments[0]=="string")id=arguments[0];if(typeof arguments[0]=="function")callback=arguments[0];break;case 2:id=arguments[0];callback=arguments[1];break};if(id){var _this=this;var url="http://wx.9g.com/app/getuser?id="+id;this.game9g.utils.ajax(url,function(data){var user=null;if(data.errcode){_this.game9g.utils.debug(data.errmsg)}else{user=data;_this.game9g.fromuser=user};callback&&callback.call(null,user)})}else{callback&&callback.call(null,null)}};Game9GAuth.prototype.wxGetOpenid=function(callback){if(localStorage.realuid){callback&&callback.call(null,localStorage.realuid);return};this.game9g.dispatchEvent("debug","wxGetOpenid");var trans;if(this.game9g.isOpenSp){trans=this.game9g.baseurl+"/auth/open.real.html?origin="+encodeURIComponent(location.href)+"&spid="+this.game9g.spid}else{trans=this.game9g.baseurl+"/auth/real.html?origin="+encodeURIComponent(location.href)};var url=this.game9g.getWxServer()+"/auth/check?fromurl="+encodeURIComponent(trans);window.location.replace(url)};Game9GAuth.prototype.wxGetBase=function(action,redirect){this.game9g.dispatchEvent("debug","wxGetBase");if(this.useTrans){var trans=this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(redirect)+(this.game9g.spid?"&spid="+this.game9g.spid:"")}else{var trans=this.game9g.utils.setParameter(redirect,"auth","check")};var url="http://wx.9g.com/auth/check?fromurl="+encodeURIComponent(trans)+(action?"&action="+action:"")+"&sessionid="+this.game9g.utils.getSessionId()+(this.game9g.spid?"&spid="+this.game9g.spid:"");window.location.replace(url);setTimeout(function(){window.location.replace(url)},3000)};Game9GAuth.prototype.wxGetUser=function(redirect,fail){this.game9g.dispatchEvent("debug","wxGetUser");if(this.useTrans){var success=this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(redirect)+(this.game9g.spid?"&spid="+this.game9g.spid:"")}else{var success=this.game9g.utils.setParameter(redirect,"auth","check")};fail=fail||this.game9g.baseurl;var url="http://wx.9g.com/auth/getuser?success="+encodeURIComponent(success)+"&fail="+encodeURIComponent(fail)+(this.game9g.spid?"&spid="+this.game9g.spid:"");window.location.replace(url);setTimeout(function(){window.location.replace(url)},3000)};Game9GAuth.prototype.wxOpenOAuth=function(origin,scope){this.game9g.dispatchEvent("debug","wxOpenOAuth");var redirect;switch(scope){case"snsapi_base":var fromurl=this.game9g.baseurl+"/auth/open.html?origin="+encodeURIComponent(origin)+(this.game9g.spid?"&spid="+this.game9g.spid:"");redirect=this.game9g.getWxServer()+"/auth/base?fromurl="+encodeURIComponent(fromurl)+(this.game9g.spid?"&spid="+this.game9g.spid:"");break;case"snsapi_userinfo":var success=this.game9g.baseurl+"/auth/open.html?origin="+encodeURIComponent(origin)+(this.game9g.spid?"&spid="+this.game9g.spid:"");var fail=this.game9g.baseurl;redirect=this.game9g.getWxServer()+"/auth/getuserhandler?success="+encodeURIComponent(success)+"&fail="+encodeURIComponent(fail)+(this.game9g.spid?"&spid="+this.game9g.spid:"");break};var url="https://open.weixin.qq.com/connect/oauth2/authorize"+"?appid="+this.game9g.getWxAppId()+"&redirect_uri="+encodeURIComponent(redirect)+"&response_type=code"+"&scope="+scope+"&state=123#wechat_redirect";window.location.replace(url)};Game9GAuth.prototype.wxOpenLogin=function(data,callback){this.game9g.dispatchEvent("debug","wxOpenLogin");var url="http://wx.9g.com/open/loginwx?access_token="+data.accessToken+"&spid="+data.spid;var _this=this;this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9GAuth.prototype.registerWap=function(redirect){this.game9g.dispatchEvent("debug","registerWap");var _this=this;redirect=redirect||this.game9g.baseurl;var url="http://wx.9g.com/app/register?sessionid="+this.game9g.utils.getSessionId()+(this.game9g.spid?"&spid="+this.game9g.spid:"");this.game9g.utils.ajax(url,function(data){if(_this.useTrans){redirect=_this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(redirect)+(_this.game9g.spid?"&spid="+_this.game9g.spid:"")+(data.token?"&token="+data.token:"")+(data.accessToken?"&access_token="+data.accessToken:"")+(data.wx9guid?"&myuid="+data.wx9guid:"")}else{redirect=_this.game9g.utils.setParameter(redirect,"auth","check");if(data.token)redirect=_this.game9g.utils.setParameter(redirect,"token",data.token);if(data.accessToken)redirect=_this.game9g.utils.setParameter(redirect,"access_token",data.accessToken);if(data.wx9guid)redirect=_this.game9g.utils.setParameter(redirect,"myuid",data.wx9guid)};window.location.replace(redirect)})};Game9GAuth.prototype.loginForm=function(redirect){this.game9g.dispatchEvent("debug","loginForm");var url=this.game9g.baseurl+"/app/login.html?backurl="+encodeURIComponent(redirect);window.location=url};Game9GAuth.prototype.logout=function(redirect){this.game9g.dispatchEvent("debug","logout");var url=this.game9g.baseurl+"/app/logout.html?fromurl="+encodeURIComponent(redirect);window.location=url};Game9GAuth.prototype.saveLink=function(callback){var id=this.game9g.fromid;if(id&&localStorage.accessToken&&id!=localStorage.myuid){var url="http://wx.9g.com/auth/link?access_token="+localStorage.accessToken+"&id="+id;var _this=this;this.game9g.utils.ajax(url,function(data){var result=0;if(data.error){_this.game9g.utils.debug(data);result=-1}else{result=data.linkResult};callback&&callback.call(null,result)})}else{callback&&callback.call(null,-1)}};Game9GUI=function(game9g){this.game9g=game9g;this.start=null;this.menu=null;this.ball=null;this.orientation=null;this.initOrientationEvent()};Game9GUI.prototype.initOrientationEvent=function(){var _this=this;var supportOrientation=(typeof window.orientation==="number"&&typeof window.onorientationchange==="object");var updateOrientation=function(){if(supportOrientation){_this.orientation=(window.orientation==90||window.orientation==-90)?"landscape":"portrait"}else{_this.orientation=(window.innerWidth>window.innerHeight)?"landscape":"portrait"};_this.game9g.dispatchEvent("orientationChange",_this.orientation)};updateOrientation();if(supportOrientation){window.addEventListener("orientationchange",updateOrientation,false)}else{window.addEventListener("resize",updateOrientation,false)}};Game9GUI.prototype.showStart=function(){if(!this.start)this.start=new Game9GUIStart(this.game9g);if(!this.menu)this.menu=new Game9GUIMenu(this.game9g)};Game9GUI.prototype.showBall=function(){if(!this.ball)this.ball=new Game9GUIBall(this.game9g)};Game9GUIStart=function(game9g){this.game9g=game9g;var div=document.createElement("div");div.id="game9g9gstart";div.className="game9g9gstart";var _this=this;var onclick=function(e){_this.hide();_this.game9g.ui.menu.show();e.preventDefault()};div.addEventListener("touchstart",onclick);div.addEventListener("mousedown",onclick);document.getElementsByTagName("body")[0].appendChild(div);var badge=document.createElement("div");badge.className="game9g9gstartbadge";badge.style.display="none";div.appendChild(badge);this.game9g.addEventListener("newMessage",function(data){if(data>0){badge.innerHTML=data;badge.style.display=""}else{badge.innerHTML="";badge.style.display="none"}})};Game9GUIStart.prototype.flyIn=function(callback){var div=document.getElementById("game9g9gstart");var _this=this;this.game9g.ui.onAnimationEnd(div,function(){div.className="game9g9gstart pulse";callback&&callback.call(null)},true);div.className="game9g9gstart bounceInLeft"};Game9GUIStart.prototype.show=function(){var div=document.getElementById("game9g9gstart");if(div)div.style.left=this.game9g.utils.vw2pxs(4)};Game9GUIStart.prototype.hide=function(){var div=document.getElementById("game9g9gstart");if(div)div.style.left=this.game9g.utils.vw2pxs(-20)};Game9GUIMenu=function(game9g){this.game9g=game9g;this.visible=false;this.init()};Game9GUIMenu.prototype.init=function(){var div=document.createElement("div");div.id="game9gmenu";div.className="game9gmenu";document.getElementsByTagName("body")[0].appendChild(div);var my=document.createElement("div");my.className="game9gmenumy";div.appendChild(my);var head=document.createElement("img");head.src="http://game.9g.com/default.png";my.appendChild(head);var nickname=document.createElement("div");my.appendChild(nickname);var _this=this;this.game9g.addEventListener("userReady",function(){head.src=_this.game9g.utils.getHead132(_this.game9g.user.headimgurl);nickname.innerHTML=_this.game9g.user.nickname});var ul=document.createElement("ul");var badgeMessage;for(var i=1;i<=6;i++){var li=document.createElement("li");var img=document.createElement("img");var a=document.createElement("a");var link=this.game9g.baseurl;switch(i){case 1:a.innerHTML="个人中心";img.src="http://game.9g.com/img/menu/icon_04.png";link=this.game9g.baseurl+"/app/my.html?r="+Math.random();break;case 2:a.innerHTML="新消息";img.src="http://game.9g.com/img/menu/icon_06.png";link=this.game9g.baseurl+"/app/message.html?r="+Math.random();badgeMessage=document.createElement("div");badgeMessage.style.display="none";li.appendChild(badgeMessage);break;case 3:a.innerHTML="游戏大厅";img.src="http://game.9g.com/img/menu/icon_01.png";link=this.game9g.baseurl+"/app/games.html?r="+Math.random();break;case 4:a.innerHTML="在线玩家";img.src="http://game.9g.com/img/menu/icon_05.png";link=this.game9g.baseurl+"/app/online.html?r="+Math.random();break;case 5:a.innerHTML="随机一起玩";img.src="http://game.9g.com/img/menu/icon_02.png";link=this.game9g.baseurl+"/gamecenter.html?gameid=pk&r="+Math.random();break;case 6:a.innerHTML="今日比赛";img.src="http://game.9g.com/img/menu/icon_03.png";link=this.game9g.baseurl+"/app/event.html?r="+Math.random();break};li.appendChild(img);li.appendChild(a);(function(link){var onClickItem=function(e){window.location=link;e.preventDefault()};li.addEventListener("touchstart",onClickItem);li.addEventListener("mousedown",onClickItem)})(link);ul.appendChild(li)};div.appendChild(ul);this.game9g.addEventListener("newMessage",function(data){if(data>0){badgeMessage.innerHTML=data;badgeMessage.style.display=""}else{badgeMessage.innerHTML="";badgeMessage.style.display="none"}});var gz=document.createElement("img");gz.src="http://game.9g.com/img/gz_banner.png";gz.className="game9ggzbanner";div.appendChild(gz);var ongz=function(e){window.location=_this.game9g.baseurl+"/gz_9g.html?r="+Math.random();e.preventDefault()};gz.addEventListener("touchstart",ongz);gz.addEventListener("mousedown",ongz);this.game9g.addEventListener("userReady",function(){if(_this.game9g.user.subscribe)gz.style.display="none"})};Game9GUIMenu.prototype.getNotice=function(){if(localStorage.token){var url="http://wx.9g.com/credit/getcreditsum?status=0&token="+localStorage.token;this.game9g.utils.ajax(url,function(data){if(data&&data.sum>0){var div=document.createElement("div");div.className="notice";div.innerHTML="+"+data.sum;document.getElementById("game9gmenu_credit").appendChild(div)}})}};Game9GUIMenu.prototype.show=function(){var div=document.getElementById("game9gmenu");div.className="game9gmenu showmenu";var mask=document.createElement("div");mask.id="game9gmenumask";mask.className="game9gmenumask";document.getElementsByTagName("body")[0].appendChild(mask);var _this=this;var onclick=function(e){_this.hide();_this.game9g.ui.start.show();e.preventDefault()};mask.addEventListener("touchstart",onclick);mask.addEventListener("mousedown",onclick);this.visible=true};Game9GUIMenu.prototype.hide=function(){var div=document.getElementById("game9gmenu");div.className="game9gmenu";var mask=document.getElementById("game9gmenumask");if(mask)document.getElementsByTagName("body")[0].removeChild(mask);this.visible=false};Game9GUIBall=function(game9g){this.game9g=game9g;this.dom={};this.ready=false;this.isPress=false;this.isMove=false;this.startMove=0;this.menu=null;this.init();this.initEvent()};Game9GUIBall.prototype.init=function(){var ball=document.createElement("div");ball.className="game9gball"+(window.innerWidth>window.innerHeight?" pc":"");document.getElementsByTagName("body")[0].appendChild(this.dom.ball=ball);var logo=document.createElement("img");logo.className="game9gballlogo";ball.appendChild(this.dom.logo=logo);this.toggle("on");if(this.game9g.isSite){this.checkKa();this.checkKf()}};Game9GUIBall.prototype.initEvent=function(){var _this=this;this.game9g.onLoadingComplete(function(){setTimeout(function(){_this.game9g.ui.onTransitionEnd(_this.dom.ball,function(){_this.ready=true;_this.game9g.dispatchEvent("ballReady")},true);_this.game9g.ui.addClass(_this.dom.ball,"game9gballshow")},1000)});this.game9g.addEventListener("orientationChange",function(){if(_this.dom.ball){window.innerWidth>window.innerHeight?_this.game9g.ui.addClass(_this.dom.ball,"pc"):_this.game9g.ui.removeClass(_this.dom.ball,"pc")}});this.game9g.ui.on("touchstart mousedown",this.dom.ball,function(e){_this.onTouchStart(e)});this.game9g.ui.on("touchmove mousemove",this.dom.ball,function(e){_this.onTouchMove(e)});this.game9g.ui.on("touchend mouseup",this.dom.ball,function(e){_this.onTouchEnd(e)});this.game9g.addEventListener("siteShow",function(){_this.dom.ball.style.opacity=0;_this.hideKa()});this.game9g.addEventListener("siteHide",function(){_this.dom.ball.style.opacity=1});this.game9g.addEventListener("newMessage",function(unread){if(unread>0){_this.onReady(function(){_this.showBadge(unread)})}else{_this.clearBadge()}})};Game9GUIBall.prototype.onReady=function(callback){if(this.ready){callback&&callback.call(null)}else{this.game9g.addEventListener("ballReady",callback)}};Game9GUIBall.prototype.toggle=function(flag){this.dom.logo.src="http://game.9g.com/img/game_menu_"+(this.game9g.isHenKuai?"henkuai_":"")+flag+".png"};Game9GUIBall.prototype.onTouchStart=function(){this.isPress=true;this.startMove=new Date().getTime()};Game9GUIBall.prototype.onTouchMove=function(e){if(!this.isPress)return;var now=new Date().getTime();if(now-this.startMove<50)return;this.isMove=true;var pageX=e.touches?e.touches[0].pageX:(e.pageX||e.clientX);var pageY=e.touches?e.touches[0].pageY:(e.pageY||e.clientY);var left=pageX-this.dom.ball.offsetWidth/2;var top=pageY-this.dom.ball.offsetHeight/2;var maxLeft=window.innerWidth-this.dom.ball.offsetWidth;var maxTop=window.innerHeight-this.dom.ball.offsetHeight;if(left<0)left=0;if(left>maxLeft)left=maxLeft;if(top<0)top=0;if(top>maxTop)top=maxTop;this.dom.ball.style.left=left+"px";this.dom.ball.style.top=top+"px";if(this.menu&&this.menu.visible)this.menu.locate();e&&e.preventDefault()};Game9GUIBall.prototype.onTouchEnd=function(){if(!this.isMove)this.onTap();this.isMove=false;this.isPress=false};Game9GUIBall.prototype.onTap=function(){if(this.game9g.isSite){this.dom.tip?this.clearTip():this.game9g.showSite();return};if(!this.menu)this.menu=new Game9gUIBallMenu(this.game9g);this.menu.visible?this.menu.hide():this.menu.show()};Game9GUIBall.prototype.checkKa=function(){var _this=this;var url="http://app.9g.com/ka/haspackage?gameid="+this.game9g.gameid;this.game9g.utils.ajax(url,function(data){if(data.count>0){_this.onReady(function(){_this.showKa()})}})};Game9GUIBall.prototype.showKa=function(){if(!this.dom.ka){var ka=document.createElement("div");ka.className="game9gballka";var text=document.createElement("span");text.innerHTML="礼包";ka.appendChild(text);this.dom.ball.appendChild(this.dom.ka=ka);this.dom.ka.scrollWidth};this.dom.ka.className="game9gballka game9gballkashow"};Game9GUIBall.prototype.hideKa=function(){if(this.dom.ka)this.dom.ka.className="game9gballka"};Game9GUIBall.prototype.checkKf=function(){var url="http://pp.9g.com/kf/gamekf?gameid="+this.game9g.gameid+"&token="+localStorage.token;this.game9g.utils.ajax(url,function(data){if(data.error)return console.log(data.error);})};Game9GUIBall.prototype.showBadge=function(value){if(!this.dom.badge){var badge=document.createElement("div");badge.className="game9gballbadge";this.dom.ball.appendChild(this.dom.badge=badge)};if(value){this.dom.badge.className="game9gballbadge game9gballbadgetext game9gpopin";this.dom.badge.innerHTML=value}else{this.dom.badge.className="game9gballbadge game9gpopin";this.dom.badge.innerHTML=""}};Game9GUIBall.prototype.clearBadge=function(){var _this=this;if(this.dom.badge){this.dom.badge.className=this.dom.badge.className.replace("game9gpopin","game9gpopout");setTimeout(function(){_this.dom.badge.className="game9gballbadgeclear";_this.dom.badge.innerHTML=""},200)}};Game9GUIBall.prototype.showTip=function(content){if(!this.dom.tip){var tip=document.createElement("div");tip.className="game9gballtip game9gpopin";this.dom.ball.appendChild(this.dom.tip=tip)};this.dom.tip.innerHTML=content};Game9GUIBall.prototype.clearTip=function(){if(this.dom.tip){var _this=this;this.game9g.ui.onAnimationEnd(this.dom.tip,function(){_this.dom.tip.parentElement.removeChild(_this.dom.tip);_this.dom.tip=null},true);this.game9g.ui.addClass(this.dom.tip,"game9gpopout")}};Game9gUIBallMenu=function(game9g){this.game9g=game9g;this.visible=false;this.init();this.loadItems()};Game9gUIBallMenu.prototype.init=function(){var mask=document.createElement("div");mask.id="game9gballmenumask";mask.className="game9gballmenumask";mask.style.display="none";var _this=this;mask.addEventListener("touchstart",function(e){_this.hide();e.preventDefault()});mask.addEventListener("mousedown",function(e){_this.hide();e.preventDefault()});document.getElementsByTagName("body")[0].appendChild(mask);var div=document.createElement("div");div.id="game9gballmenu";div.className="game9gballmenu"+(window.innerWidth>window.innerHeight?" pc":"");div.style.display="none";document.getElementsByTagName("body")[0].appendChild(div);this.game9g.addEventListener("orientationChange",function(){if(div)div.className="game9gballmenu"+(window.innerWidth>window.innerHeight?" pc":"")});var bg=document.createElement("div");bg.className="game9gballmenubg";div.appendChild(bg);var ul=document.createElement("ul");ul.id="game9gballmenulist";div.appendChild(ul)};Game9gUIBallMenu.prototype.loadItems=function(){var _this=this;this.addItems([{icon:"http://game.9g.com/img/game_menu_add.png",text:"关注",click:function(){_this.game9g.ui.showSubscribe()}},{icon:"http://game.9g.com/img/game_menu_exit.png",text:"退出",click:function(){window.location=_this.game9g.getGameServer()}}])};Game9gUIBallMenu.prototype.addItems=function(list){for(var i=0;i<list.length;i++){this.addItem(list[i])}};Game9gUIBallMenu.prototype.addItem=function(data){var ul=document.getElementById("game9gballmenulist");if(!ul)return;var li=document.createElement("li");ul.appendChild(li);var img=document.createElement("img");img.src=data.icon;li.appendChild(img);var span=document.createElement("span");span.innerHTML=data.text;li.appendChild(span);var _this=this;li.addEventListener("touchstart",function(e){_this.onClickItem(e,data.click)});li.addEventListener("mousedown",function(e){_this.onClickItem(e,data.click)})};Game9gUIBallMenu.prototype.clear=function(){var ul=document.getElementById("game9gballmenulist");if(ul)ul.innerHTML=""};Game9gUIBallMenu.prototype.onClickItem=function(e,callback){this.hide();callback&&callback.call(null);e&&e.preventDefault()};Game9gUIBallMenu.prototype.show=function(){this.game9g.ui.ball.toggle("off");var mask=document.getElementById("game9gballmenumask");mask.style.display="";var div=document.getElementById("game9gballmenu");div.style.display="";this.locate();this.visible=true};Game9gUIBallMenu.prototype.locate=function(){var div=document.getElementById("game9gballmenu");var padding=this.game9g.utils.vw2px(3);var ball=this.game9g.ui.ball.dom.ball;var left=ball.offsetLeft;var top=ball.offsetTop+ball.offsetHeight+padding;var maxLeft=window.innerWidth-div.offsetWidth-padding;var maxTop=window.innerHeight-div.offsetHeight-padding;if(left<padding)left=padding;if(left>maxLeft)left=maxLeft;if(top<padding)top=padding;if(top>maxTop)top=maxTop;if(top<ball.offsetTop+ball.offsetHeight){top=ball.offsetTop-div.offsetHeight-padding;};div.style.left=left+"px";div.style.top=top+"px"};Game9gUIBallMenu.prototype.hide=function(){this.game9g.ui.ball.toggle("on");document.getElementById("game9gballmenu").style.display="none";document.getElementById("game9gballmenumask").style.display="none";this.visible=false};Game9GUI.prototype.on=function(types,dom,callback){if(!this.game9g.utils.isArray(dom))dom=[dom];for(var i=0;i<dom.length;i++){(function(d){var fn=function(e){callback&&callback.call(d,e);e.preventDefault()};var a=types.split(" ");for(var i=0;i<a.length;i++){d.addEventListener(a[i],fn)}})(dom[i])}};Game9GUI.prototype.onTap=function(dom,callback){if(!this.game9g.utils.isArray(dom))dom=[dom];for(var i=0;i<dom.length;i++){(function(d){var fn=function(e){callback&&callback.call(d,e);e.preventDefault()};d.addEventListener("touchstart",fn);d.addEventListener("mousedown",fn)})(dom[i])}};Game9GUI.prototype.onClick=function(dom,callback){if(!this.game9g.utils.isArray(dom))dom=[dom];for(var i=0;i<dom.length;i++){(function(d){d.addEventListener("click",function(e){callback&&callback.call(d,e);e.preventDefault()})})(dom[i])}};Game9GUI.prototype.onAnimationEnd=function(dom,callback,once){var finish=function(e){if(once){dom.removeEventListener("animationend",finish);dom.removeEventListener("webkitAnimationEnd",finish)};callback&&callback.call(null,e)};dom.addEventListener("animationend",finish);dom.addEventListener("webkitAnimationEnd",finish)};Game9GUI.prototype.onTransitionEnd=function(dom,callback,once){var finish=function(e){if(once){dom.removeEventListener("transitionend",finish);dom.removeEventListener("webkitTransitionEnd",finish)};callback&&callback.call(null,e)};dom.addEventListener("transitionend",finish);dom.addEventListener("webkitTransitionEnd",finish)};Game9GUI.prototype.addClass=function(dom,cls){var a=dom.className.split(" ");for(var i=0;i<a.length;i++){if(a[i]==cls)return};a.push(cls);dom.className=a.join(" ")};Game9GUI.prototype.removeClass=function(dom,cls){var change=false;var a=dom.className.split(" ");for(var i=0;i<a.length;i++){if(a[i]==cls){a.splice(i,1);change=true;break}};if(change)dom.className=a.join(" ")};Game9GUI.prototype.showMask=function(){var id=null;var callback=null;if(typeof arguments[0]=="string")id=arguments[0];if(typeof arguments[0]=="function")callback=arguments[0];if(typeof arguments[1]=="function")callback=arguments[1];var div=document.createElement("div");div.id="game9gmask"+(id?"_"+id:"");div.className="game9gmask";document.getElementsByTagName("body")[0].appendChild(div);this.onTap(div,function(){callback&&callback.call(null)})};Game9GUI.prototype.hideMask=function(id){id="game9gmask"+(id?"_"+id:"");var div=document.getElementById(id);if(div)div.parentElement.removeChild(div)};Game9GUI.prototype.showSubscribe=function(options){var defaults={title:"长按二维码识别或微信扫一扫",qrcode:this.game9g.isKuaiWan?"http://game.9g.com/img/qrcode_kuaiwan.jpg":"http://game.9g.com/img/qrcode.jpg"};options=this.game9g.utils.extend(defaults,options);this.hideSubscribe();this.showMask();var _this=this;var div=document.createElement("div");div.id="game9gsubscribe";div.className="game9gsubscribe";document.getElementsByTagName("body")[0].appendChild(div);var header=document.createElement("div");header.className="game9gsubscribeheader";header.innerHTML=options.title;div.appendChild(header);var cancel=document.createElement("img");cancel.src="http://game.9g.com/img/close.png";header.appendChild(cancel);var qrmain=document.createElement("div");qrmain.className="game9gsubscribeqrmain";div.appendChild(qrmain);var qrcode=document.createElement("img");qrcode.className="game9gsubscribeqrcode";qrcode.src=options.qrcode;qrmain.appendChild(qrcode);var close=function(e){_this.hideSubscribe();e.preventDefault()};cancel.addEventListener("touchstart",close);cancel.addEventListener("mousedown",close)};Game9GUI.prototype.hideSubscribe=function(){var div=document.getElementById("game9gsubscribe");if(div)div.parentElement.removeChild(div);this.hideMask()};Game9GUI.prototype.showChooseGame=function(list,callback){this.hideChooseGame();this.showMask();var wrap=document.createElement("div");wrap.id="game9gchoosegame";wrap.className="game9gchoosegame";document.getElementsByTagName("body")[0].appendChild(wrap);var p=document.createElement("p");p.innerHTML="选择一款游戏开始吧";wrap.appendChild(p);var ul=document.createElement("ul");wrap.appendChild(ul);this.renderChooseGame(ul,list,callback);var _this=this;var div=document.createElement("div");wrap.appendChild(div);var btn1=document.createElement("a");btn1.innerHTML="换一批";btn1.addEventListener("touchstart",function(e){_this.game9g.utils.ajax("http://pp.9g.com/im/gethotgames?refresh=1",function(data){_this.renderChooseGame(ul,data,callback)});e.preventDefault()});div.appendChild(btn1);var btn2=document.createElement("a");btn2.innerHTML="取消";btn2.addEventListener("touchstart",function(e){_this.hideChooseGame();e.preventDefault()});div.appendChild(btn2)};Game9GUI.prototype.renderChooseGame=function(ul,list,callback){ul.innerHTML="";var _this=this;for(var i=0;i<list.length;i++){(function(game){var li=document.createElement("li");ul.appendChild(li);var img=document.createElement("img");img.src=game.gameicon;li.appendChild(img);var span=document.createElement("span");span.innerHTML=game.gamename;li.appendChild(span);li.addEventListener("touchstart",function(e){_this.hideChooseGame();e.preventDefault();callback&&callback.call(null,game)})})(list[i])}};Game9GUI.prototype.hideChooseGame=function(){var wrap=document.getElementById("game9gchoosegame");if(wrap)wrap.parentElement.removeChild(wrap);this.hideMask()};Game9GUI.prototype.showBindPhone=function(options){this.hideBindPhone();this.showMask();var _this=this;var isPC=window.innerWidth>window.innerHeight;var wrap=document.createElement("div");wrap.id="game9gbindphone";wrap.className="game9gbindphone"+(isPC?" pc":"");document.getElementsByTagName("body")[0].appendChild(wrap);var box=document.createElement("div");box.className="game9gbindphonebox";wrap.appendChild(box);var close=document.createElement("img");close.className="game9gbindphoneclose";close.src="http://game.9g.com/img/panel_close.png";wrap.appendChild(close);switch(options.step){case"form":var txtPhone=document.createElement("input");txtPhone.className="game9gbindphonetext";txtPhone.placeholder="输入手机号";txtPhone.value=options.phone||"";box.appendChild(txtPhone);var txtPassword=document.createElement("input");txtPassword.type="password";txtPassword.className="game9gbindphonetext";txtPassword.placeholder=options.action=="resetPassword"?"设置要重设的密码":"输入密码";box.appendChild(txtPassword);if(options.action=="login"){var lnkReset=document.createElement("a");lnkReset.className="game9gbindphonelink";lnkReset.innerHTML="忘记密码？点击这里重设";lnkReset.href="javascript:void(0)";lnkReset.addEventListener("click",function(){if(txtPhone.value)options.phone=txtPhone.value;options.action="resetPassword";_this.showBindPhone(options)});box.appendChild(lnkReset)};var btnBind=document.createElement("div");btnBind.className="game9gbindphonebtn";switch(options.action){case"bindPhone":btnBind.innerHTML="一键绑定";break;case"resetPassword":btnBind.innerHTML="重设密码";break;default:btnBind.innerHTML="登录/一键注册";break};box.appendChild(btnBind);txtPhone.addEventListener("keydown",function(e){if(e.keyCode==13)btnBind.click()});txtPassword.addEventListener("keydown",function(e){if(e.keyCode==13)btnBind.click()});btnBind.addEventListener("click",function(){options.phone=txtPhone.value;options.password=txtPassword.value;if(!options.phone){alert("请输入手机号");return txtPhone.focus()};if(!options.password){alert("请输入密码");return txtPassword.focus()};switch(options.action){case"bindPhone":_this.game9g.bindPhoneCheck(options.phone,options.password,function(){options.step="verify";_this.showBindPhone(options)});break;case"resetPassword":_this.game9g.resetPasswordCheck(options.phone,options.password,function(isExist){if(isExist){options.step="verify";_this.showBindPhone(options)}else{options.action="register";options.step="verify";_this.showBindPhone(options)}});break;default:_this.game9g.loginRegister(options.phone,options.password,function(action,data){options.action=action;if(action=="login"){data.phone=options.phone;options.success&&options.success.call(null,data);var url=_this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(options.redirect)+(data.accessToken?"&access_token="+data.accessToken:"")+(data.token?"&token="+data.token:"")+(data.wx9guid?"&myuid="+data.wx9guid:"")+(_this.game9g.spid?"&spid="+_this.game9g.spid:"");window.location.replace(url)}else{options.step="verify";_this.showBindPhone(options)}});break}});close.addEventListener("click",function(){_this.hideBindPhone();options.cancel&&options.cancel.call(null)});break;case"verify":var p=document.createElement("p");p.innerHTML=(options.action=="register"?"注册成功！":"请输入验证码。")+"<br/>验证码已经发送到 "+options.phone;box.appendChild(p);var div=document.createElement("div");div.className="game9gbindphonemain";box.appendChild(div);var txtCode=document.createElement("input");txtCode.className="game9gbindphonecode";txtCode.placeholder="输入验证码";div.appendChild(txtCode);var btnResend=document.createElement("div");btnResend.className="game9gbindphoneresend";btnResend.innerHTML="重新发送";div.appendChild(btnResend);var footer=document.createElement("div");footer.className="game9gbindphonefooter";box.appendChild(footer);var btnActive=document.createElement("div");btnActive.className="game9gbindphoneactive";btnActive.innerHTML=options.action=="register"?"激活":"完成";footer.appendChild(btnActive);btnActive.addEventListener("click",function(){var success=function(data){_this.hideBindPhone();options.success&&options.success.call(null,data)};switch(options.action){case"bindPhone":_this.game9g.bindPhoneVerify(options.phone,options.password,txtCode.value,success);break;case"register":_this.game9g.registerVerify(options.phone,options.password,txtCode.value,function(data){success(data);var url=_this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(options.redirect)+(data.accessToken?"&access_token="+data.accessToken:"")+(data.token?"&token="+data.token:"")+(data.wx9guid?"&myuid="+data.wx9guid:"")+(_this.game9g.spid?"&spid="+_this.game9g.spid:"");window.location.replace(url)});break;case"resetPassword":_this.game9g.resetPasswordVerify(options.phone,options.password,txtCode.value,function(){alert("密码重置成功！您现在可以用新的密码登录了。");options.action="login";options.step="form";_this.showBindPhone(options)});break}});var btnCancel=document.createElement("div");btnCancel.className="game9gbindphonecancel";btnCancel.innerHTML="取消";footer.appendChild(btnCancel);var sendCode=function(content){_this.sendCodeFreeze=true;_this.game9g.sendVcode(options.phone,content,function(data){if(data.error){if(data.error=="error captcha"){_this.showCaptcha(box,false,function(content){sendCode(content)})}else{alert("发送验证码失败")};_this.sendCodeFreeze=false}else{if(data.code==0){_this.game9g.utils.countDown({name:"bindPhoneTimer",time:60,onTimer:function(time){btnResend.innerHTML=time+"秒"},onTimeout:function(){btnResend.innerHTML="重新发送";_this.sendCodeFreeze=false}})}else{alert("发送验证码失败");_this.sendCodeFreeze=false}}})};this.showCaptcha(box,false,function(content){sendCode(content)});btnResend.addEventListener("click",function(){if(_this.sendCodeFreeze)return;_this.showCaptcha(box,false,function(content){sendCode(content)})});btnCancel.addEventListener("click",function(){_this.game9g.utils.cancelCountDown("bindPhoneTimer");options.step="form";_this.showBindPhone(options)});close.addEventListener("click",function(){_this.game9g.utils.cancelCountDown("bindPhoneTimer");_this.hideBindPhone();options.cancel&&options.cancel.call(null)});break;case"result":var tip=document.createElement("div");tip.className="game9gbindphonetip";tip.innerHTML="您已绑定了手机";box.appendChild(tip);var num=document.createElement("div");num.className="game9gbindphonenum";num.innerHTML=this.game9g.user.phone;box.appendChild(num);var btn=document.createElement("div");btn.className="game9gbindphonebtn";btn.innerHTML="确定";box.appendChild(btn);var success=function(){_this.hideBindPhone();var data={token:localStorage.token,phone:_this.game9g.user.phone};options.success&&options.success.call(null,data)};btn.addEventListener("click",success);close.addEventListener("click",success);break}};Game9GUI.prototype.hideBindPhone=function(){var wrap=document.getElementById("game9gbindphone");if(wrap)wrap.parentElement.removeChild(wrap);this.hideMask()};Game9GUI.prototype.showCaptcha=function(box,check,callback){var _this=this;var captchaBox=document.createElement("div");captchaBox.id="game9gcaptchabox";captchaBox.className="game9gcaptchabox";box.appendChild(captchaBox);var title=document.createElement("span");title.className="game9gcaptchatitle";title.innerHTML="请输入验证码：";captchaBox.appendChild(title);var a=document.createElement("a");a.className="game9gcaptchalink";a.innerHTML="刷新验证码";a.href="javascript:void(0)";captchaBox.appendChild(a);var img=document.createElement("img");img.className="game9gcaptchaimg";captchaBox.appendChild(img);var txt=document.createElement("input");txt.className="game9gcaptchacode";txt.placeholder="验证码";captchaBox.appendChild(txt);var btn=document.createElement("span");btn.className="game9gcaptchabtn";btn.innerHTML="确定";captchaBox.appendChild(btn);_this.game9g.getCaptchaCode(img);a.addEventListener("click",function(){_this.game9g.getCaptchaCode(img)});btn.addEventListener("click",function(){var content=txt.value;if(content=="")return;if(check){_this.game9g.checkCaptchaCode(content,function(data){if(data.result==1){_this.hideCaptcha();callback&&callback.call(null,data)}else{alert("验证码错误");txt.value="";_this.game9g.getCaptchaCode(img)}})}else{_this.hideCaptcha();callback&&callback.call(null,content)}})};Game9GUI.prototype.hideCaptcha=function(){var captchaBox=document.getElementById("game9gcaptchabox");if(captchaBox)captchaBox.parentElement.removeChild(captchaBox)};Game9GUI.prototype.showLoginUser=function(options){this.hideLoginUser();this.showMask();var _this=this;var isPC=window.innerWidth>window.innerHeight;var wrap=document.createElement("div");wrap.id="game9gloginuser";wrap.className="game9gbindphone"+(isPC?" pc":"");document.getElementsByTagName("body")[0].appendChild(wrap);var box=document.createElement("div");box.className="game9gbindphonebox";wrap.appendChild(box);var close=document.createElement("img");close.className="game9gbindphoneclose";close.src="http://game.9g.com/img/panel_close.png";wrap.appendChild(close);switch(options.step){case"form":var txtUsername=document.createElement("input");txtUsername.className="game9gbindphonetext";txtUsername.placeholder="输入9G帐号";txtUsername.value=options.username||"";box.appendChild(txtUsername);var txtPassword=document.createElement("input");txtPassword.type="password";txtPassword.className="game9gbindphonetext";txtPassword.placeholder=options.action=="login"?"输入密码":"设置密码";box.appendChild(txtPassword);if(options.action=="login"){var lnkReg=document.createElement("a");lnkReg.className="game9gbindphonelink";lnkReg.innerHTML="没有 9G 帐号？点击这里立即注册。";lnkReg.href="javascript:void(0)";lnkReg.addEventListener("click",function(){options.action="register";_this.showLoginUser(options)});box.appendChild(lnkReg)};var btnLogin=document.createElement("div");btnLogin.className="game9gbindphonebtn";btnLogin.innerHTML=options.action=="login"?"一键登录":"注册新用户";box.appendChild(btnLogin);txtUsername.addEventListener("keydown",function(e){if(e.keyCode==13)btnLogin.click()});txtPassword.addEventListener("keydown",function(e){if(e.keyCode==13)btnLogin.click()});btnLogin.addEventListener("click",function(){options.username=txtUsername.value;options.password=txtPassword.value;switch(options.action){case"login":if(!options.username){alert("请输入帐号");return txtUsername.focus()};if(!options.password){alert("请输入密码");return txtPassword.focus()};_this.game9g.loginUsernamePassword(options.username,options.password,function(data){var url=_this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(options.redirect)+(data.accessToken?"&access_token="+data.accessToken:"")+(data.token?"&token="+data.token:"")+(data.wx9guid?"&myuid="+data.wx9guid:"")+(_this.game9g.spid?"&spid="+_this.game9g.spid:"");window.location.replace(url)});break;case"register":if(!_this.game9g.checkUsernamePassword(options.username,options.password))return;_this.showCaptcha(box,true,function(data){_this.game9g.registerUsernamePassword(options.username,options.password,function(data){options.step="result";_this.showLoginUser(options)})});break}});close.addEventListener("click",function(){_this.hideLoginUser();options.cancel&&options.cancel.call(null)});break;case"result":var tip=document.createElement("div");tip.className="game9gbindphonetip";tip.innerHTML="恭喜您注册成功！<br/>请记住您的用户名和密码。";box.appendChild(tip);var txt=document.createElement("div");txt.className="game9gbindphonenum";txt.innerHTML=options.username;box.appendChild(txt);var btn=document.createElement("div");btn.className="game9gbindphonebtn";btn.innerHTML="立即登录";box.appendChild(btn);btn.addEventListener("click",function(){_this.hideLoginUser();_this.game9g.loginUsernamePassword(options.username,options.password,function(data){var url=_this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(options.redirect)+(data.accessToken?"&access_token="+data.accessToken:"")+(data.token?"&token="+data.token:"")+(data.wx9guid?"&myuid="+data.wx9guid:"")+(_this.game9g.spid?"&spid="+_this.game9g.spid:"");window.location.replace(url)})});break}};Game9GUI.prototype.hideLoginUser=function(){var wrap=document.getElementById("game9gloginuser");if(wrap)wrap.parentElement.removeChild(wrap);this.hideMask()};Game9GUI.prototype.showFullScreenImage=function(url){var wrap=document.createElement("div");wrap.className="game9gfullscreen";document.getElementsByTagName("body")[0].appendChild(wrap);var img=document.createElement("img");img.className="game9gfullscreenimage";img.src=url;wrap.appendChild(img);wrap.addEventListener("click",function(e){wrap.parentElement.removeChild(wrap);e.preventDefault()})};Game9GUI.prototype.showGameBack=function(){if(document.getElementById("game9gback"))return;var wrap=document.createElement("div");wrap.id="game9gback";wrap.className="game9gback";document.getElementsByTagName("body")[0].appendChild(wrap);var close=document.createElement("img");close.className="game9gbackclose";close.src="http://game.9g.com/img/close.png";wrap.appendChild(close);var title=document.createElement("div");title.className="game9gbacktitle";title.innerHTML="这些游戏更好玩！";wrap.appendChild(title);var ul=document.createElement("ul");wrap.appendChild(ul);var actionbar=document.createElement("div");actionbar.className="game9gbackactionbar";wrap.appendChild(actionbar);var subscribe=document.createElement("a");subscribe.className="game9gbacksubscribe";subscribe.innerHTML="收藏游戏";actionbar.appendChild(subscribe);var leave=document.createElement("a");leave.className="game9gbackleave";leave.innerHTML="离开游戏";actionbar.appendChild(leave);var footer=document.createElement("div");footer.className="game9gbackfooter";wrap.appendChild(footer);var notip=document.createElement("input");notip.id="game9gbacknotip";notip.type="checkbox";footer.appendChild(notip);var label=document.createElement("label");label.innerHTML="今日不再提示";label.setAttribute("for","game9gbacknotip");footer.appendChild(label);var _this=this;var fnClose=function(){if(wrap)wrap.parentElement.removeChild(wrap);_this.hideMask("gameback")};this.showMask("gameback");this.onTap(close,fnClose);this.game9g.utils.ajax("/gameback.json",function(data){if(data.gamelist){for(var i=0;i<data.gamelist.length;i++){var game=data.gamelist[i];var li=document.createElement("li");var img=document.createElement("img");img.src=game.gameicon;li.appendChild(img);var div=document.createElement("div");div.innerHTML=game.gamename;li.appendChild(div);ul.appendChild(li);(function(li,game){_this.onTap(li,function(){if(game.gameid!=""){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid="+game.gameid}else{window.location=_this.game9g.baseurl}})})(li,game)}}});this.onTap(subscribe,function(){_this.showSubscribe()});this.onTap(leave,function(){if(notip.checked){localStorage.gameBackTipDate=_this.game9g.utils.formatDate(new Date(),"yyyy-MM-dd")};var wxNeedClose=(_this.game9g.utils.getAppType()=="wx"&&(history.length===0||history.length===1||history.length===2));history.go(-1);setTimeout(function(){if(wxNeedClose)_this.game9g.app.close()},200)})};Game9GPay=function(game9g){this.game9g=game9g;this.data=null;this.isAppPay=this.game9g.utils.getAppType()=="9g"&&this.game9g.app.isVersionOver("2.1");this.isAppWxpay=this.isAppPay;this.isAppAlipay=this.isAppPay;this.isNativeWxpay=!this.isAppPay&&this.game9g.utils.getAppType()!="wx"&&this.game9g.utils.getAppType()!="9g"&&!this.game9g.utils.isMobile();if(this.game9g.utils.isWindowsWechat())this.isNativeWxpay=true;this.qrscan=false;this.ui=new Game9GPayUI(game9g);this.init();this.checkVerify();};Game9GPay.prototype.init=function(){var _this=this;window.addEventListener("message",function(e){if(window!=top&&e.source&&e.source==top)return;if(typeof e.data!="object")return;switch(e.data.action){case"pay":if(!e.data.token){alert("token参数为空");return};e.data.paytype=0;e.data.usecredit=0;e.data.usemoney=e.data.money;_this.data=e.data;_this.start();break;case"pay:callback":if(e.source==window)return;_this.closePayFrame(true);_this.payCallback(e.data.status);break;case"pay:cancel":if(e.source==window)return;_this.closePayFrame(true);_this.payCancel();break}});if(this.isAppPay){window.game9gCheckWxpay=function(result){_this.isAppWxpay=(result==1)};window.game9gCheckAlipay=function(result){_this.isAppAlipay=(result==1)};window.game9gPayCallback=function(result){_this.payCallback(result);_this.ui.hidePay()};window.game9gPayCancel=function(){_this.payCancel();_this.ui.hidePay()}}};Game9GPay.prototype.checkVerify=function(){var _this=this;this.game9g.onSpReady(function(){if(_this.game9g.utils.getAppType()=="wx"&&_this.game9g.sp&&_this.game9g.sp.verify==0)_this.isNativeWxpay=true})};Game9GPay.prototype.start=function(){var _this=this;var url="http://wx.9g.com/app/getusersp?token="+_this.data.token;this.game9g.utils.ajax(url,function(data){if(data&&data.uid){if(data.session_spid&&data.session_spid!=_this.game9g.spid){_this.game9g.initSpid(data.session_spid)};if(_this.game9g.sp&&_this.game9g.sp.type==2||_this.game9g.isKuaiWan){}else{_this.game9g.spid=data.spid||null};_this.getSp(_this.data.spid,function(data){_this.data.sp=data&&data.spid?data:null;_this.branch()})}else{var hasAlert=false;var memo="localStorage.token="+localStorage.token+"\n"+"localStorage.myuid="+localStorage.myuid+"\n"+"game9g.spid="+_this.game9g.spid+"\n"+"url="+location.href;_this.game9g.utils.track("pay_invalid_token",0,memo,function(id){hasAlert=true;alert("token无效（错误代码："+id+"）")});setTimeout(function(){if(!hasAlert)alert("token无效")},3000)}})};Game9GPay.prototype.branch=function(){if(this.game9g.isKuaiWan){var url="http://wx.9g.com/kuaiwan/getuser?token="+this.data.token;var _this=this;this.game9g.utils.ajax(url,function(data){if(data&&data.token){_this.payKuaiwan(data.uid,data.token)}else{_this.ready()}})}else if(this.game9g.spid=="qqhall"){this.payQQHall()}else if(this.game9g.spid=="qqgame"){this.payQQGame()}else if(this.game9g.spid=="qqbrowser"){this.payQQBrowser()}else if(this.game9g.spid=="budejie"){this.payBudejie()}else if(this.game9g.spid=="1758"){this.pay1758()}else if(this.game9g.spid=="play68"){this.payPlay68()}else if(this.game9g.spid=="7477"){this.pay7477()}else if(this.game9g.spid=="kugou"){this.payKugou()}else if(this.game9g.spid=="qunhei"){this.payQunhei()}else if(this.game9g.spid=="laya"){this.payLaya()}else if(this.game9g.spid=="qidian"){this.payQidian()}else if(this.game9g.spid=="qqbook"){this.payQQBook()}else if(this.game9g.spid=="fanqie"){this.payFanqie()}else if(this.game9g.spid=="7k7k"){this.pay7k7k()}else if(this.game9g.spid=="lequ"){this.payLequ()}else if(this.game9g.spid=="aiaiu"){this.payAiaiu()}else if(this.game9g.spid=="iqiyi"){this.payIqiyi()}else if(this.game9g.spid=="leguyu"){this.payLeguyu()}else if(this.game9g.spid=="17mao"){this.pay17mao()}else if(this.game9g.spid=="sina"){this.paySina()}else if(this.game9g.spid=="5543"){this.pay5543()}else if(this.game9g.spid=="wan669"){this.payWan669()}else if(this.game9g.spid=="lmw"){this.payLmw()}else if(this.game9g.spid=="meitu"){this.payMeitu()}else if(this.game9g.spid=="360"){this.pay360()}else if(this.game9g.spid=="v1game"){this.payV1game()}else if(this.game9g.spid=="topsgame"){this.payTopsgame()}else if(this.game9g.spid=="60h5"){this.pay60h5()}else if((this.game9g.sp&&this.game9g.sp.type==2)||(typeof window["payChannel"]=="function")){this.payChannel()}else if(this.game9g.isOpenSp){this.payOpen()}else{this.ready()}};Game9GPay.prototype.ready=function(){this.ui.showPay(this.data);this.getCreditReward();this.isAppPay&&this.game9g.app.onShowPay()};Game9GPay.prototype.getSp=function(spid,callback){var _this=this;var url="http://pay.9g.com/open/getsp?spid="+spid;this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9GPay.prototype.getCreditReward=function(){if(this.game9g.isKuaiWan)return;if(this.data.spid=="zg"||this.data.spid=="kdygdsb"||this.data.spid=="mfxy"||this.data.spid=="jzsc"||this.data.spid=="bfhz"||this.data.spid=="zzpk"||this.data.spid=="ttazy")return;if(this.game9g.spid&&this.game9g.spid!="9g"&&this.game9g.spid!="qing"&&this.game9g.spid!="pea"&&this.game9g.spid!="wanyou")return;var _this=this;var url="http://credit.9g.com/v2/getorderreward?token="+this.data.token+"&spid="+this.data.spid+"&money="+this.data.usemoney;this.game9g.utils.ajax(url,function(data){data&&_this.ui.showCreditReward(data)})};Game9GPay.prototype.createOrder=function(callback){var url="http://pay.9g.com/order/create"+"?orderid="+this.data.orderid+"&product="+encodeURIComponent(this.data.product)+"&money="+this.data.money+"&spid="+this.data.spid+"&sign="+this.data.sign;if(this.data.uid)url+="&uid="+this.data.uid;if(this.data.token)url+="&token="+this.data.token;if(this.data.attach)url+="&attach="+encodeURIComponent(this.data.attach);if(this.data.callback)url+="&callback_url="+encodeURIComponent(this.data.callback);if(this.data.notify)url+="&notify="+encodeURIComponent(this.data.notify);if(this.game9g.spid)url+="&open_spid="+this.game9g.spid;if(this.game9g.wechatid)url+="&wechatid="+this.game9g.wechatid;if(sessionStorage.pm_spid)url+="&pm_spid="+sessionStorage.pm_spid;if(this.game9g.abid)url+="&abid="+this.game9g.abid;var _this=this;this.game9g.utils.ajax(url,function(data){if(data&&data.errcode==0){callback&&callback.call(null,data)}else{alert(data.errmsg)}})};Game9GPay.prototype.payKuaiwan=function(uid,token){var _this=this;this.createOrder(function(data){var url=_this.game9g.getGameServer()+"/game/pay.html"+"?orderid="+_this.data.orderid+"&product="+encodeURIComponent(_this.data.product)+"&money="+_this.data.money+"&spid="+_this.data.spid+"&sign="+data.sign;url+="&uid="+uid;url+="&token="+token;var callback=_this.game9g.baseurl+"/gamecenter.html?gameid="+_this.data.sp.gameid+(_this.game9g.spid?"&spid="+_this.game9g.spid:"");url+="&callback="+encodeURIComponent(callback);if(_this.game9g.spid)url+="&open_spid="+_this.game9g.spid;window.location.replace(url)})};Game9GPay.prototype.payQQHall=function(){var _this=this;this.createOrder(function(data){window.startPay&&window.startPay(_this.data)})};Game9GPay.prototype.payQQGame=function(){var _this=this;this.createOrder(function(data){window.payQQGame&&window.payQQGame(_this.data)})};Game9GPay.prototype.payQQBrowser=function(){var _this=this;this.createOrder(function(data){window.payQQBrowser&&window.payQQBrowser(_this.data)})};Game9GPay.prototype.payBudejie=function(){var _this=this;this.createOrder(function(data){window.payBudejie&&window.payBudejie(_this.data)})};Game9GPay.prototype.pay1758=function(){var _this=this;this.createOrder(function(data){window.pay1758&&window.pay1758(_this.data)})};Game9GPay.prototype.payPlay68=function(){var _this=this;this.createOrder(function(data){window.payPlay68&&window.payPlay68(_this.data)})};Game9GPay.prototype.pay7477=function(){var _this=this;this.createOrder(function(data){window.pay7477&&window.pay7477(_this.data)})};Game9GPay.prototype.payKugou=function(){var _this=this;this.createOrder(function(data){window.payKugou&&window.payKugou(_this.data)})};Game9GPay.prototype.payQunhei=function(){var _this=this;this.createOrder(function(data){window.payQunhei&&window.payQunhei(_this.data)})};Game9GPay.prototype.payLaya=function(){var _this=this;this.createOrder(function(data){window.payLaya&&window.payLaya(_this.data)})};Game9GPay.prototype.payQidian=function(){var _this=this;this.createOrder(function(data){window.payQidian&&window.payQidian(_this.data)})};Game9GPay.prototype.payQQBook=function(){var _this=this;this.createOrder(function(data){window.payQQBook&&window.payQQBook(_this.data)})};Game9GPay.prototype.payFanqie=function(){var _this=this;this.createOrder(function(data){window.payFanqie&&window.payFanqie(_this.data)})};Game9GPay.prototype.pay7k7k=function(){var _this=this;this.createOrder(function(data){window.pay7k7k&&window.pay7k7k(_this.data)})};Game9GPay.prototype.payLequ=function(){var _this=this;this.createOrder(function(data){window.payLequ&&window.payLequ(_this.data)})};Game9GPay.prototype.payAiaiu=function(){var _this=this;this.createOrder(function(data){window.payAiaiu&&window.payAiaiu(_this.data)})};Game9GPay.prototype.payIqiyi=function(){var _this=this;this.createOrder(function(data){window.payIqiyi&&window.payIqiyi(_this.data)})};Game9GPay.prototype.payLeguyu=function(){var _this=this;this.createOrder(function(data){window.payLeguyu&&window.payLeguyu(_this.data)})};Game9GPay.prototype.pay17mao=function(){var _this=this;this.createOrder(function(data){window.pay17mao&&window.pay17mao(_this.data)})};Game9GPay.prototype.paySina=function(){var _this=this;this.createOrder(function(data){window.paySina&&window.paySina(_this.data)})};Game9GPay.prototype.pay5543=function(){var _this=this;this.createOrder(function(data){window.pay5543&&window.pay5543(_this.data)})};Game9GPay.prototype.payWan669=function(){var _this=this;this.createOrder(function(data){window.payWan669&&window.payWan669(_this.data)})};Game9GPay.prototype.payLmw=function(){var _this=this;this.createOrder(function(data){window.payLmw&&window.payLmw(_this.data)})};Game9GPay.prototype.payMeitu=function(){var _this=this;this.createOrder(function(data){window.payMeitu&&window.payMeitu(_this.data)})};Game9GPay.prototype.pay360=function(){var _this=this;this.createOrder(function(data){window.pay360&&window.pay360(_this.data)})};Game9GPay.prototype.payV1game=function(){var _this=this;this.createOrder(function(data){window.payV1game&&window.payV1game(_this.data)})};Game9GPay.prototype.payTopsgame=function(){var _this=this;this.createOrder(function(data){window.payTopsgame&&window.payTopsgame(_this.data)})};Game9GPay.prototype.payChannel=function(){var _this=this;this.createOrder(function(data){window.payChannel&&window.payChannel(_this.data)})};Game9GPay.prototype.pay60h5=function(){var _this=this;this.createOrder(function(data){if(window==top)return;var paySign=data.sign;var url="http://wx.9g.com/60h5/getuser?token="+_this.data.token;_this.game9g.utils.ajax(url,function(data){if(data.error){alert(data.error);return};var payData={action:"pay",orderid:_this.data.orderid,money:_this.data.money,product:_this.data.product,spid:_this.data.spid,sign:paySign,token:data.token,open_spid:_this.game9g.spid};window.parent.postMessage(payData,"*")})})};Game9GPay.prototype.payOpen=function(){var origin=this.game9g.utils.getOrigin();if(origin!=this.game9g.baseurl){var specDomainUrl=location.href.replace(origin,this.game9g.baseurl);window.location.replace(specDomainUrl);return};var _this=this;this.createOrder(function(data){_this.postOpenWxpay(data.sign)})};Game9GPay.prototype.pay=function(){switch(this.data.paytype){case 1:this.postWxpay();break;case 2:this.postAlipay();break;case 3:this.postWapWxpay();break}};Game9GPay.prototype.postMessage=function(data){if(this.data.fullscreen){window.postMessage(data,"*")}else{this.game9g.postMessageFrame(data)}};Game9GPay.prototype.payCallback=function(result){this.postMessage({action:"pay:callback",orderid:this.data.orderid,money:this.data.money,status:result,sp:this.data.sp})};Game9GPay.prototype.payCancel=function(){this.postMessage({action:"pay:cancel",sp:this.data.sp})};Game9GPay.prototype.postWxpay=function(){var url="http://pay.9g.com/wxpay/prepay"+"?orderid="+this.data.orderid+"&product="+encodeURIComponent(this.data.product)+"&money="+this.data.money+"&spid="+this.data.spid+"&sign="+this.data.sign+"&paytype="+this.data.paytype+"&usecredit="+this.data.usecredit;if(this.data.uid)url+="&uid="+this.data.uid;if(this.data.token)url+="&token="+this.data.token;if(this.data.attach)url+="&attach="+encodeURIComponent(this.data.attach);if(this.data.callback)url+="&callback_url="+encodeURIComponent(this.data.callback);if(this.data.notify)url+="&notify="+encodeURIComponent(this.data.notify);if(this.isAppWxpay)url+="&mp=9gapp";if(this.isNativeWxpay)url+="&mp=9gnative";if(this.game9g.spid)url+="&open_spid="+this.game9g.spid;if(this.game9g.wechatid)url+="&wechatid="+this.game9g.wechatid;if(sessionStorage.pm_spid)url+="&pm_spid="+sessionStorage.pm_spid;if(this.game9g.abid)url+="&abid="+this.game9g.abid;if(localStorage.realuid&&localStorage.realuid!=localStorage.myuid)url+="&realuid="+localStorage.realuid;var _this=this;this.game9g.utils.ajax(url,function(data){if(data.error){var hasAlert=false;var memo="localStorage.token="+localStorage.token+"\n"+"localStorage.myuid="+localStorage.myuid+"\n"+"localStorage.realuid="+localStorage.realuid+"\n"+"game9g.spid="+_this.game9g.spid+"\n"+"url="+url;_this.game9g.utils.track("pay_invalid_openid",0,memo,function(id){hasAlert=true;alert(data.error+"（错误代码："+id+"）")});setTimeout(function(){if(!hasAlert)alert(data.error)},3000);return};if(_this.isAppWxpay){_this.game9g.app.postWxpay(data)}else if(_this.isNativeWxpay){_this.showNativeWxpay(data,function(){_this.payCallback(1)})}else{_this.game9g.app.chooseWXPay(data,function(res){if(res.errMsg=="chooseWXPay:ok"){_this.payCallback(1)}else{alert("支付失败："+res.errMsg);_this.payCallback(-1)};_this.ui.hidePay()})}})};Game9GPay.prototype.postAlipay=function(){var url="http://pay.9g.com/order/pay"+"?orderid="+this.data.orderid+"&product="+encodeURIComponent(this.data.product)+"&money="+this.data.money+"&spid="+this.data.spid+"&sign="+this.data.sign+"&paytype="+this.data.paytype+"&usecredit="+this.data.usecredit;if(this.data.uid)url+="&uid="+this.data.uid;if(this.data.token)url+="&token="+this.data.token;if(this.data.attach)url+="&attach="+encodeURIComponent(this.data.attach);if(this.data.callback)url+="&callback_url="+encodeURIComponent(this.data.callback);if(this.data.notify)url+="&notify="+encodeURIComponent(this.data.notify);if(this.isAppAlipay)url+="&mp=9gapp";if(this.game9g.spid)url+="&open_spid="+this.game9g.spid;if(this.game9g.wechatid)url+="&wechatid="+this.game9g.wechatid;if(sessionStorage.pm_spid)url+="&pm_spid="+sessionStorage.pm_spid;if(this.game9g.abid)url+="&abid="+this.game9g.abid;if(this.isAppAlipay){var _this=this;this.game9g.utils.ajax(url,function(data){if(data.error){alert(data.error);return};_this.game9g.app.postAlipay(data.orderInfo)})}else{this.openPayFrame(url)}};Game9GPay.prototype.postWapWxpay=function(){var url="http://pay.9g.com/wxpay/prepay"+"?orderid="+this.data.orderid+"&product="+encodeURIComponent(this.data.product)+"&money="+this.data.money+"&spid="+this.data.spid+"&sign="+this.data.sign+"&paytype="+this.data.paytype+"&usecredit="+this.data.usecredit;if(this.data.uid)url+="&uid="+this.data.uid;if(this.data.token)url+="&token="+this.data.token;if(this.data.attach)url+="&attach="+encodeURIComponent(this.data.attach);if(this.data.callback)url+="&callback_url="+encodeURIComponent(this.data.callback);if(this.data.notify)url+="&notify="+encodeURIComponent(this.data.notify);if(this.game9g.spid)url+="&open_spid="+this.game9g.spid;url+="&mp=wap";var _this=this;this.game9g.utils.ajax(url,function(data){if(data.error){alert(data.error);return};window.location=data.pay_info})};Game9GPay.prototype.showNativeWxpay=function(data,callback){this.data.code_url=data.code_url;this.ui.hidePay();this.ui.showQrcode(this.data);this.qrscan=true;var _this=this;var check=function(){if(!_this.qrscan)return;var url="http://pay.9g.com/order/check?orderid="+_this.data.orderid+"&token="+_this.data.token;_this.game9g.utils.ajax(url,function(data){if(data.error)return;if(!!data&&!!data.orderid&&data.status==1){_this.qrscan=false;_this.ui.hideQrcode();callback&&callback.call(null)}else{setTimeout(check,1000)}})};check()};Game9GPay.prototype.postOpenWxpay=function(sign){var url=this.game9g.getPayServer()+"/wxpay/prepay"+"?orderid="+this.data.orderid+"&product="+encodeURIComponent(this.data.product)+"&money="+this.data.money+"&spid="+this.data.spid+"&sign="+sign;url+="&wxid="+(localStorage.realuid||localStorage.myuid);if(this.data.attach)url+="&attach="+encodeURIComponent(this.data.attach);var _this=this;this.game9g.utils.ajax(url,function(data){if(data.error){alert(data.error);return};_this.game9g.app.chooseWXPay(data,function(res){if(res.errMsg=="chooseWXPay:ok"){_this.payCallback(1)}else{alert("支付失败："+res.errMsg);_this.payCallback(-1)};_this.ui.hidePay()})})};Game9GPay.prototype.openPayFrame=function(url){var frame=document.getElementById("game9gpayframe");if(!frame){frame=document.createElement("iframe");frame.id="game9gpayframe";frame.className="game9gpayframe";document.getElementsByTagName("body")[0].appendChild(frame)};frame.src=url};Game9GPay.prototype.closePayFrame=function(closePayUI){var frame=document.getElementById("game9gpayframe");if(frame)frame.parentElement.removeChild(frame);if(closePayUI)this.ui.hidePay()};Game9GPayUI=function(game9g){this.game9g=game9g;var _this=this;this.game9g.addEventListener("orientationChange",function(){_this.onResize()})};Game9GPayUI.prototype.showPay=function(data){if(!data.fullscreen){this.hidePay();this.game9g.ui.showMask()};var _this=this;var isPC=window.innerWidth>window.innerHeight;var div=document.createElement("div");div.id="game9gpay";div.className="game9gpay"+(data.fullscreen?"":" game9gpaypopup")+(isPC?" pc":"");document.getElementsByTagName("body")[0].appendChild(div);var header=document.createElement("div");header.className="game9gpayheader";header.innerHTML="支付平台";div.appendChild(header);var cancel=document.createElement("img");cancel.src="http://game.9g.com/img/close.png";header.appendChild(cancel);var info=document.createElement("div");info.className="game9gpaymain";div.appendChild(info);var icon=document.createElement("img");icon.src=data.icon||"http://game.9g.com/icon.png";info.appendChild(icon);icon.style.display="none";var table=document.createElement("table");info.appendChild(table);var tr,td;tr=document.createElement("tr");td=document.createElement("td");td.className="game9gpaylabel";td.innerHTML="商户名称";tr.appendChild(td);td=document.createElement("td");td.className="game9gpaycontent";td.innerHTML=data.sp?data.sp.spname:"游戏中心";tr.appendChild(td);table.appendChild(tr);tr=document.createElement("tr");td=document.createElement("td");td.className="game9gpaylabel";td.innerHTML="商品名称";tr.appendChild(td);td=document.createElement("td");td.className="game9gpaycontent";td.innerHTML=data.product;tr.appendChild(td);table.appendChild(tr);tr=document.createElement("tr");td=document.createElement("td");td.className="game9gpaylabel";td.innerHTML="支付金额";tr.appendChild(td);td=document.createElement("td");td.className="game9gpaycontent";td.innerHTML=this.game9g.utils.formatMoney(data.money,{color:"#ff6600",symbol:false,bold:true,space:true});tr.appendChild(td);table.appendChild(tr);var credit=document.createElement("div");credit.className="game9gpaycredit";credit.style.display="none";div.appendChild(credit);var account=document.createElement("div");account.className="game9gpaycreditaccount";credit.appendChild(account);var creditcheck=document.createElement("input");creditcheck.id="game9gpaycreditcheck";creditcheck.type="checkbox";account.appendChild(creditcheck);var creditlabel=document.createElement("label");creditlabel.setAttribute("for","game9gpaycreditcheck");creditlabel.innerHTML="9G账户";account.appendChild(creditlabel);var balance=document.createElement("span");balance.innerHTML="（?元）";account.appendChild(balance);var creditshow=document.createElement("div");creditshow.className="game9gpaycreditshow";creditshow.innerHTML="使用9G账户支付?元";credit.appendChild(creditshow);var credittip=document.createElement("div");credittip.className="game9gpaycredittip";credittip.style.display="none";credittip.innerHTML="9G积分与人民币换算：1积分 = 0.01元";div.appendChild(credittip);var mode=document.createElement("div");mode.className="game9gpaymode";div.appendChild(mode);var modehead=document.createElement("div");modehead.className="game9gpaymodehead";mode.appendChild(modehead);var modetitle=document.createElement("div");modetitle.className="game9gpaymodetitle";modetitle.innerHTML="支付方式";modehead.appendChild(modetitle);var modepay=document.createElement("div");modepay.className="game9gpaymodepay";modepay.innerHTML="支付 "+this.game9g.utils.formatMoney(data.usemoney,{color:"#ff6600",symbol:false,bold:true,space:true});modehead.appendChild(modepay);var paytype=document.createElement("div");paytype.className="game9gpaytype";mode.appendChild(paytype);var type1=document.createElement("img");type1.id="game9gpaytype1";type1.className="game9gpaytype1";paytype.appendChild(type1);var setPayType1=function(e){_this.setPayType(1);e.preventDefault()};type1.addEventListener("touchstart",setPayType1);type1.addEventListener("mousedown",setPayType1);var type2=document.createElement("img");type2.id="game9gpaytype2";type2.className="game9gpaytype2";paytype.appendChild(type2);var setPayType2=function(e){_this.setPayType(2);e.preventDefault()};type2.addEventListener("touchstart",setPayType2);type2.addEventListener("mousedown",setPayType2);var type3=document.createElement("img");type3.id="game9gpaytype3";type3.className="game9gpaytype3";paytype.appendChild(type3);var setPayType3=function(e){_this.setPayType(3);e.preventDefault()};type3.addEventListener("touchstart",setPayType3);type3.addEventListener("mousedown",setPayType3);var reward=document.createElement("div");reward.id="game9gpayreward";reward.className="game9gpayreward";reward.style.display="none";div.appendChild(reward);var btnNext=document.createElement("input");btnNext.type="button";btnNext.className="game9gpaybtn";btnNext.value="下一步";btnNext.addEventListener("click",function(e){_this.game9g.pay.pay()});div.appendChild(btnNext);var close=function(e){if(!_this.game9g.pay.data.fullscreen)_this.hidePay();_this.game9g.pay.payCancel();e.preventDefault()};cancel.addEventListener("touchstart",close);cancel.addEventListener("mousedown",close);if(data.money>1&&data.spid!="9gcredit"&&!this.game9g.isKuaiWan&&data.spid!="zg"&&data.spid!="kdygdsb"&&data.spid!="mfxy"&&data.spid!="jzsc"&&data.spid!="bfhz"&&data.spid!="zzpk"&&data.spid!="ttazy"){this.game9g.getCredit(function(){if(_this.game9g.credit==0)return;balance.innerHTML="（"+_this.game9g.utils.formatMoney(_this.game9g.credit,{symbol:false,space:false})+"）";if(_this.game9g.credit==0){creditcheck.disabled=true};creditshow.style.display="none";credit.style.display="";_this.onResize();creditcheck.addEventListener("click",function(e){if(this.checked){data.usecredit=(_this.game9g.credit<data.money?_this.game9g.credit:data.money-1);data.usemoney=data.money-data.usecredit;creditshow.innerHTML="支付 "+_this.game9g.utils.formatMoney(data.usecredit,{color:"#ff6600",symbol:false,bold:true,space:true});creditshow.style.display=""}else{data.usecredit=0;data.usemoney=data.money;creditshow.style.display="none"};modepay.innerHTML="支付 "+_this.game9g.utils.formatMoney(data.usemoney,{color:"#ff6600",symbol:false,bold:true,space:true});_this.game9g.pay.getCreditReward()})})};if(this.game9g.utils.getAppType()=="wx"||this.game9g.pay.isAppPay||this.game9g.pay.isNativeWxpay){this.setPayType(1);type3.style.display="none"}else{type1.style.display="none";this.setPayType(2);if(this.game9g.utils.isMobile()){}else{type3.style.display="none"};if(this.game9g.utils.getAppType()=="ggzs"){type3.style.display="none"}};this.onResize()};Game9GPayUI.prototype.hidePay=function(){var div=document.getElementById("game9gpay");if(div)div.parentElement.removeChild(div);this.game9g.ui.hideMask()};Game9GPayUI.prototype.setPayType=function(type){this.game9g.pay.data.paytype=type;document.getElementById("game9gpaytype1").src="http://game.9g.com/img/pay_wxzf_"+(type==1?"on":"off")+".png";document.getElementById("game9gpaytype2").src="http://game.9g.com/img/pay_zfb_"+(type==2?"on":"off")+".png";document.getElementById("game9gpaytype3").src="http://game.9g.com/img/pay_wxzf_"+(type==3?"on":"off")+".png"};Game9GPayUI.prototype.showCreditReward=function(data){var div=document.getElementById("game9gpay");var reward=document.getElementById("game9gpayreward");if(!div)return;if(data.reward){reward.innerHTML="您是VIP"+data.target_level_id+"，本次充值将返还您 "+this.game9g.utils.formatMoney(data.reward,{color:"#ff6600",symbol:false,bold:true,space:true})+"。";reward.style.display=""}else{reward.innerHTML="";reward.style.display="none"};this.onResize()};Game9GPayUI.prototype.showQrcode=function(data){if(!data.fullscreen){this.hideQrcode();this.game9g.ui.showMask()};var isPC=window.innerWidth>window.innerHeight;var div=document.createElement("div");div.id="game9gpayqrcode";div.className="game9gpay"+(data.fullscreen?"":" game9gpaypopup")+(isPC?" pc":"");document.getElementsByTagName("body")[0].appendChild(div);var header=document.createElement("div");header.className="game9gpayheader";header.innerHTML=this.game9g.utils.getAppType()=="wx"?"长按二维码识别完成支付":"请打开微信扫一扫完成支付";div.appendChild(header);var cancel=document.createElement("img");cancel.src="http://game.9g.com/img/close.png";header.appendChild(cancel);var qrmain=document.createElement("div");qrmain.className="game9gpayqrmain";div.appendChild(qrmain);var qrbox=document.createElement("div");qrbox.className="game9gpayqrbox";qrmain.appendChild(qrbox);var _this=this;var size=this.game9g.utils.vw2px(isPC?30:60);this.game9g.utils.onQRCodeReady(function(){var qrcode=new QRCode(qrbox,{width:size,height:size});qrcode.makeCode(data.code_url)});var close=function(e){if(!_this.game9g.pay.data.fullscreen)_this.hideQrcode();_this.game9g.pay.qrscan=false;e.preventDefault()};cancel.addEventListener("touchstart",close);cancel.addEventListener("mousedown",close);this.onResize()};Game9GPayUI.prototype.hideQrcode=function(){var div=document.getElementById("game9gpayqrcode");if(div)div.parentElement.removeChild(div);this.game9g.ui.hideMask()};Game9GPayUI.prototype.onResize=function(){var isPC=window.innerWidth>window.innerHeight;var div=document.getElementById("game9gpay");if(div){div.className="game9gpay"+(this.game9g.pay.data.fullscreen?"":" game9gpaypopup")+(isPC?" pc":"");if(!this.game9g.pay.data.fullscreen){setTimeout(function(){if(div)div.style.top=div.offsetHeight<window.innerHeight?(window.innerHeight-div.offsetHeight)/2+"px":0},50)}};var divqr=document.getElementById("game9gpayqrcode");if(divqr){divqr.className="game9gpay"+(this.game9g.pay.data.fullscreen?"":" game9gpaypopup")+(isPC?" pc":"");if(!this.game9g.pay.data.fullscreen){setTimeout(function(){if(div)divqr.style.top=divqr.offsetHeight<window.innerHeight?(window.innerHeight-divqr.offsetHeight)/2+"px":0},50)}}};Game9GChat=function(game9g){this.game9g=game9g;this.emojis=null;this.Channel={PRIVATE:10,CHAT:20,GROUP_CHAT:30,GAME:50};this.Command={C_TEXT:2001,C_IMAGE:2002,C_VOICE:2003,C_VIDEO:2004,C_HTML:2005,C_QA:2006,C_QA_ANSWER:2007,C_ARRIVE:2008,C_READ:2009,C_UNREAD:2010,C_FEED_LINK:2011,C_FRIEND_REQUEST:2012,C_FRIEND_RESPONSE:2013,C_FRIEND_REMOVE:2014,C_ADD_BLACKLIST:2015,C_REMOVE_BLACKLIST:2016,C_BAD_REPORT:2017,C_GAME_LINK:2018,C_GAME_PK_REQUEST:2021,C_GAME_PK_REQUEST_CANCEL:2022,C_GAME_PK_RESPONSE:2023};this.ui=new Game9GChatUI(game9g);this.init()};Game9GChat.prototype.init=function(){var _this=this;this.loadEmojis();this.unread=0;this.firstCheck=true;this.checkMessageTime=this.defaultCheckMessageTime=15;this.checkNewMessageTimer=null;this.game9g.onRoleReady(function(){_this.checkNewMessage()});};Game9GChat.prototype.loadEmojis=function(){var _this=this;this.game9g.utils.ajax("/img/emoji/emoji.json",function(data){_this.emojis=data})};Game9GChat.prototype.getMessageList=function(roleid,callback){var _this=this;var url="http://pp.9g.com/im/gethistopymessages?token="+localStorage.token+"&role_id="+roleid+(this.game9g.gameid?"&kf=1&gameid="+this.game9g.gameid:"");this.game9g.utils.ajax(url,function(data){if(!data)return;if(data.error)return alert(data.error);callback&&callback.call(null,data)})};Game9GChat.prototype.getMessageListByTalker=function(options,callback){var _this=this;var url="http://pp.9g.com/im/gethistorymessagebytalker?token="+localStorage.token+"&role_id="+options.roleid+"&talker="+options.talker+(options.id!=undefined?"&id="+options.id:"");this.game9g.utils.ajax(url,function(data){if(!data)return;if(data.error)return alert(data.error);callback&&callback.call(null,data)})};Game9GChat.prototype.checkNewMessage=function(){if(!localStorage.token||!this.game9g.roleid)return;var _this=this;var url="http://pp.9g.com/im/getunreadcount?token="+localStorage.token+"&role_id="+this.game9g.roleid+(this.game9g.gameid?"&kf=1&gameid="+this.game9g.gameid:"");this.game9g.utils.ajax(url,function(data){var unread=data.count;if(_this.firstCheck||unread!=_this.unread){_this.game9g.dispatchEvent("newMessage",unread);if(!_this.firstCheck){_this.game9g.dispatchEvent("refreshMessage")}};_this.unread=unread;_this.firstCheck=false;_this.checkNewMessageNext()},"checkNewMessage")};Game9GChat.prototype.checkNewMessageNext=function(){if(this.checkNewMessageTimer){clearTimeout(this.checkNewMessageTimer)};var _this=this;this.checkNewMessageTimer=setTimeout(function(){_this.checkNewMessage()},_this.checkMessageTime*1000)};Game9GChat.prototype.resetCheckNewMessageTimer=function(sec){this.checkMessageTime=sec||this.defaultCheckMessageTime;if(this.lastSetCheckTime&&this.lastSetCheckTime==this.checkMessageTime)return;this.lastSetCheckTime=this.checkMessageTime;this.checkNewMessageNext()};Game9GChat.prototype.getNewMessage=function(callback){if(!localStorage.token)return;var url="http://pp.9g.com/im/getnewmessage?token="+localStorage.token+(this.game9g.gameid?"&kf=1&gameid="+this.game9g.gameid:"");var _this=this;this.game9g.utils.ajax(url,function(data){if(data&&data.list&&data.list.length>0){callback&&callback.call(null,data.list)}})};Game9GChat.prototype.handleMessages=function(list){var wrap=null,mask=null,n=0;var _this=this;for(var i=0;i<list.length;i++){var msg=list[i];switch(msg.type){case 9:this.handleFriendRequest(msg);break;case 13:this.handlePkRequest(msg);break;case 14:break;default:if(msg.type==12&&msg.content.game.gameid=="hongbao"){this.handleHongbao(msg);break};n++;if(n==1){this.game9g.ui.start&&this.game9g.ui.start.hide();wrap=document.createElement("div");wrap.className="game9guichatpopupwrap";document.getElementsByTagName("body")[0].appendChild(wrap);mask=document.createElement("div");mask.className="game9guichatpopupmask";wrap.appendChild(mask)}(function(msg){setTimeout(function(){var div=_this.ui.popup(msg);wrap.appendChild(div);setTimeout(function(){var finish=function(){div.parentElement.removeChild(div);if(wrap.getElementsByClassName("game9guichatpopup").length==0){wrap.parentElement.removeChild(wrap);_this.game9g.ui.start&&_this.game9g.ui.start.show()}};div.className="game9guichatpopup bounceOutLeft";div.addEventListener("animationend",finish);div.addEventListener("webkitAnimationEnd",finish);mask.className+=" fadeOutSlow"},5000)},n*50)})(msg);break}}};Game9GChat.prototype.handleFriendRequest=function(msg){var _this=this;this.ui.showRequest({roleid:msg.talker,content:"{role}请求加你为好友："+msg.content.message,buttons:[{type:"agree",click:function(){_this.friendResponse(msg,1);_this.resetCheckNewMessageTimer()}},{type:"reject",click:function(){_this.friendResponse(msg,-1);_this.resetCheckNewMessageTimer()}}]});this.resetCheckNewMessageTimer(5)};Game9GChat.prototype.handleHongbao=function(msg){var _this=this;this.ui.showRequest({roleid:msg.talker,content:"{role}给你发了一个红包。",buttons:[{label:"接收",type:"agree",click:function(){var hongbao_id=msg.content.score;window.location=game9g.baseurl+"/gamecenter.html?gameid=hongbao&data="+hongbao_id}},{label:"忽略",type:"reject"}]})};Game9GChat.prototype.handlePkRequest=function(msg){if(msg.content.cancel){this.ui.hideRequest();this.resetCheckNewMessageTimer()}else{var _this=this;this.ui.showRequest({roleid:msg.talker,content:"{role}想和你一起玩游戏",buttons:[{type:"agree",click:function(){_this.pkResponse(msg,1);_this.resetCheckNewMessageTimer()}},{type:"reject",click:function(){_this.pkResponse(msg,-1);_this.resetCheckNewMessageTimer()}}]});this.resetCheckNewMessageTimer(5)}};Game9GChat.prototype.parse=function(msg,style){style=style||"default";var content="";try{switch(msg.type){case 1:content=msg.content;break;case 2:content=style=="notify"?"发来一张照片":"[图片]";break;case 3:content=style=="notify"?"发来一段语音":"[语音]";break;case 4:content=style=="notify"?"发来一段视频":"[视频]";break;case 5:content=style="notify"?"[图文消息]":"[图文]";break;case 6:content=msg.content.qa.content;break;case 7:content=msg.content.answer;break;case 8:content="[动态链接]";break;case 9:content="请求加好友："+msg.content.message;break;case 10:content="响应好友请求："+(msg.content.response==1?"同意":"拒绝");break;case 11:content=msg.content.feed.content.text;break;case 12:content=msg.content.title;break;case 13:content="[游戏对战请求]";break;case 14:content="[游戏对战响应]："+(msg.content.response==1?"同意":"拒绝");break;default:content="【未知的聊天格式】";break}}catch(e){console.log(e)};if(msg.type==1&&this.emojis){content=this.parseEmoji(content)};return content};Game9GChat.prototype.parseEmoji=function(content){var _this=this;return content.replace(/\[([^\]]+)\]/ig,function($0,$1,$2){return _this.emojis[$1]?"<img class='emoji' src='http://game.9g.com/img/emoji/"+_this.emojis[$1]+"' />":$0})};Game9GChat.prototype.send=function(json,success,fail){var url="http://pp.9g.com/im/sendmessage?token="+localStorage.token+"&message="+encodeURIComponent(JSON.stringify(json));this.game9g.utils.ajax(url,function(data){if(data&&data.success){success&&success.call(null,data)}else{fail=fail||function(){alert("发送失败")};fail.call(null)}})};Game9GChat.prototype.sendRead=function(roleid,talker,success,fail){this.send({ch:this.Channel.CHAT,cmd:this.Command.C_READ,role_id:roleid,talker:talker},success,fail)};Game9GChat.prototype.sendText=function(fid,tid,content,success,fail){this.send({ch:this.Channel.CHAT,cmd:this.Command.C_TEXT,fid:fid,tid:tid,content:content},success,fail)};Game9GChat.prototype.sendImage=function(fid,tid,url,success,fail){this.send({ch:this.Channel.CHAT,cmd:this.Command.C_IMAGE,fid:fid,tid:tid,content:{url:url}},success,fail)};Game9GChat.prototype.sendFriendRequest=function(fid,tid,message,success,fail){this.send({ch:this.Channel.CHAT,cmd:this.Command.C_FRIEND_REQUEST,fid:fid,tid:tid,message:message},success,fail)};Game9GChat.prototype.friendResponse=function(msg,response){var json={ch:this.Channel.CHAT,cmd:this.Command.C_FRIEND_RESPONSE,fid:this.game9g.roleid,tid:msg.talker,request_id:msg.content.request_id,response:response};var _this=this;this.send(json,function(data){_this.game9g.utils.alert("已"+(response==1?"同意":"拒绝")+"对方的请求。")})};Game9GChat.prototype.pkResponse=function(msg,response){var json={ch:this.Channel.CHAT,cmd:this.Command.C_GAME_PK_RESPONSE,fid:this.game9g.roleid,tid:msg.talker,request_id:msg.content.request_id,response:response};var _this=this;this.send(json,function(data){if(response==1){_this.game9g.utils.dialog({title:"一起玩",content:"正在进入游戏，请稍候.."});var roomid=msg.content.room_id;window.location=_this.game9g.baseurl+"/gamecenter.html?gameid=pk&roomid="+roomid}})};Game9GChat.prototype.gotoChat=function(roleid){window.location=this.game9g.baseurl+"/app/chat.html?talker="+roleid+"&r="+Math.random()};Game9GChatUI=function(game9g){this.game9g=game9g};Game9GChatUI.prototype.popup=function(msg){var div=document.createElement("div");div.className="game9guichatpopup bounceInLeft";var img=document.createElement("img");img.className="game9guichatpopuphead";img.src="http://game.9g.com/default.png";div.appendChild(img);var _this=this;this.game9g.getRole(msg.talker,function(role){msg.talkerRole=role;img.src=_this.game9g.utils.getHead132(role.headimgurl)});var text=document.createElement("div");text.className="game9guichatpopupcontent";text.innerHTML=this.game9g.chat.parse(msg,"notify");div.appendChild(text);div.addEventListener("touchstart",function(e){if(_this.game9g.isSite){_this.game9g.showSite("kf");_this.game9g.site.pages.kf.chatTo(msg.talker);return};_this.chatTo(msg.talkerRole,true);e.preventDefault()});return div};Game9GChatUI.prototype.chatTo=function(role,reply){var mask=document.createElement("div");mask.className="game9guichatreplymask";document.getElementsByTagName("body")[0].appendChild(mask);var div=document.createElement("div");div.className="game9guichatreply bounceInRight";document.getElementsByTagName("body")[0].appendChild(div);var input=document.createElement("input");input.placeholder=(reply?"回复：":"发送：")+role.nickname;div.appendChild(input);var a=document.createElement("a");a.className="game9guichatreplybtn";a.innerHTML="发送";div.appendChild(a);var tip=document.createElement("a");tip.className="game9guichatreplytip";tip.innerHTML="查看聊天记录";div.appendChild(tip);var closeReply=function(){var finish=function(){div.parentElement.removeChild(div);mask.parentElement.removeChild(mask)};div.className="game9guichatreply bounceOutRight";div.addEventListener("animationend",finish);div.addEventListener("webkitAnimationEnd",finish);mask.className+=" fadeOutSlow"};var busy=false;var _this=this;var send=function(){if(busy)return;busy=true;a.innerHTML="……";_this.game9g.chat.sendText(_this.game9g.roleid,role.role_id,input.value,function(){a.innerHTML="√";setTimeout(closeReply,200)},function(){a.innerHTML="发送";busy=false})};input.addEventListener("keydown",function(e){if(e.keyCode==13){send()}});a.addEventListener("touchstart",function(e){send();e.preventDefault()});mask.addEventListener("touchstart",function(e){closeReply();e.preventDefault()});tip.addEventListener("touchstart",function(e){_this.game9g.chat.gotoChat(role.role_id);e.preventDefault()})};Game9GChatUI.prototype.showChatFrame=function(talker){var _this=this;var mask=document.createElement("div");mask.id="game9gchatframemask";mask.className="game9gchatframemask";mask.addEventListener("touchstart",function(e){_this.hideChatFrame();e.preventDefault()});document.getElementsByTagName("body")[0].appendChild(mask);var wrap=document.createElement("div");wrap.id="game9gchatframewrap";wrap.className="game9gchatframewrap bounceInDown";document.getElementsByTagName("body")[0].appendChild(wrap);setTimeout(function(){wrap.style.webkitOverflowScrolling="touch"},500);var frame=document.createElement("iframe");frame.id="game9gchatframe";frame.className="game9gchatframe";frame.src=this.game9g.baseurl+"/app/chat.html?talker="+talker+"&r="+Math.random();wrap.appendChild(frame)};Game9GChatUI.prototype.hideChatFrame=function(){var mask=document.getElementById("game9gchatframemask");var wrap=document.getElementById("game9gchatframewrap");if(wrap){var finish=function(){wrap.parentElement.removeChild(wrap);mask.parentElement.removeChild(mask)};wrap.className="game9gchatframewrap bounceOutUp";wrap.addEventListener("animationend",finish);wrap.addEventListener("webkitAnimationEnd",finish)}};Game9GChatUI.prototype.showRequest=function(options){var defaults={roleid:0,role:null,content:"",buttons:[]};options=this.game9g.utils.extend(defaults,options);this.game9g.ui.start&&this.game9g.ui.start.hide();var wrap=document.createElement("div");wrap.id="game9guirequestwrap";wrap.className="game9guirequestwrap";document.getElementsByTagName("body")[0].appendChild(wrap);var mask=document.createElement("div");mask.id="game9guirequestmask";mask.className="game9guirequestmask";wrap.appendChild(mask);var div=document.createElement("div");div.id="game9guirequest";div.className="game9guirequest bounceInLeft";wrap.appendChild(div);var img=document.createElement("img");img.className="game9guirequesthead";img.src="http://game.9g.com/default.png";div.appendChild(img);var text=document.createElement("div");text.className="game9guirequesttext";div.appendChild(text);var _this=this;var showContent=function(role,content){img.src=_this.game9g.utils.getHead132(role.headimgurl);text.innerHTML=content.replace("{role}",role.nickname+"<img src='http://game.9g.com/img/"+(role.sex==1?"male":"female")+".png' />")};if(options.role){showContent(options.role,options.content)}else if(options.roleid){this.game9g.getRole(options.roleid,function(role){showContent(role,options.content)})};var btns=document.createElement("div");btns.className="game9guiresponsebtns";div.appendChild(btns);for(var i=0;i<options.buttons.length;i++){(function(btn){var a=document.createElement("a");a.className=(btn.type=="agree"?"game9guiresponseagree":"game9guiresponsereject");a.innerHTML=btn.label||(btn.type=="agree"?"同意":"拒绝");var onclick=function(e){btn.click&&btn.click.call(null);_this.hideRequest();e.preventDefault()};a.addEventListener("touchstart",onclick);a.addEventListener("mousedown",onclick);btns.appendChild(a)})(options.buttons[i])}};Game9GChatUI.prototype.hideRequest=function(){var wrap=document.getElementById("game9guirequestwrap");var mask=document.getElementById("game9guirequestmask");var div=document.getElementById("game9guirequest");if(div){var _this=this;var finish=function(){wrap.parentElement.removeChild(wrap);_this.game9g.ui.start&&_this.game9g.ui.start.show()};div.className="game9guirequest bounceOutLeft";div.addEventListener("animationend",finish);div.addEventListener("webkitAnimationEnd",finish);mask.className+=" fadeOutSlow"}};Game9GSite=function(game9g){this.game9g=game9g;this.dom={};this.menus={};this.pages={};this.visible=false;this.init()};Game9GSite.prototype.select=function(id){this.game9g.dispatchEvent("siteSelect",id)};Game9GSite.prototype.init=function(){var mask=document.createElement("div");mask.className="game9gsitemask";document.getElementsByTagName("body")[0].appendChild(this.dom.mask=mask);var site=document.createElement("div");site.className="game9gsite";document.getElementsByTagName("body")[0].appendChild(this.dom.site=site);var wrap=document.createElement("div");wrap.className="game9gsitewrap";site.appendChild(this.dom.wrap=wrap);var drawer=document.createElement("div");drawer.className="game9gsitedrawer";site.appendChild(this.dom.drawer=drawer);wrap.appendChild(this.initHeader());wrap.appendChild(this.initNav());wrap.appendChild(this.initBody());this.loadProfile();this.initEvent()};Game9GSite.prototype.initEvent=function(){var _this=this;this.game9g.ui.onTap([this.dom.mask,this.dom.drawer],function(){_this.hide()});this.resize();this.game9g.addEventListener("orientationChange",function(){_this.resize()})};Game9GSite.prototype.initHeader=function(){var header=document.createElement("div");header.className="game9gsiteheader";var fav=document.createElement("div");fav.className="game9gsiteheaderfav";fav.innerHTML="收藏游戏";header.appendChild(this.dom.fav=fav);var avatar=document.createElement("img");avatar.className="game9gsiteheaderavatar";avatar.src="http://game.9g.com/default.png";header.appendChild(this.dom.avatar=avatar);var content=document.createElement("div");content.className="game9gsiteheadercontent";header.appendChild(content);var nickname=document.createElement("div");content.appendChild(this.dom.nickname=nickname);var identity=document.createElement("div");content.appendChild(this.dom.identity=identity);var _this=this;this.game9g.ui.onTap(fav,function(){_this.game9g.ui.showSubscribe({qrcode:"http://game.9g.com/img/qrcode.jpg"})});return this.dom.header=header};Game9GSite.prototype.initNav=function(){var nav=document.createElement("div");nav.className="game9gsitenav";var datas=[{id:"ka",text:"游戏礼包",icon:{on:"http://game.9g.com/images/nav_17_on.png",off:"http://game.9g.com/images/nav_17_off.png"}},{id:"game",text:"更多游戏",icon:{on:"http://game.9g.com/images/nav_14_on.png",off:"http://game.9g.com/images/nav_14_off.png"}},{id:"kf",text:"联系客服",icon:{on:"http://game.9g.com/images/nav_13_on.png",off:"http://game.9g.com/images/nav_13_off.png"}}];for(var i=0;i<datas.length;i++){var data=datas[i];var menu=new Game9GSiteMenu(this.game9g,data);nav.appendChild(menu.dom.menu);this.menus[menu.id]=menu};this.initNavEvent();return this.dom.nav=nav};Game9GSite.prototype.initNavEvent=function(){var _this=this;var setKfBadge=function(unread){if(unread>0){_this.menus.kf.showBadge(unread)}else{_this.menus.kf.clearBadge()}};setKfBadge(this.game9g.chat.unread);this.game9g.addEventListener("newMessage",function(data){setKfBadge(data)})};Game9GSiteMenu=function(game9g,data){this.game9g=game9g;this.id=data.id;this.data=data;this.dom={};var menu=document.createElement("div");menu.className="game9gsitenavmenu";this.dom.menu=menu;var icon=document.createElement("img");icon.className="game9gsitenavmenuicon";icon.src=data.icon.off;menu.appendChild(this.dom.icon=icon);var text=document.createElement("div");text.className="game9gsitenavmenutext";text.innerHTML=data.text;menu.appendChild(this.dom.text=text);var badge=document.createElement("div");badge.className="game9gsitenavmenubadgeclear";menu.appendChild(this.dom.badge=badge);this.initEvent()};Game9GSiteMenu.prototype.initEvent=function(){var _this=this;this.game9g.ui.onTap(this.dom.menu,function(){_this.game9g.site.select(_this.data.id)});this.game9g.addEventListener("siteSelect",function(id){_this.toggle(_this.data.id==id?"on":"off")})};Game9GSiteMenu.prototype.toggle=function(status){this.dom.icon.src=this.data.icon[status];this.dom.text.className="game9gsitenavmenutext"+(status=="on"?" game9gsitenavmenutexton":"")};Game9GSiteMenu.prototype.showBadge=function(value){if(value){this.dom.badge.className="game9gsitenavmenubadgetext";this.dom.badge.innerHTML=value}else{this.dom.badge.className="game9gsitenavmenubadge";this.dom.badge.innerHTML=""}};Game9GSiteMenu.prototype.clearBadge=function(){this.dom.badge.className="game9gsitenavmenubadgeclear";this.dom.badge.innerHTML=""};Game9GSite.prototype.initBody=function(){var body=document.createElement("div");body.className="game9gsitebody";var _this=this;this.game9g.addEventListener("siteSelect",function(id){if(!_this.pages[id]){var page=null;switch(id){case"ka":page=new Game9GSitePageKa();break;case"game":page=new Game9GSitePageGame();break;case"kf":page=new Game9GSitePageKf();break};if(!page)return;page.init(_this.game9g);body.appendChild(page.dom.page);_this.pages[id]=page}});return this.dom.body=body};Game9GSite.prototype.show=function(id){this.dom.site.className="game9gsite showsite";this.dom.mask.style.display="";if(id)this.select(id);this.visible=true;this.game9g.dispatchEvent("siteShow")};Game9GSite.prototype.hide=function(){this.dom.site.className="game9gsite";this.dom.mask.style.display="none";this.visible=false;this.game9g.dispatchEvent("siteHide")};Game9GSite.prototype.resize=function(){this.dom.body.style.height=(window.innerHeight-this.dom.header.offsetHeight-this.dom.nav.offsetHeight)+"px"};Game9GSite.prototype.loadProfile=function(){var _this=this;this.game9g.onUserReady(function(user){_this.dom.avatar.src=_this.game9g.utils.getHead132(user.headimgurl);_this.dom.nickname.innerHTML=user.nickname;_this.dom.identity.innerHTML="ID："+user.uid})};Game9GSite.prototype.showRequireLogin=function(content,callback){var _this=this;this.game9g.utils.confirm(content,function(){callback&&callback.call(null);_this.game9g.auth.check({level:"user"})})};Game9GSitePage=function(){};Game9GSitePage.prototype.init=function(game9g){this.game9g=game9g;this.dom={};var page=document.createElement("div");page.className="game9gsitepage";this.dom.page=page;this.initEvent()};Game9GSitePage.prototype.initEvent=function(){var _this=this;this.game9g.addEventListener("siteSelect",function(id){_this.dom.page.style.display=_this.id==id?"":"none"})};Game9GSitePage.prototype.loading=function(show){if(!this.dom.loading){var loading=document.createElement("img");loading.className="game9gsitepageloading";loading.src="http://game.9g.com/img/loading4.gif";this.dom.page.appendChild(this.dom.loading=loading)};this.dom.loading.style.display=show?"block":"none"};Game9GSitePage.prototype.showTip=function(content){if(!this.dom.tip){var tip=document.createElement("div");tip.className="game9gsitepagetip";this.dom.page.appendChild(this.dom.tip=tip)};this.dom.tip.innerHTML=content};Game9GSitePageKa=function(){};Game9GSitePageKa.prototype=new Game9GSitePage();Game9GSitePageKa.prototype.constructor=Game9GSitePageKa;Game9GSitePageKa.prototype.init=function(game9g){this.id="ka";Game9GSitePage.prototype.init.call(this,game9g);this.dom.page.className+=" game9gsitepageka";var _this=this;this.game9g.onGameReady(function(game){_this.loadGameInfo(game);_this.loadKaList(game.gameid)})};Game9GSitePageKa.prototype.loadGameInfo=function(game){var wrap=document.createElement("div");wrap.className="game9gsitepagekagame";this.dom.page.appendChild(wrap);var icon=document.createElement("img");icon.src=game.gameIcon;wrap.appendChild(icon);var div=document.createElement("div");div.className="game9gsitepagekagamecontent";wrap.appendChild(div);var label=document.createElement("label");label.innerHTML=game.gameName;div.appendChild(label);var p=document.createElement("p");p.innerHTML=game.gameComment||"";div.appendChild(p)};Game9GSitePageKa.prototype.loadKaList=function(gameid){this.loading(true);var _this=this;var url="http://app.9g.com/ka/getpackagelist?gameid="+gameid;this.game9g.utils.ajax(url,function(data){if(!data||!data.list)return;if(data.list.length>0){var ul=document.createElement("ul");_this.dom.page.appendChild(_this.dom.ul=ul);for(var i=0;i<data.list.length;i++){_this.renderKaItem(data.list[i])}}else{_this.showTip("该游戏暂时没有礼包哦。")};_this.loading(false)})};Game9GSitePageKa.prototype.renderKaItem=function(item){var li=document.createElement("li");this.dom.ul.appendChild(li);var cardA=document.createElement("div");cardA.className="game9gsitepagekacard game9gsitepagekacarda";li.appendChild(cardA);var header=document.createElement("div");header.className="game9gsitepagekaheader";cardA.appendChild(header);var icon=document.createElement("img");icon.src="http://game.9g.com/img/gift2.png";header.appendChild(icon);var name=document.createElement("span");name.innerHTML=item.package_name||"";header.appendChild(name);var btnA=document.createElement("a");btnA.className="game9gsitepagekaget";btnA.innerHTML="领号";cardA.appendChild(btnA);if(item.type!="ok")btnA.style.display="none";var content=document.createElement("p");content.className="game9gsitepagekacontent";content.innerHTML="礼包内容："+this.getPackageContent(item);cardA.appendChild(content);var progress=document.createElement("div");progress.className="game9gsitepagekaprogress";cardA.appendChild(progress);var percent=parseInt((item.amount-item.used)*100/item.amount);var span=document.createElement("span");span.innerHTML="剩余"+percent+"%";span.style.width=percent+"%";progress.appendChild(span);var cardB=document.createElement("div");cardB.className="game9gsitepagekacard game9gsitepagekacardb";li.appendChild(cardB);var btnB=document.createElement("a");btnB.className="game9gsitepagekaback";btnB.innerHTML="返回";cardB.appendChild(btnB);var cp=document.createElement("div");cp.className="game9gsitepagekacopy";cp.innerHTML="长按复制或 ";cardB.appendChild(cp);var tip=document.createElement("a");tip.innerHTML="悬浮提示";cp.appendChild(tip);var area=document.createElement("div");area.className="game9gsitepagekaarea";cardB.appendChild(area);var usage=document.createElement("a");usage.className="game9gsitepagekausage";usage.innerHTML="查看使用方法";cardB.appendChild(usage);var cardBReady=false;var _this=this;var renderCardB=function(){var url="http://app.9g.com/ka/getpackagehistory?token="+localStorage.token+"&package_id="+item.id;_this.game9g.utils.ajax(url,function(data){if(data.error)return alert(data.error);cardBReady=true;for(var i=0;i<data.length;i++){if(data[i].id==item.id){var code=document.createElement("span");code.className="game9gsitepagekacode";code.innerHTML=data[i].content;area.appendChild(code);_this.game9g.ui.onTap(tip,function(){if(_this.game9g.ui.ball){_this.game9g.ui.ball.showTip(data[i].content);_this.game9g.site.hide()}});if(data[i].package_desc){_this.game9g.ui.onTap(usage,function(){_this.game9g.utils.alert(data[i].package_desc.intro||"");var dialog=document.getElementById("game9gdialog");dialog.style.top=(window.innerHeight-dialog.offsetHeight)/2+"px";var content=document.getElementsByClassName("game9gdialogcontent")[0];content.style.textAlign="left"})};return}}})};var switchCard=function(card){var w=li.offsetWidth;cardA.style.left=(card=="A"?0:-w)+"px";cardB.style.left=(card=="B"?0:w)+"px";if(card=="B"&&!cardBReady)renderCardB()};this.game9g.ui.onTap(btnA,function(){if(!localStorage.token)return _this.game9g.site.showRequireLogin("登录后才可以领取礼包哦，现在登录？");var url="http://app.9g.com/ka/pickpackage?token="+localStorage.token+"&id="+item.id;_this.game9g.utils.ajax(url,function(data){switchCard("B")})});this.game9g.ui.onTap(btnB,function(){switchCard("A")})};Game9GSitePageKa.prototype.getPackageContent=function(item){if(!item.package_desc)return"";var intro=item.package_desc.intro;if(!intro)return"";var m=intro.match(/\(([^\)]*)\)/i);return m!=null?m[1]:""};Game9GSitePageGame=function(){};Game9GSitePageGame.prototype=new Game9GSitePage();Game9GSitePageGame.prototype.constructor=Game9GSitePageGame;Game9GSitePageGame.prototype.init=function(game9g){this.id="game";Game9GSitePage.prototype.init.call(this,game9g);this.dom.page.className+=" game9gsitepagegame";this.page=1;var ul=document.createElement("ul");this.dom.page.appendChild(this.dom.ul=ul);var _this=this;this.loading(true);var loadGameList=this.game9g.spid&&false?this.loadSpGameList:this.loadGameList;loadGameList.call(this,function(){_this.loading(false)})};Game9GSitePageGame.prototype.loadGameList=function(callback){var _this=this;var url="http://wx.9g.com/app/gamemmo?type=recommend&page="+this.page;this.game9g.utils.ajax(url,function(data){var list=data.list;for(var i=0;i<list.length;i++){_this.dom.ul.appendChild(_this.renderGameItem(list[i]))};callback&&callback.call(null)})};Game9GSitePageGame.prototype.loadSpGameList=function(callback){var _this=this;var url="http://pp.9g.com/game/spgame?spid="+this.game9g.spid;this.game9g.utils.ajax(url,function(data){if(data.length==0)return _this.loadGameList(callback);for(var i=0;i<data.length;i++){_this.dom.ul.appendChild(_this.renderGameItem(data[i]))};callback&&callback.call(null)})};Game9GSitePageGame.prototype.renderGameItem=function(game){var li=document.createElement("li");var icon=document.createElement("img");icon.className="game9gsitepagegameicon";icon.src=game.gameicon;li.appendChild(icon);var div=document.createElement("div");div.className="game9gsitepagegamemain";li.appendChild(div);var name=document.createElement("label");name.innerHTML=game.gamename;div.appendChild(name);var intro=document.createElement("p");intro.innerHTML=game.game_comment;div.appendChild(intro);var _this=this;this.game9g.ui.onClick(li,function(){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid="+game.gameid});return li};Game9GSitePageKf=function(){};Game9GSitePageKf.prototype=new Game9GSitePage();Game9GSitePageKf.prototype.constructor=Game9GSitePageKf;Game9GSitePageKf.prototype.init=function(game9g){this.id="kf";Game9GSitePage.prototype.init.call(this,game9g);this.dom.page.className+=" game9gsitepagekf";this.chat=null;var main=document.createElement("div");main.className="game9gsitepagekfmain";this.dom.page.appendChild(this.dom.main=main);this.loadKfInfo();this.loadConnect();this.loadMessageList()};Game9GSitePageKf.prototype.loadKfInfo=function(){var title=document.createElement("div");title.className="game9gsitepagekftitle";title.innerHTML="关注9G游戏";this.dom.main.appendChild(title);var qrcode=document.createElement("img");qrcode.className="game9gsitepagekfqrcode";qrcode.src="http://game.9g.com/img/qrcode.jpg";this.dom.main.appendChild(qrcode);var tip=document.createElement("div");tip.className="game9gsitepagekftip";tip.innerHTML="长按识别二维码关注";this.dom.main.appendChild(tip);var help=document.createElement("div");help.className="game9gsitepagekfhelp";help.innerHTML="专业客服团队7x24小时为您服务";this.dom.main.appendChild(help)};Game9GSitePageKf.prototype.loadConnect=function(){var connect=document.createElement("a");connect.className="game9gsitepagekfconnect";connect.innerHTML="联系客服";connect.style.display="none";this.dom.main.appendChild(this.dom.connect=connect);var _this=this;this.game9g.ui.onTap(connect,function(){if(!localStorage.token)return _this.game9g.site.showRequireLogin("登录后才可以发送消息，现在登录？");_this.getKfRole(function(role){_this.chatTo(role.role_id)})})};Game9GSitePageKf.prototype.getKfRole=function(callback){var _this=this;var url="http://pp.9g.com/kf/kflist?token="+localStorage.token;this.game9g.utils.ajax(url,function(data){if(data.error)return alert(data.error);var index=_this.game9g.utils.getRandomInt(0,data.length-1);callback&&callback.call(null,data[index])})};Game9GSitePageKf.prototype.toggleMessage=function(visible){this.dom.ul.style.display=visible?"":"none";};Game9GSitePageKf.prototype.loadMessageList=function(){var ul=document.createElement("ul");ul.className="game9gsitepagemessage";this.dom.main.appendChild(this.dom.ul=ul);if(!localStorage.token)return this.toggleMessage(false);var _this=this;this.loading(true);this.refreshMessageList(function(){_this.loading(false)});this.game9g.addEventListener("refreshMessage",function(){if(_this.chat&&_this.chat.visible)return;_this.refreshMessageList()});this.game9g.addEventListener("siteChatHide",function(){_this.refreshMessageList()})};Game9GSitePageKf.prototype.refreshMessageList=function(callback){var _this=this;this.game9g.chat.getMessageList(this.game9g.roleid,function(data){if(data.length>0){_this.toggleMessage(true);_this.renderMessageList(data)}else{_this.toggleMessage(false)};callback&&callback.call(null)})};Game9GSitePageKf.prototype.renderMessageList=function(list){this.dom.ul.innerHTML="";for(var i=0;i<list.length;i++){var msg=list[i];var li=document.createElement("li");this.dom.ul.appendChild(li);var head=document.createElement("img");head.className="game9gsitepagemessagehead";head.src=this.game9g.utils.getHead132(msg.headimgurl);li.appendChild(head);var div=document.createElement("div");div.className="game9gsitepagemessagemain";li.appendChild(div);var name=document.createElement("label");name.innerHTML=msg.nickname;div.appendChild(name);var p=document.createElement("p");p.innerHTML=this.game9g.chat.parse(msg);div.appendChild(p);var time=document.createElement("div");time.className="game9gsitepagemessagetime";time.innerHTML=this.game9g.utils.formatTime(msg.ctime);li.appendChild(time);if(msg.unread>0){var badge=document.createElement("div");badge.className="game9gsitepagemessagebadge";badge.innerHTML=msg.unread;li.appendChild(badge)};var _this=this;(function(li,msg){_this.game9g.ui.onClick(li,function(){_this.chatTo(msg.talker)})})(li,msg)}};Game9GSitePageKf.prototype.chatTo=function(talkerid){if(!this.chat){var chat=new Game9GSiteChat(this.game9g);this.dom.page.appendChild(chat.dom.wrap);chat.resize();setTimeout(function(){chat.show()},100);this.chat=chat}else{this.chat.show()};this.chat.initData(talkerid)};Game9GSiteChat=function(game9g){this.game9g=game9g;this.dom={};this.role={};this.talker={};this.previousId=0;this.pageSize=20;this.sending=false;this.busy=false;this.nomore=false;this.visible=false;var wrap=document.createElement("div");wrap.className="game9gsitechat";this.dom.wrap=wrap;this.initTitleBar();this.initChat();this.initEvent()};Game9GSiteChat.prototype.initTitleBar=function(){var titlebar=document.createElement("div");titlebar.className="game9gsitechattitlebar";this.dom.wrap.appendChild(this.dom.titlebar=titlebar);var title=document.createElement("div");title.className="game9gsitechattitle";titlebar.appendChild(this.dom.title=title);var back=document.createElement("a");back.className="game9gsitechatback";back.innerHTML="〈 返回";titlebar.appendChild(this.dom.back=back)};Game9GSiteChat.prototype.initChat=function(){var chatbar=document.createElement("div");chatbar.className="game9gsitechatchatbar";this.dom.wrap.appendChild(this.dom.chatbar=chatbar);var image=document.createElement("img");image.className="game9gsitechatimage"+(this.game9g.utils.getAppType()=="wx"?"":" pc");image.src="http://game.9g.com/img/camaraimage.png";chatbar.appendChild(this.dom.image=image);var text=document.createElement("input");text.className="game9gsitechattext"+(this.game9g.utils.getAppType()=="wx"?"":" pc");text.placeholder="在此输入聊天内容";chatbar.appendChild(this.dom.text=text);var send=document.createElement("a");send.className="game9gsitechatsend";send.innerHTML="发送";chatbar.appendChild(this.dom.send=send);var list=document.createElement("ul");list.className="game9gsitechatlist";this.dom.wrap.appendChild(this.dom.list=list)};Game9GSiteChat.prototype.initData=function(talkerid){this.role={};this.talker={};this.previousId=0;this.sending=false;this.busy=true;this.nomore=false;this.dom.title.innerHTML="";this.dom.text.value="";this.dom.list.innerHTML="";var _this=this;this.game9g.getRoles([this.game9g.roleid,talkerid],function(data){for(var i=0;i<data.length;i++){if(data[i].role_id==_this.game9g.roleid)_this.role=data[i];if(data[i].role_id==talkerid)_this.talker=data[i]};_this.dom.title.innerHTML=_this.talker.nickname;_this.loadMessageList();_this.sendRead()})};Game9GSiteChat.prototype.loadMessageList=function(previous){this.busy=true;var options={roleid:this.role.role_id,talker:this.talker.role_id};if(previous){options.id=this.previousId};var _this=this;this.game9g.chat.getMessageListByTalker(options,function(data){var count=data.length;if(count<_this.pageSize)_this.nomore=true;if(count==0)return;if(previous){for(var i=count-1;i>=0;i--){_this.addMessage(data[i],true)}}else{for(var i=0;i<count;i++){_this.addMessage(data[i])}};_this.previousId=data[0].id;_this.busy=false})};Game9GSiteChat.prototype.loadMoreMessage=function(){this.loadMessageList(true)};Game9GSiteChat.prototype.initEvent=function(){var _this=this;this.game9g.ui.onTap(this.dom.back,function(){_this.hide()});this.game9g.ui.onTap(this.dom.image,function(){_this.sendImage()});this.dom.text.addEventListener("keydown",function(e){if(e.keyCode==13)_this.sendText()});this.game9g.ui.onTap(this.dom.send,function(){_this.sendText()});this.game9g.on("siteShow siteHide siteChatShow siteChatHide",function(){_this.resetCheckTime()});this.game9g.addEventListener("siteShow",function(){if(_this.visible){_this.initData(_this.talker.role_id)}});this.game9g.addEventListener("newMessage",function(data){if(!_this.game9g.site.visible||!_this.visible)return;_this.game9g.chat.getNewMessage(function(list){var hasTalkerMessage=false;for(var i=0;i<list.length;i++){var msg=list[i];if(msg.talker==_this.talker.role_id){_this.addMessage(msg);hasTalkerMessage=true}};if(hasTalkerMessage)_this.sendRead()})});this.dom.list.addEventListener("scroll",function(e){if(_this.busy||_this.nomore)return;if(this.scrollHeight-this.scrollTop-this.offsetHeight<100){_this.loadMoreMessage()}})};Game9GSiteChat.prototype.show=function(){this.dom.wrap.style.left=0;this.visible=true;this.game9g.dispatchEvent("siteChatShow")};Game9GSiteChat.prototype.hide=function(){this.dom.wrap.style.left=this.dom.wrap.offsetWidth+"px";this.visible=false;this.game9g.dispatchEvent("siteChatHide")};Game9GSiteChat.prototype.resize=function(){this.dom.list.style.height=(this.dom.wrap.offsetHeight-this.dom.titlebar.offsetHeight-this.dom.chatbar.offsetHeight)+"px"};Game9GSiteChat.prototype.resetCheckTime=function(){if(this.game9g.site&&this.game9g.site.visible&&this.visible){this.game9g.chat.resetCheckNewMessageTimer(5)}else{this.game9g.chat.resetCheckNewMessageTimer()}};Game9GSiteChat.prototype.sendRead=function(){this.game9g.chat.sendRead(this.role.role_id,this.talker.role_id)};Game9GSiteChat.prototype.sendText=function(){if(this.sending)return;var content=this.dom.text.value;if(content=="")return this.game9g.utils.alert("请输入聊天内容。");this.sending=true;this.dom.send.className="game9gsitechatsend disabled";var _this=this;this.game9g.chat.sendText(this.role.role_id,this.talker.role_id,content,function(){_this.dom.text.value="";_this.dom.text.placeholder="";_this.dom.send.className="game9gsitechatsend";_this.sending=false;_this.addMessage({turn:1,type:1,content:content,ctime:_this.game9g.utils.now()})},function(){_this.dom.send.className="game9gsitechatsend";_this.sending=false;alert("发送失败")})};Game9GSiteChat.prototype.sendImage=function(){if(this.game9g.utils.getAppType()!="wx")return alert("此功能仅在微信内使用");var _this=this;this.game9g.app.chooseImages(function(localIds){_this.game9g.app.uploadImages(localIds,function(serverIds){_this.game9g.app.getMediaUrls(serverIds,function(data){for(var i=0;i<data.length;i++){var media=data[i];(function(media){_this.game9g.chat.sendImage(_this.role.role_id,_this.talker.role_id,media.url,function(){_this.addMessage({turn:1,type:2,content:{url:media.url},ctime:_this.game9g.utils.now()})})})(media)}})})})};Game9GSiteChat.prototype.addMessage=function(msg,previous){if(previous){this.dom.list.appendChild(this.render(msg))}else{this.dom.list.insertBefore(this.render(msg),this.dom.list.childNodes[0]);this.dom.list.scrollTop=0}};Game9GSiteChat.prototype.render=function(msg){var li=document.createElement("li");var time=document.createElement("div");time.className="game9gsitechattime";time.innerHTML=this.game9g.utils.formatTime(msg.ctime);li.appendChild(time);var item=document.createElement("div");item.className="game9gsitechatitem"+(msg.turn==1?" right":" left");li.appendChild(item);var head=document.createElement("img");head.className="game9gsitechathead";head.src=this.game9g.utils.getHead132(msg.turn==1?this.role.headimgurl:this.talker.headimgurl);item.appendChild(head);var box=document.createElement("div");box.className="game9gsitechatbox";item.appendChild(box);switch(msg.type){case 1:this.renderText(box,msg);break;case 2:this.renderImage(box,msg);break;default:this.renderText(box,msg);break;};return li};Game9GSiteChat.prototype.renderText=function(box,msg){var bubble=document.createElement("div");bubble.className="bubble";bubble.innerHTML=this.game9g.chat.parseEmoji(this.game9g.utils.htmlFilter(msg.content));box.appendChild(bubble)};Game9GSiteChat.prototype.renderImage=function(box,msg){var img=document.createElement("img");img.className="image";img.src=msg.content.url;var _this=this;this.game9g.ui.onClick(img,function(){_this.game9g.ui.showFullScreenImage(img.src)});box.appendChild(img)};Game9GPK=function(game9g){this.game9g=game9g;this.Status={OFFLINE:0,ONLINE:1,FREE:2,OK:3,READY:4,ALL_READY:5,PLAY:6,END:7};this.gameid=(this.game9g.gameid!=null&&this.game9g.gameid!="pk"?this.game9g.gameid:null);this.roomid=this.game9g.roomid;this.logid=this.game9g.logid;this.room_id=null;this.room_game=null;this.isPkOffline=false;this.isCreateRoom=(this.game9g.action=="create_pk_room");this.isPublic=false;this.loadPublicRoom();this.isPrivate=(this.roomid?true:false);this.isInvite=(this.game9g.fromid?true:false);this.owner=0;this.status=this.Status.OFFLINE;this.gametime=0;this.emojis=null;this.games=[];this.randPlayers=null;this.isRecommendNotice=false;this.players=[];this.isAssignGame=false;this.isTargetJump=false;this.isPlayerQuit=false;this.ani=new Game9GPKAni(game9g);this.ui=new Game9GPKUI(game9g);this.io=new Game9GPKIO(game9g,this.ui);this.io.socketOpen()};Game9GPK.prototype.gotoPrivateRoom=function(gameid,delay){var _this=this;var redirect=function(){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid="+gameid+"&roomid="+_this.roomid};if(delay){setTimeout(redirect,2000)}else{redirect()}};Game9GPK.prototype.gotoPublicRoom=function(gameid,roomid,delay){sessionStorage.roomid=roomid;var _this=this;var redirect=function(){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid="+gameid};if(delay){setTimeout(redirect,2000)}else{redirect()}};Game9GPK.prototype.loadPublicRoom=function(){if(this.gameid&&!this.roomid&&sessionStorage.roomid){this.room_id=sessionStorage.roomid;this.isPublic=true};sessionStorage.removeItem("roomid")};Game9GPK.prototype.onReady=function(){if(!this.emojis)this.io.doGameEmojiList();if(!this.randPlayers)this.io.doGameRandPlayers();this.ui.showMask();var _this=this;setTimeout(function(){if(_this.logid){_this.joinOffline()}else if(_this.isPrivate){_this.joinPrivate()}else if(_this.isPublic){_this.joinPublic()}else if(_this.isCreateRoom){_this.createRoom()}else{_this.match()}},200)};Game9GPK.prototype.match=function(){this.status=this.Status.FREE;this.ui.showMatch();this.io.doGameMatch();if(this.game9g.isTest())return;var _this=this;setTimeout(function(){if(_this.status==_this.Status.FREE){if(_this.gameid){if(!_this.isRecommendNotice){_this.matchRecommend()}}else{_this.matchPlayerOffline()}}},8000)};Game9GPK.prototype.rematch=function(){this.roomid=null;this.isPublic=false;this.isPrivate=false;this.ui.showTip("重新匹配..");var _this=this;setTimeout(function(){_this.match()},500)};Game9GPK.prototype.onMatchPlayer=function(player){this.isPlayerQuit=false;this.game9g.dispatchEvent("pkMatchPlayer",player);this.ui.selectPlayer(player);var _this=this;this.game9g.on("pkGameRoomOK",function(){var timer=setTimeout(function(){if(!_this.gameid&&_this.getTargetPlayer().gameid){_this.gotoPublicRoom(_this.getTargetPlayer().gameid,_this.room_id,false)}else{_this.showRoom()}},6000);_this.game9g.on("pkPlayerQuit",function(){clearTimeout(timer)},true)},true)};Game9GPK.prototype.matchRecommend=function(){this.ui.showTip("正在匹配..",null,true);this.io.doGameMatchRecommend()};Game9GPK.prototype.onMatchRecommend=function(player,game){var _this=this;var ok=function(){_this.io.doGameMatchRecommendOK(player.role_id,game.gameid)};var cancel=function(){_this.io.doGameMatchIgnore(player.role_id);setTimeout(function(){if(_this.status==_this.Status.FREE){_this.io.doGameMatchRecommend()}},3000)};this.ui.showMatchRecommend(player,game,ok,cancel)};Game9GPK.prototype.onMatchRecommendFail=function(){var _this=this;setTimeout(function(){if(_this.status==_this.Status.FREE){_this.matchOffline()}},2000)};Game9GPK.prototype.onMatchRecommendOK=function(roleid,gameid){window.location=this.game9g.baseurl+"/gamecenter.html?gameid="+gameid};Game9GPK.prototype.onMatchRecommendNotice=function(player){this.isRecommendNotice=true;this.ui.hideMatchRecommend();var _this=this;setTimeout(function(){_this.isRecommendNotice=false;if(_this.status==_this.Status.FREE){_this.match()}},10000)};Game9GPK.prototype.matchOffline=function(){this.ui.showTip("正在匹配...",null,true);var _this=this;setTimeout(function(){_this.io.doGameMatchOffline()},500)};Game9GPK.prototype.matchPlayerOffline=function(){this.io.doGameMatchCancel();var player=this.ui.selectNextPlayer();console.log("离线匹配指定玩家："+player.nickname);var _this=this;setTimeout(function(){_this.io.doGameMatchPlayerOffline(player.role_id)},6000)};Game9GPK.prototype.onGameMatchPlayerOffline=function(roleid,gameid,logid){console.log("logid = "+logid);window.location=this.game9g.baseurl+"/gamecenter.html?gameid="+gameid+"&logid="+logid};Game9GPK.prototype.createRoom=function(){if(this.isPrivate&&this.owner==this.game9g.roleid){console.log("已是房主，重新加入");this.quitRoom();this.io.doGameJoinPrivate()}else{console.log("非房主，创建私人房间");if(this.room_id)this.quitRoom();this.io.doGameRoomCreate()}};Game9GPK.prototype.onGameRoomCreate=function(roomid,owner){console.log("创建私人房间：room_id = "+roomid+", owner = "+owner);this.roomid=roomid;this.isPrivate=true;this.owner=owner;this.io.doGameJoinPrivate()};Game9GPK.prototype.joinPrivate=function(){this.status=this.Status.ONLINE;this.ui.showTip("进入私人房间");var _this=this;setTimeout(function(){_this.io.doGameJoinPrivate()},500)};Game9GPK.prototype.onJoinPrivate=function(status){this.status=this.Status.OK;this.ui.hideTip();if(status==1){this.showRoom()}else{var _this=this;if(this.roomid!=this.game9g.roomid){this.ui.showGameRoomCreate();this.ui.showButton("通知朋友",false,function(){_this.ui.showGameShare(function(){_this.ui.showMyGameRoomWait()})});this.game9g.on("pkGameRoomOK",function(){_this.ui.hideGameRoomCreate()},true)}else{if(this.owner==this.game9g.roleid){if(this.isInvite){this.ui.showGameRoomCreate();this.ui.showButton("通知朋友",false,function(){_this.ui.showGameShare(function(){_this.ui.showMyGameRoomWait()})});this.game9g.on("pkGameRoomOK",function(){_this.ui.hideGameRoomCreate()},true)}else{this.ui.showMyGameRoomWait()}}else{var wait=function(){_this.ui.showWaitPeople("等待对应响应",30,function(){_this.ui.setProgressText("对方没响应");_this.ui.showButtons([{text:"催催Ta",click:function(){_this.io.doGamePkNotice();_this.ui.clearButton();wait();_this.ui.setProgressText("已发出通知,请等待")}},{text:"和别人玩",click:function(){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid=pk"}}])})};wait();this.io.doGamePkNotice()}};this.game9g.on("pkGameRoomOK",function(){_this.showRoom()},true)}};Game9GPK.prototype.onJoinPrivateFail=function(result){if(result==0){this.ui.showTip("房间人已满")}else{this.ui.showTip("房间已关闭")}};Game9GPK.prototype.joinPublic=function(){this.status=this.Status.ONLINE;this.io.doGameJoinPublic()};Game9GPK.prototype.onJoinPublic=function(status){this.status=this.Status.OK;if(status==1){this.showRoom()}else{var _this=this;var wait=function(){_this.ui.showWaitPeople("请稍候",30,function(){_this.ui.setProgressText("对手没响应");_this.ui.showButtons([{text:"再等等",click:function(){_this.ui.clearButton();wait()}},{text:"和别人玩",click:function(){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid=pk"}}])})};wait();this.game9g.on("pkGameRoomOK",function(){_this.showRoom()},true)}};Game9GPK.prototype.joinOffline=function(){this.status=this.Status.ONLINE;this.io.doGameJoinOffline(this.logid)};Game9GPK.prototype.onJoinOffline=function(roomid){this.status=this.Status.OK;this.showRoom()};Game9GPK.prototype.onGameAllList=function(list){this.games=list;this.game9g.dispatchEvent("pkGameAllList")};Game9GPK.prototype.onGameRandList=function(list){this.games=list};Game9GPK.prototype.showGameRandList=function(){this.ui.showGameRandList();this.ui.scrollGame();var _this=this;this.ui.showWait("选择游戏",5,function(){_this.io.doGameAssignTimeout()});this.game9g.on("pkAssignGame",function(game){_this.ui.hideWait();_this.ui.selectGame(game.gameid)},true);this.game9g.on("pkPlayerQuit",function(){_this.ui.hideWait();_this.ui.hideGameRandList()},true)};Game9GPK.prototype.onGameRandPlayers=function(players){this.randPlayers=players;this.game9g.dispatchEvent("pkGameRandPlayers",players)};Game9GPK.prototype.onGameRoom=function(json){console.log("房间信息：\ngame = "+(json.game?json.game.gamename:"null")+", totalTime = "+json.totalTime+", status = "+json.status);this.game9g.dispatchEvent("pkGameRoom",json.status);this.room_id=json.room_id;this.room_game=json.game||null;this.isPkOffline=json.offline;this.status=this.Status.OK;this.owner=json.owner;this.gametime=json.totalTime};Game9GPK.prototype.onGameRoomOK=function(status){console.log("房间人齐了！");this.game9g.dispatchEvent("pkGameRoomOK",status)};Game9GPK.prototype.onGamePlayers=function(players){this.setPlayers(players);console.log("房间内玩家：");for(var i=0;i<players.length;i++){var player=players[i];console.log("role_id = "+player.role_id+", nickname = "+player.nickname)}};Game9GPK.prototype.onGameJoin=function(player,status){console.log("玩家加入："+player.nickname);this.addPlayer(player)};Game9GPK.prototype.onGameQuit=function(player){if(player.role_id==this.game9g.roleid){this.room_id=null;this.room_game=null;this.status=this.Status.ONLINE;this.owner=0;this.gametime=0;this.game9g.dispatchEvent("pkHeroQuit")}else{console.log("玩家退出");this.isPlayerQuit=true;this.onPlayerQuit(player)}};Game9GPK.prototype.onPlayerQuit=function(player){if(this.status==this.Status.ALL_READY||this.status==this.Status.PLAY||this.status==this.Status.END||this.isAssignGame||this.isTargetJump)return;this.removePlayer(player);this.game9g.dispatchEvent("pkPlayerQuit");this.ui.showTip(player.nickname+"离开房间");var _this=this;setTimeout(function(){_this.quitRoom();_this.rematch()},500)};Game9GPK.prototype.showRoom=function(){console.log("显示房间");this.game9g.dispatchEvent("pkShowRoom");this.ui.showRoom();this.ui.showEmojiPanel();var _this=this;if(this.gameid){if(this.getTargetPlayer().gameid){this.ui.showProgress("即将开始",5,function(){_this.showGame()})}else{this.isTargetJump=true;this.ui.hideEmojiPanel();var wait=function(){_this.ui.showProgress("等待对手",10,function(){_this.ui.setProgressText("对手没响应");_this.ui.showButtons([{text:"再等等",click:function(){_this.ui.clearButton();wait()}},{text:"和别人玩",click:function(){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid=pk"}}])})};wait();this.game9g.on("pkGameRoomOK",function(){_this.isTargetJump=false;_this.ui.showEmojiPanel();_this.ui.showProgress("即将开始",5,function(){_this.showGame()})},true)}}else if(this.room_game){this.ui.showTip("进入游戏",null,false);this.gotoPublicRoom(this.room_game.gameid,this.room_id,false)}else{this.showGameRandList()}};Game9GPK.prototype.showGame=function(isReady){console.log("显示游戏");this.game9g.dispatchEvent("pkShowGame");this.ui.showGame();this.ui.showGameIntro();this.ready();};Game9GPK.prototype.assignGame=function(gameid){this.io.doGameAssign(gameid)};Game9GPK.prototype.onAssignGame=function(roleid,game){console.log((roleid==0?"系统":"玩家 "+roleid)+" 指定了游戏 "+game.gamename);this.isAssignGame=true;this.game9g.dispatchEvent("pkAssignGame",game);if(this.isPrivate){this.gotoPrivateRoom(game.gameid,true)}else{var roomid=this.room_id.replace("public",game.gameid);this.gotoPublicRoom(game.gameid,roomid,true)}};Game9GPK.prototype.ready=function(){this.io.doGameReady();this.status=this.Status.READY};Game9GPK.prototype.onGameReady=function(players){console.log("各玩家 Ready 状态：");for(var i=0;i<players.length;i++){var player=players[i];console.log("role_id = "+player.role_id+": "+(player.ready?"ready":"waiting"))}};Game9GPK.prototype.onGameAllReady=function(status){console.log("所有人 Ready");this.status=this.Status.ALL_READY;this.game9g.dispatchEvent("pkGameAllReady")};Game9GPK.prototype.gameStart=function(){console.log("游戏开始");this.game9g.dispatchEvent("pkGameStart");this.status=this.Status.PLAY;if(this.game9g.options.start){var result=this.game9g.options.start.call(null);console.log("game start: result = "+result)}};Game9GPK.prototype.progress=function(data){this.io.doGameSubmit(data)};Game9GPK.prototype.finish=function(data){if(this.status==this.Status.PLAY){this.io.doGameSubmit(data);var result=this.game9g.options.restart.call(null);console.log("game restart: "+result)}};Game9GPK.prototype.gameOver=function(status){console.log("游戏结束");this.status=this.Status.END;var result=this.game9g.options.gameover.call(null);console.log("game over: result = "+result);this.ui.showGameOver()};Game9GPK.prototype.onGameResult=function(json){console.log("成绩：");for(var i=0;i<json.result.length;i++){var player=json.result[i];console.log("role_id = "+player.role_id+", score = "+player.score)};console.log("winner = "+json.winner);this.game9g.dispatchEvent("pkGameResult");this.ui.showResult(json);this.ui.showEmojiPanel();var _this=this;if(this.game9g.chat){this.game9g.chat.resetCheckNewMessageTimer(5);this.game9g.on("pkGameReplay pkHeroQuit",function(){_this.game9g.chat.resetCheckNewMessageTimer()})}};Game9GPK.prototype.gameReplay=function(){this.game9g.dispatchEvent("pkGameReplay");this.io.doGameReplay()};Game9GPK.prototype.onGameReplay=function(json){console.log("再玩一次：id = "+json.room_id+", game = "+json.game.gamename+", 玩家 = "+json.players+", status = "+json.status+", offline = "+json.offline);var _this=this;if(json.offline){this.quitRoom();this.rematch()}else if(json.status==1){this.ui.showGame();this.ui.refreshGameTime(json.totalTime);this.ui.resetAllPlayers();this.ready();this.ui.showTip("等待对手准备",null,true);this.game9g.on("pkGameAllReady",function(){_this.ui.showGameIntro()})}else{this.quitRoom();this.rematch()}};Game9GPK.prototype.gamePlayNew=function(){this.io.doGameAllList();var _this=this;this.game9g.on("pkGameAllList",function(){_this.ui.showGameAllList(function(game){_this.io.doGameReplayRequest(game.gameid)})},true)};Game9GPK.prototype.gameReplayRequest=function(gameid){if(gameid){this.io.doGameReplayRequest(gameid)}else{this.io.doGameReplayRequest()}};Game9GPK.prototype.onGameReplayRequest=function(player,game){var _this=this;if(player.role_id==this.game9g.roleid){if(this.isPkOffline||this.isPlayerQuit){if(!game){this.ui.showTip("对手已经离开房间");setTimeout(function(){_this.quitRoom();_this.rematch()},500)}else{window.location=this.game9g.baseurl+"/gamecenter.html?gameid="+game.gameid}}else{if(!game)this.status=this.Status.READY;this.game9g.utils.dialog({title:(game?"一起玩"+game.gamename:"再玩一次"),content:"正在等待对手回应...",buttonCancel:{click:function(){_this.io.doGameReplayRequestCancel()}}})}}else{this.game9g.utils.dialog({content:player.nickname+(game?"想和你一起玩"+game.gamename:"想要再玩一次"),buttonOK:{label:"同意",click:function(){_this.io.doGameReplayResponse(1,game?game.gameid:null)}},buttonCancel:{label:"拒绝",click:function(){_this.io.doGameReplayResponse(-1,game?game.gameid:null)}}})}};Game9GPK.prototype.onGameReplayRequestCancel=function(player){if(player.role_id==this.game9g.roleid){this.status=this.Status.END}else{this.game9g.utils.closeDialog();this.game9g.utils.tip(player.nickname+"取消了再玩一次请求")}};Game9GPK.prototype.onGameReplayResponse=function(player,response,game){if(player.role_id==this.game9g.roleid){if(response==1){if(!game)this.status=this.Status.READY;this.onGameReplayReady(game);if(game){this.game9g.utils.tip("即将进入游戏..")}}}else{if(response==1){this.game9g.utils.closeDialog();this.onGameReplayReady(game);if(game){this.game9g.utils.tip(player.nickname+"已同意，即将进入游戏..")}}else{this.status=this.Status.END;this.game9g.utils.closeDialog();this.game9g.utils.tip(player.nickname+"拒绝了再玩一次请求")}}};Game9GPK.prototype.onGameReplayReady=function(game){if(game){}else{this.game9g.dispatchEvent("pkGameReplay");this.ui.showGame();this.ui.resetAllPlayers();var _this=this;this.game9g.on("pkGameAllReady",function(){_this.ui.showGameIntro()})}};Game9GPK.prototype.onReAssignGame=function(gameid){if(this.isPrivate){this.gotoPrivateRoom(gameid)}else{var roomid=this.room_id;if(this.room_id.indexOf("public_")!=-1){roomid=this.room_id.replace("public",gameid)}else if(this.room_game){roomid=this.room_id.replace(this.room_game.gameid,gameid)}else{roomid=gameid+"_"+this.game9g.utils.getRandomString(10)};this.gotoPublicRoom(gameid,roomid,false)}};Game9GPK.prototype.quitRoom=function(){this.ui.hideRoom();this.io.doGameQuit()};Game9GPK.prototype.setPlayers=function(players){this.players=players;for(var i=0;i<this.players.length;i++){var player=this.players[i];player.score=player.score||0;player.best=player.best||0}};Game9GPK.prototype.addPlayer=function(player){player.score=player.score||0;player.best=player.best||0;this.players.push(player)};Game9GPK.prototype.removePlayer=function(player){for(var i=0;i<this.players.length;i++){if(this.players[i].role_id==player.role_id){this.players.splice(i,1)}}};Game9GPK.prototype.getPlayer=function(roleid){for(var i=0;i<this.players.length;i++){if(this.players[i].role_id==roleid)return this.players[i]};return null};Game9GPK.prototype.getTargetPlayer=function(){for(var i=0;i<this.players.length;i++){if(this.players[i].role_id!=this.game9g.roleid)return this.players[i]};return null};Game9GPK.prototype.hasPlayer=function(player){for(var i=0;i<this.players.length;i++){if(this.players[i].role_id=player.role_id)return true};return false};Game9GPK.prototype.refreshScore=function(roleid,score,best){for(var i=0;i<this.players.length;i++){var player=this.players[i];if(player.role_id==roleid){player.score=score;player.best=best;this.ui.refreshScore(player);return}}};Game9GPK.prototype.parseSnapshoot=function(list){console.log("接收游戏快照："+list.length+"个");this.ani.reset();for(var i=0;i<list.length;i++){this.ani.add(list[i])};this.ani.start()};Game9GPK.prototype.chat=function(role){if(this.game9g.utils.getAppType()=="9g"||this.game9g.utils.getAppType()=="pengpeng"){this.game9g.app.chat(role.role_id)}else{if(this.game9g.chat){this.game9g.chat.ui.chatTo(role)}else{window.location=this.game9g.baseurl+"/app/chat.html?talker="+role.role_id+"&r="+Math.random()}}};Game9GPKAni=function(game9g){this.game9g=game9g;this.reset()};Game9GPKAni.prototype.reset=function(){this.movies=[];this.active=false;this.time=0;};Game9GPKAni.prototype.add=function(json){var movie={index:0,player:json.player,steps:json.data,finish:false};this.movies.push(movie)};Game9GPKAni.prototype.start=function(){console.log("开始播放：游戏步骤");this.active=true;var begin=new Date().getTime();var _this=this;requestAnimationFrame(function(){_this.time=new Date().getTime()-begin;_this.run();if(_this.active){requestAnimationFrame(arguments.callee)}else{console.log("播放结束")}})};Game9GPKAni.prototype.run=function(){var hasMore=false;for(var i=0;i<this.movies.length;i++){var movie=this.movies[i];if(movie.steps.length==0)movie.finish=true;if(movie.finish)continue;while(!movie.finish){var step=movie.steps[movie.index];if(step.time>this.time){hasMore=true;break};this.execute(movie.player,step);movie.index++;if(movie.index==movie.steps.length){movie.finish=true;console.log("movie: "+i+" finish!")}}};if(!hasMore)this.active=false};Game9GPKAni.prototype.execute=function(player,step){console.log("执行步骤："+player.nickname+", "+JSON.stringify(step));this.game9g.pk.refreshScore(player.role_id,step.score,step.best)};Game9GPKUI=function(game9g){this.game9g=game9g;this.countDownTimer=null;this.game9g.utils.require("http://game.9g.com/js/move.min.js");var _this=this;this.game9g.on("pkMatchPlayer",function(){_this.hideMatchRecommend()});this.game9g.on("pkShowRoom",function(){_this.hideMatch();_this.hideWaitPeople();_this.clearButton()});this.game9g.on("pkShowGame",function(){_this.hideRoom();_this.hideProgress();_this.hideEmojiPanel()});this.game9g.on("pkGameAllReady",function(){_this.hideTip();_this.hideEmojiPanel()});this.game9g.on("pkGameStart",function(){_this.hideTip();_this.hideGameIntro();_this.hideEmojiPanel();_this.hideMask()});this.game9g.on("pkGameResult",function(){_this.hideGame();_this.hideGameOver()});this.game9g.on("pkGameReplay",function(){_this.hideResult()});this.game9g.on("pkHeroQuit",function(){_this.hideRoom();_this.hideGame();_this.hideGameIntro();_this.hideEmojiPanel();_this.hideResult();_this.hideProgress()});this.game9g.on("pkPlayerQuit",function(){_this.hideRoom();_this.hideGame();_this.hideGameIntro();_this.hideEmojiPanel();_this.hideProgress();_this.removeRole("game9gpkrole_target")})};Game9GPKUI.prototype.showMask=function(){var mask=document.getElementById("game9gpkmask");if(!mask){mask=document.createElement("div");mask.id="game9gpkmask";mask.className="game9gpkmask";document.getElementsByTagName("body")[0].appendChild(mask)};mask.style.display=""};Game9GPKUI.prototype.hideMask=function(){var mask=document.getElementById("game9gpkmask");if(mask)mask.style.display="none"};Game9GPKUI.prototype.showButton=function(text,remove,callback){var btn=document.createElement("a");btn.className="game9gpkbtn";document.getElementsByTagName("body")[0].appendChild(btn);btn.innerHTML=text;btn.addEventListener("touchstart",function(e){if(remove)document.getElementsByTagName("body")[0].removeChild(btn);callback&&callback.call(null);e.preventDefault()})};Game9GPKUI.prototype.showButtons=function(btns){var size=btns.length;for(var i=0;i<size;i++){var text=btns[i].text;var callback=btns[i].click;var btn=document.createElement("a");btn.className="game9gpkbtn";btn.style.bottom=(this.game9g.utils.vh2px(10)+this.game9g.utils.vw2px((size-i-1)*17))+"px";document.getElementsByTagName("body")[0].appendChild(btn);btn.innerHTML=text;(function(btn,callback){btn.addEventListener("touchstart",function(e){callback&&callback.call(null);e.preventDefault()})})(btn,callback)}};Game9GPKUI.prototype.clearButton=function(){var btns=document.querySelectorAll(".game9gpkbtn");for(var i=btns.length-1;i>=0;i--){var btn=btns[i];btn.parentElement.removeChild(btn)}};Game9GPKUI.prototype.showCountDown=function(second,callback){this.showTip(second);if(second==0){callback&&callback.call(null);return};var _this=this;this.countDownTimer=setTimeout(function(){_this.showCountDown(--second,callback)},1000)};Game9GPKUI.prototype.showCountDownClock=function(second,callback){this.showGameTime(second);if(second==0){callback&&callback.call(null);return};var _this=this;this.countDownTimer=setTimeout(function(){_this.showCountDownClock(--second,callback)},1000)};Game9GPKUI.prototype.clearCountDown=function(){clearTimeout(this.countDownTimer)};Game9GPKUI.prototype.showProgress=function(content,second,callback){this.hideProgress();var div=document.createElement("div");div.id="game9gpkprogress";div.className="game9gpkprogress";document.getElementsByTagName("body")[0].appendChild(div);var rightwrap=document.createElement("div");rightwrap.className="game9gpkprogresswrap rightprogress";div.appendChild(rightwrap);var rightcircle=document.createElement("div");rightcircle.className="game9gpkprogresscircle rightcircle";rightwrap.appendChild(rightcircle);var leftwrap=document.createElement("div");leftwrap.className="game9gpkprogresswrap leftprogress";div.appendChild(leftwrap);var leftcircle=document.createElement("div");leftcircle.className="game9gpkprogresscircle leftcircle";leftwrap.appendChild(leftcircle);var text=document.createElement("div");text.id="game9gpkprogresstext";text.className="game9gpkprogresstext";text.innerHTML=content;div.appendChild(text);rightcircle.style.webkitAnimation="circleloadright "+second+"s linear";rightcircle.style.webkitAnimationFillMode="forwards";rightcircle.style.animation="circleloadright "+second+"s linear";rightcircle.style.animationFillMode="forwards";leftcircle.style.animation="circleloadleft "+second+"s linear";leftcircle.style.animationFillMode="forwards";leftcircle.style.webkitAnimation="circleloadleft "+second+"s linear";leftcircle.style.webkitAnimationFillMode="forwards";leftcircle.addEventListener("animationend",callback);leftcircle.addEventListener("webkitAnimationEnd",callback)};Game9GPKUI.prototype.hideProgress=function(){var div=document.getElementById("game9gpkprogress");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.showWait=function(content,second,callback){this.hideWait();var div=document.createElement("div");div.id="game9gpkwait";div.className="game9gpkwait";document.getElementsByTagName("body")[0].appendChild(div);var rightwrap=document.createElement("div");rightwrap.className="game9gpkwaitwrap rightwait";div.appendChild(rightwrap);var rightcircle=document.createElement("div");rightcircle.className="game9gpkwaitcircle rightcircle";rightwrap.appendChild(rightcircle);var leftwrap=document.createElement("div");leftwrap.className="game9gpkwaitwrap leftwait";div.appendChild(leftwrap);var leftcircle=document.createElement("div");leftcircle.className="game9gpkwaitcircle leftcircle";leftwrap.appendChild(leftcircle);var text=document.createElement("div");text.id="game9gpkwaittext";text.className="game9gpkwaittext";text.innerHTML=content;div.appendChild(text);rightcircle.style.webkitAnimation="circleloadright "+second+"s linear";rightcircle.style.webkitAnimationFillMode="forwards";rightcircle.style.animation="circleloadright "+second+"s linear";rightcircle.style.animationFillMode="forwards";leftcircle.style.animation="circleloadleft "+second+"s linear";leftcircle.style.animationFillMode="forwards";leftcircle.style.webkitAnimation="circleloadleft "+second+"s linear";leftcircle.style.webkitAnimationFillMode="forwards";leftcircle.addEventListener("animationend",callback);leftcircle.addEventListener("webkitAnimationEnd",callback)};Game9GPKUI.prototype.hideWait=function(){var div=document.getElementById("game9gpkwait");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.setProgressText=function(content){var text=document.getElementById("game9gpkprogresstext");if(text){var fz;content=content+"";if(content.length==1){fz=this.game9g.utils.vw2pxs(32)}else if(content.length==2){fz=this.game9g.utils.vw2pxs(16)}else if(content.length==3){fz=this.game9g.utils.vw2pxs(12)}else if(content.length<=5){fz=this.game9g.utils.vw2pxs(9)}else if(content.length<=7){fz=this.game9g.utils.vw2pxs(7)}else{fz=this.game9g.utils.vw2pxs(6)};text.innerHTML=content;text.style.fontSize=fz}};Game9GPKUI.prototype.showTip=function(content,color,pulse){this.showMask();var tip=document.getElementById("game9gpktip");var text=document.getElementById("game9gpktiptext");if(!tip){tip=document.createElement("div");tip.id="game9gpktip";tip.className="game9gpktip";document.getElementsByTagName("body")[0].appendChild(tip);text=document.createElement("div");text.id="game9gpktiptext";text.className="game9gpktiptext";document.getElementsByTagName("body")[0].appendChild(text)};tip.style.display="";text.style.display="";var fz;content=content+"";if(content.length==1){fz=this.game9g.utils.vw2pxs(32)}else if(content.length==2){fz=this.game9g.utils.vw2pxs(16)}else if(content.length==3){fz=this.game9g.utils.vw2pxs(12)}else if(content.length<=5){fz=this.game9g.utils.vw2pxs(9)}else if(content.length<=7){fz=this.game9g.utils.vw2pxs(7)}else{fz=this.game9g.utils.vw2pxs(6)};text.innerHTML=content;text.style.fontSize=fz;text.style.color=(color?color:"#619D96");tip.className=(pulse?"game9gpktip pulse":"game9gpktip")};Game9GPKUI.prototype.hideTip=function(){var tip=document.getElementById("game9gpktip");if(tip)tip.style.display="none";var text=document.getElementById("game9gpktiptext");if(text)text.style.display="none"};Game9GPKUI.prototype.showMatch=function(){this.showTip("正在匹配",null,true);this.showRole(this.game9g.role);this.removeRole("game9gpkrole_target");if(this.game9g.pk.randPlayers){console.log("showRandPlayers immediately");this.showRandPlayers()}else{var _this=this;this.game9g.on("pkGameRandPlayers",function(){console.log("showRandPlayers onPkGameRandPlayers");_this.showRandPlayers()},true)}};Game9GPKUI.prototype.hideMatch=function(){this.hideTip();this.removeRole("game9gpkrole_hero");this.removeRole("game9gpkrole_target");this.hideRandPlayers()};Game9GPKUI.prototype.showWaitPeople=function(content,second,callback){this.showMask();this.showRole(this.game9g.role);var _this=this;this.showProgress(content,second,callback)};Game9GPKUI.prototype.hideWaitPeople=function(){this.removeRole("game9gpkrole_hero");this.removeRole("game9gpkrole_target");this.hideProgress()};Game9GPKUI.prototype.showGameRoomCreate=function(){this.hideGameRoomCreate();var link=this.game9g.utils.setParameter(this.game9g.shareData.link,"roomid",this.game9g.pk.roomid);var wrap=document.createElement("div");wrap.id="game9gpkroomcreate";wrap.className="game9gpkroomcreate";document.getElementsByTagName("body")[0].appendChild(wrap);var title=document.createElement("b");title.innerHTML=this.game9g.role.nickname+"的房间已经开通！";wrap.appendChild(title);var tip=document.createElement("span");tip.innerHTML="扫描二维码或通知好友立即开战";wrap.appendChild(tip);var qrbox=document.createElement("div");wrap.appendChild(qrbox);var _this=this;this.game9g.utils.getShortUrl(link,function(url){var size=_this.game9g.utils.vw2px(50);_this.game9g.utils.onQRCodeReady(function(){var qrcode=new QRCode(qrbox,{width:size,height:size});qrcode.makeCode(url)})});var content=document.createElement("p");content.innerHTML="我开好房了，房号是"+this.game9g.pk.roomid+"<br/>快点过来找我……";wrap.appendChild(content);this.game9g.setShareData({imgurl:this.game9g.role.headimgurl,link:link,title:"我开好房了，房号是"+this.game9g.pk.roomid+"，快点过来找我……",content:"点击马上与"+this.game9g.role.nickname+"实时对战"})};Game9GPKUI.prototype.hideGameRoomCreate=function(){var div=document.getElementById("game9gpkroomcreate");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.showMyGameRoomWait=function(){var _this=this;this.game9g.utils.progress({content:"等待朋友加入",time:30,cancelEvent:"pkGameRoomOK",timeoutText:"对应无响应",timeoutBtns:[{label:"继续等待",again:true},{label:"和别人玩",bgcolor:"#CCC",click:function(){window.location=_this.game9g.baseurl+"/gamecenter.html?gameid=pk"}}]})};Game9GPKUI.prototype.showGameShare=function(callback){this.hideGameShare();var img=document.createElement("img");img.id="game9gpkshare";img.className="game9gshare";img.src="http://game.9g.com/share.png";var _this=this;img.addEventListener("touchstart",function(e){_this.hideGameShare();e.preventDefault()});document.getElementsByTagName("body")[0].appendChild(img);if(this.game9g.app){this.game9g.app.shareOK=function(){_this.hideGameShare();callback&&callback.call(null)}}};Game9GPKUI.prototype.hideGameShare=function(){var img=document.getElementById("game9gpkshare");if(img)img.parentElement.removeChild(img)};Game9GPKUI.prototype.showRole=function(role){var ishero=(role.role_id==this.game9g.roleid);var id="game9gpkrole_"+(ishero?"hero":"target");var div=document.getElementById(id);if(!div){div=this.renderRole(id,role);div.className+=(ishero?" matchhero":" matchtarget");document.getElementsByTagName("body")[0].appendChild(div)}};Game9GPKUI.prototype.removeRole=function(id){var div=document.getElementById(id);if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.renderRole=function(id,role){var div=document.createElement("div");div.id=id;div.className="game9gpkrole"+(role.role_id==this.game9g.roleid?" hero":"");var head=document.createElement("img");head.className="game9gpkrolehead";div.appendChild(head);var name=document.createElement("div");name.className="game9gpkrolename";div.appendChild(name);var nickname=document.createElement("span");name.appendChild(nickname);var sex=document.createElement("img");name.appendChild(sex);var city=document.createElement("div");city.className="game9gpkrolecity";div.appendChild(city);head.src=this.game9g.utils.getHead132(role.headimgurl);nickname.innerHTML=role.nickname;sex.src="http://game.9g.com/img/"+(role.sex==1?"male":"female")+".png";city.innerHTML=role.city;return div};Game9GPKUI.prototype.showMatchRecommend=function(player,game,ok,cancel){this.hideMatchRecommend();var div=document.getElementById("game9gpkconfirm");div=document.createElement("game9gpkconfirm");div.id="game9gpkconfirm";div.className="game9gpkconfirm";document.getElementsByTagName("body")[0].appendChild(div);var icon=document.createElement("img");icon.className="game9gpkconfirmicon";div.appendChild(icon);var text=document.createElement("div");text.className="game9gpkconfirmtext";div.appendChild(text);var btn=document.createElement("div");btn.className="game9gpkconfirmbtn";div.appendChild(btn);var btnok=document.createElement("a");btnok.className="game9gpkconfirmbtnok";btnok.innerHTML="好";btn.appendChild(btnok);var btncancel=document.createElement("a");btncancel.className="game9gpkconfirmbtncancel";btncancel.innerHTML="不要";btn.appendChild(btncancel);icon.src=this.game9g.utils.getHead132(player.headimgurl);text.innerHTML="是否要和"+player.city+"的“"+player.nickname+"”玩《"+game.gamename+"》？";var _this=this;btnok.addEventListener("touchstart",function(e){e.preventDefault();_this.hideMatchRecommend();ok&&ok.call(null)});btncancel.addEventListener("touchstart",function(e){e.preventDefault();_this.hideMatchRecommend();cancel&&cancel.call(null)})};Game9GPKUI.prototype.hideMatchRecommend=function(){var div=document.getElementById("game9gpkconfirm");if(div)document.getElementsByTagName("body")[0].removeChild(div)};Game9GPKUI.prototype.showRoom=function(){var div=document.createElement("div");div.id="game9gpkroom";div.className="game9gpkroom";document.getElementsByTagName("body")[0].appendChild(div);var ps=document.createElement("div");ps.className="game9gpkroomplayers";div.appendChild(ps);var target=null;var players=this.game9g.pk.players;for(var i=0;i<players.length;i++){var player=this.game9g.pk.getPlayer(players[i].role_id);var ishero=(player.role_id==this.game9g.roleid);if(!ishero)target=player;var role=this.renderRole("game9gpkroomrole_"+(ishero?"hero":"target"),player);role.className+=(ishero?" roomhero":" roomtarget");ps.appendChild(role)}};Game9GPKUI.prototype.hideRoom=function(){var div=document.getElementById("game9gpkroom");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.showGameAllList=function(callback){this.hideGameAllList();var _this=this;var mask=document.createElement("div");mask.id="game9gpkgamesmask";mask.className="game9gpkgamesmask";mask.addEventListener("touchstart",function(e){_this.hideGameAllList();e.preventDefault()});document.getElementsByTagName("body")[0].appendChild(mask);var div=document.createElement("div");div.id="game9gpkgames";div.className="game9gpkgames";document.getElementsByTagName("body")[0].appendChild(div);if(!this.game9g.pk.games)return;var ul=document.createElement("ul");div.appendChild(ul);for(var i=0;i<this.game9g.pk.games.length;i++){var game=this.game9g.pk.games[i];var li=document.createElement("li");var img=document.createElement("img");img.src=game.gameicon;li.appendChild(img);var p=document.createElement("p");p.innerHTML=game.gamename;li.appendChild(p);if(game.keyword){var label=document.createElement("label");label.innerHTML=game.keyword;p.appendChild(label)};var span=document.createElement("span");span.innerHTML=game.play_count+"人正在玩";li.appendChild(span);ul.appendChild(li);(function(li,game){li.addEventListener("click",function(e){_this.hideGameAllList();callback&&callback.call(null,game);e.preventDefault()})})(li,game)};var footer=document.createElement("div");div.appendChild(footer);var btnPrev=document.createElement("a");btnPrev.innerHTML="上一页";footer.appendChild(btnPrev);btnPrev.addEventListener("touchstart",function(e){ul.scrollTop-=_this.game9g.utils.vh2px(70);e.preventDefault()});var btnNext=document.createElement("a");btnNext.innerHTML="下一页";footer.appendChild(btnNext);btnNext.addEventListener("touchstart",function(e){ul.scrollTop+=_this.game9g.utils.vh2px(70);e.preventDefault()})};Game9GPKUI.prototype.hideGameAllList=function(){var div=document.getElementById("game9gpkgames");if(div)div.parentElement.removeChild(div);var mask=document.getElementById("game9gpkgamesmask");if(mask)mask.parentElement.removeChild(mask)};Game9GPKUI.prototype.showGameRandList=function(){this.hideGameRandList();var div=document.createElement("div");div.id="game9gpkgamelist";div.className="game9gpkgamelist";document.getElementsByTagName("body")[0].appendChild(div);var _this=this;for(var i=0;i<this.game9g.pk.games.length;i++){var game=this.game9g.pk.games[i];var item=document.createElement("div");item.className="game9gpkgame";item.title=game.gameid;div.appendChild(item);var img=document.createElement("img");img.id="game9gpkgame_"+game.gameid;img.src=game.gameicon;item.appendChild(img);var text=document.createElement("div");text.innerHTML=game.gamename;item.appendChild(text);(function(item,game){item.addEventListener("touchstart",function(e){_this.game9g.pk.assignGame(game.gameid);e.preventDefault()})})(item,game)}};Game9GPKUI.prototype.scrollGame=function(){this.selectedGame=null;var items=document.getElementById("game9gpkgamelist").getElementsByClassName("game9gpkgame");var n=items.length;var imgs=[];for(var i=0;i<n;i++){var img=items[i].getElementsByTagName("img")[0];imgs.push(img)};var index=-1;this.clearGameStyle=function(){for(var i=0;i<n;i++){imgs[i].style.borderColor="#FFF"}};this.selectGameStyle=function(img){img.style.borderColor="#FFFD01"};var _this=this;var scroll=function(){if(_this.selectedGame)return;index++;if(index>=n)index=0;_this.clearGameStyle();_this.selectGameStyle(imgs[index]);setTimeout(scroll,200)};scroll()};Game9GPKUI.prototype.selectGame=function(gameid){this.clearGameStyle();this.selectedGame=gameid;var img=document.getElementById("game9gpkgame_"+gameid);if(img){this.selectGameStyle(img);img.className+=" flashFast sextic"}};Game9GPKUI.prototype.hideGameRandList=function(){var div=document.getElementById("game9gpkgamelist");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.showRandPlayers=function(){this.hideRandPlayers();if(!this.game9g.pk.randPlayers||this.game9g.pk.randPlayers.length==0)return;this.randPlayers=this.game9g.pk.randPlayers.slice(0);var wrap=document.createElement("div");wrap.id="game9gpkmatchlist";wrap.className="game9gpkmatchlist";document.getElementsByTagName("body")[0].appendChild(wrap);var arrow=document.createElement("div");arrow.id="game9gpkmatcharrow";arrow.className="game9gpkmatcharrow";wrap.appendChild(arrow);var div=document.createElement("div");div.id="game9gpkmatchscroll";div.className="game9gpkmatchscroll";wrap.appendChild(div);this.playerIndex=-1;this.playerSize=3;this.selectedPlayer=null;var i=0;while(i<this.playerSize){this.addNextPlayer(i);i++};this.scrollPlayer()};Game9GPKUI.prototype.addNextPlayer=function(i){var div=document.getElementById("game9gpkmatchscroll");if(div){this.playerIndex++;if(this.playerIndex>=this.randPlayers.length)this.playerIndex=0;var player=this.randPlayers[this.playerIndex];var img=document.createElement("img");img.src=this.game9g.utils.getHead132(player.headimgurl);img.title=player.role_id;img.style.left=this.game9g.utils.vw2pxs(20*i);div.appendChild(img)}};Game9GPKUI.prototype.scrollPlayer=function(){var div=document.getElementById("game9gpkmatchscroll");if(div){this.addNextPlayer(this.playerSize);var isSelected=false;var currentImg=null;var _this=this;setTimeout(function(){if(!div.parentElement)return;var imgs=div.getElementsByTagName("img");for(var i=0;i<imgs.length;i++){imgs[i].style.left=_this.game9g.utils.vw2pxs(20*(i-1))};var img1=imgs[1];var img2=imgs[2];var img3=imgs[3];var currentRoleId=img2.title;if(_this.selectedPlayer&&currentRoleId==_this.selectedPlayer.role_id){isSelected=true}else{img2.className+=" bounce"};setTimeout(function(){if(!div.parentElement)return;div.removeChild(imgs[0]);if(isSelected){_this.showTip("匹配成功");var arrow=document.getElementById("game9gpkmatcharrow");arrow.className="game9gpkmatcharrow flashFast sextic";img2.className="flashFast sextic";img1.className="fadeOut";img3.className="fadeOut";var fadeOut=function(){img2.removeEventListener("animationend",fadeOut);img2.removeEventListener("webkitAnimationEnd",fadeOut);arrow.className="game9gpkmatcharrow fadeOut";img2.className="fadeOut";var showRole=function(){img2.removeEventListener("animationend",showRole);img2.removeEventListener("webkitAnimationEnd",showRole);_this.hideRandPlayers();if(_this.selectedPlayer){_this.showRole(_this.selectedPlayer)}};img2.addEventListener("animationend",showRole);img2.addEventListener("webkitAnimationEnd",showRole)};img2.addEventListener("animationend",fadeOut);img2.addEventListener("webkitAnimationEnd",fadeOut)}},200)},100);var timer=setTimeout(function(){if(!isSelected)_this.scrollPlayer()},1000);this.game9g.on("pkHideRandPlayers",function(){clearTimeout(timer)},true)}};Game9GPKUI.prototype.selectPlayer=function(player){if(!this.randPlayers||this.randPlayers.length==0)return;var targetIndex=this.playerIndex+1;if(targetIndex>=this.randPlayers.length)targetIndex=0;this.randPlayers[targetIndex]=player;this.selectedPlayer=player};Game9GPKUI.prototype.selectNextPlayer=function(){var targetIndex=this.playerIndex+1;if(targetIndex>=this.randPlayers.length)targetIndex=0;this.selectedPlayer=this.randPlayers[targetIndex];return this.selectedPlayer};Game9GPKUI.prototype.hideRandPlayers=function(){var div=document.getElementById("game9gpkmatchlist");if(div)div.parentElement.removeChild(div);this.game9g.dispatchEvent("pkHideRandPlayers")};Game9GPKUI.prototype.showGame=function(){var div=document.createElement("div");div.id="game9gpk";div.className="game9gpk";document.getElementsByTagName("body")[0].appendChild(div);var bg=document.createElement("div");bg.id="game9gpkbg";bg.className="game9gpkbg";div.appendChild(bg);var players=this.game9g.pk.players;for(var i=0;i<players.length;i++){this.addPlayer(players[i])};this.showGameTime(this.game9g.pk.gametime);this.showFight()};Game9GPKUI.prototype.hideGame=function(){var div=document.getElementById("game9gpk");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.showFight=function(){var div=document.getElementById("game9gpkfight");if(!div){div=document.createElement("div");div.id="game9gpkfight";div.className="game9gpkfight";document.getElementById("game9gpk").appendChild(div);var herobest=document.createElement("div");herobest.id="game9gpkfightbest_hero";herobest.className="game9gpkfightbest hero";div.appendChild(herobest);var heroscore=document.createElement("div");heroscore.id="game9gpkfightscore_hero";heroscore.className="game9gpkfightscore hero";herobest.appendChild(heroscore);var targetbest=document.createElement("div");targetbest.id="game9gpkfightbest_target";targetbest.className="game9gpkfightbest target";div.appendChild(targetbest);var targetscore=document.createElement("div");targetscore.id="game9gpkfightscore_target";targetscore.className="game9gpkfightscore target";targetbest.appendChild(targetscore)}};Game9GPKUI.prototype.showEmojiPanel=function(){if(!this.game9g.pk.emojis)return;var div=document.getElementById("game9gpkemojilist");if(!div){var _this=this;div=document.createElement("div");div.id="game9gpkemojilist";div.className="game9gpkemojilist";document.getElementsByTagName("body")[0].appendChild(div);for(var i=0;i<this.game9g.pk.emojis.length;i++){var emoji=this.game9g.pk.emojis[i];var img=document.createElement("img");img.src=emoji.url;div.appendChild(img);(function(img,id){img.addEventListener("touchstart",function(e){_this.game9g.pk.io.doGameEmoji(id);e.preventDefault()})})(img,emoji.id)}};div.style.display=""};Game9GPKUI.prototype.hideEmojiPanel=function(){var div=document.getElementById("game9gpkemojilist");if(div)div.style.display="none"};Game9GPKUI.prototype.showEmoji=function(roleid,emoji){var ishero=(roleid==this.game9g.roleid);var x=(ishero?this.game9g.utils.vw2pxs(Math.random()*24):this.game9g.utils.vw2pxs(60+Math.random()*24));var y=this.game9g.utils.vh2pxs(20+Math.random()*30);var distance=(ishero?1:-1)*this.game9g.utils.vw2px(20);var fly=(ishero?"game9gpkemojiflyright":"game9gpkemojiflyleft");var img=document.createElement("img");img.id="game9gpkemoji_"+new Date().getTime();img.className="game9gpkemoji";img.src=emoji.url;img.style.left=x;img.style.top=y;var removeImg=function(){if(!img)return;img.parentElement.removeChild(img);img=null};document.getElementsByTagName("body")[0].appendChild(img);if(this.game9g.utils.getAppType()=="wx"&&this.game9g.utils.isAndroid()){img.className+=" "+fly;img.addEventListener("animationend",removeImg);img.addEventListener("webkitAnimationEnd",removeImg)}else{setTimeout(function(){move("#"+img.id).scale(1.25).duration("0.18s").then().scale(0.8).duration("0.1s").then().ease("linear").x(distance).duration("1.5s").then().set("opacity",0).duration("0.1s").pop().pop().pop().end();setTimeout(removeImg,2000)},20)}};Game9GPKUI.prototype.showGameIntro=function(){if(!this.game9g.pk.gameid)return;var img=document.getElementById("game9gpkintro");if(!img){img=document.createElement("img");img.id="game9gpkintro";img.className="game9gpkintro";img.src=this.game9g.baseurl+"/"+this.game9g.pk.gameid+"/intro.png";document.getElementsByTagName("body")[0].appendChild(img)};img.style.display=""};Game9GPKUI.prototype.hideGameIntro=function(){var img=document.getElementById("game9gpkintro");if(img)img.style.display="none"};Game9GPKUI.prototype.gameStart=function(){};Game9GPKUI.prototype.showGameTime=function(time){var div=document.getElementById("game9gpktime");if(!div){div=document.createElement("div");div.id="game9gpktime";div.className="game9gpktime";document.getElementById("game9gpk").appendChild(div)};div.innerHTML=time};Game9GPKUI.prototype.refreshGameTime=function(time){var div=document.getElementById("game9gpktime");if(div)div.innerHTML=time};Game9GPKUI.prototype.addPlayer=function(player){var roleid=player.role_id;var div=document.getElementById("game9gpkplayer_"+roleid);var head,name,score,text;if(!div){div=document.createElement("div");div.id="game9gpkplayer_"+roleid;div.className="game9gpkplayer";document.getElementById("game9gpk").appendChild(div);head=document.createElement("img");head.className="game9gpkplayerhead";head.src=this.game9g.utils.getHead132(player.headimgurl);div.appendChild(head);name=document.createElement("div");name.className="game9gpkplayername";name.innerHTML=player.nickname;div.appendChild(name);score=document.createElement("div");score.id="game9gpkscore_"+roleid;score.className="game9gpkscore";var title=document.createElement("div");title.className="game9gpkscoretitle";title.innerHTML="得分";score.appendChild(title);text=document.createElement("div");text.className="game9gpkscoretext";score.appendChild(text);document.getElementById("game9gpk").appendChild(score)}else{head=div.getElementsByClassName("game9gpkplayerhead")[0];name=div.getElementsByClassName("game9gpkplayername")[0];score=document.getElementById("game9gpkscore_"+roleid);text=score.getElementsByClassName("game9gpkscoretext")[0]};div.className="game9gpkplayer "+(roleid==this.game9g.roleid?"hero":"target");score.className="game9gpkscore "+(roleid==this.game9g.roleid?"hero":"target");text.innerHTML="0/0"};Game9GPKUI.prototype.removePlayer=function(player){var roleid=player.role_id;var p=document.getElementById("game9gpkplayer_"+roleid);if(p){document.getElementById("game9gpk").removeChild(p)}};Game9GPKUI.prototype.resetAllPlayers=function(){for(var i=0;i<this.game9g.pk.players.length;i++){var player=this.game9g.pk.players[i];this.game9g.pk.refreshScore(player.role_id,0,0)}};Game9GPKUI.prototype.refreshScore=function(player){var roleid=player.role_id;var div=document.getElementById("game9gpkscore_"+roleid);if(div){var text=div.getElementsByClassName("game9gpkscoretext")[0];text.innerHTML=player.score+"/"+player.best};if(this.game9g.pk.players.length==2){var hero=this.game9g.pk.players[0].role_id==this.game9g.roleid?this.game9g.pk.players[0]:this.game9g.pk.players[1];var target=this.game9g.pk.players[0].role_id==this.game9g.roleid?this.game9g.pk.players[1]:this.game9g.pk.players[0];this.refreshPKScore(hero.score,hero.best,target.score,target.best)}else{this.refreshPKScore(0,0,0,0)}};Game9GPKUI.prototype.refreshPKScore=function(heroscore,herobest,targetscore,targetbest){if(herobest==0)herobest=0.1;if(targetbest==0)targetbest=0.1;var hw1=(herobest*100/(herobest+targetbest)).toFixed(2)+"%";var hw2=(heroscore*100/herobest).toFixed(2)+"%";var tw1=(targetbest*100/(herobest+targetbest)).toFixed(2)+"%";var tw2=(targetscore*100/targetbest).toFixed(2)+"%";move("#game9gpkfightbest_hero").set("width",hw1).end();move("#game9gpkfightscore_hero").set("width",hw2).end();move("#game9gpkfightbest_target").set("width",tw1).end();move("#game9gpkfightscore_target").set("width",tw2).end()};Game9GPKUI.prototype.showGameOver=function(){this.showMask();var div=document.getElementById("game9gpktimeout");if(!div){div=document.createElement("div");div.id="game9gpktimeout";div.className="game9gpktimeout";div.innerHTML="时间到";document.getElementsByTagName("body")[0].appendChild(div)};div.style.display=""};Game9GPKUI.prototype.hideGameOver=function(){var div=document.getElementById("game9gpktimeout");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.showResult=function(json){this.hideResult();this.showMask();var _this=this;var div=document.createElement("div");div.id="game9gpkresult";div.className="game9gpkresult";document.getElementsByTagName("body")[0].appendChild(div);var players=document.createElement("div");players.className="game9gpkresultplayers";div.appendChild(players);var score=document.createElement("div");score.className="game9gpkresultscore";div.appendChild(score);var bar=document.createElement("div");bar.className="game9gpkresultscorebar";score.appendChild(bar);var i;var totalscore=0;for(i=0;i<json.result.length;i++){totalscore+=json.result[i].score};var target=null;for(i=0;i<json.result.length;i++){var player=this.game9g.pk.getPlayer(json.result[i].role_id);var ishero=(player.role_id==this.game9g.roleid);if(!ishero)target=player;var role=this.renderRole("game9gpkresultrole_"+(ishero?"hero":"target"),player);role.className+=(ishero?" resulthero":" resulttarget");players.appendChild(role);if(player.role_id!=this.game9g.roleid){var icon=document.createElement("div");icon.className="game9gpkresultchaticon";role.appendChild(icon);(function(role,player){role.addEventListener("touchstart",function(e){_this.game9g.pk.chat(player);e.preventDefault()})})(role,player)};var scoretext=document.createElement("div");scoretext.id="game9gpkresultscoretext_"+(ishero?"hero":"target");scoretext.className="game9gpkresultscoretext "+(ishero?"hero":"target");scoretext.innerHTML=json.result[i].score;score.appendChild(scoretext);var scorebar=document.createElement("div");scorebar.id="game9gpkresultscorebar_"+(ishero?"hero":"target");scorebar.className=(ishero?"hero":"target");bar.appendChild(scorebar);var width=(totalscore==0?"50%":(json.result[i].score*100/totalscore)+"%");(function(id,width){setTimeout(function(){move("#"+id).set("width",width).duration("1.2s").end()},100)})(scorebar.id,width)};var iswin=(json.winner==this.game9g.roleid);var winner=document.createElement("div");winner.className="game9gpkresultwinner "+(iswin?"win":"lose");winner.innerHTML=(iswin?"你赢了":"你输了");div.appendChild(winner);var btns=document.createElement("div");btns.className="game9gpkresultbtn";setTimeout(function(){div.appendChild(btns)},3000);var btn1=document.createElement("a");btn1.className="resultred";btn1.innerHTML="再玩一次";btn1.addEventListener("touchstart",function(e){_this.game9g.pk.gameReplayRequest();e.preventDefault()});btns.appendChild(btn1);var btn2=document.createElement("a");btn2.className="resultwhite";btn2.innerHTML="换个游戏";btn2.addEventListener("touchstart",function(e){_this.game9g.pk.gamePlayNew();e.preventDefault()});btns.appendChild(btn2);var btn3=document.createElement("a");btn3.className="resultwhite";btn3.innerHTML="换个对手";btn3.addEventListener("touchstart",function(e){_this.showPkOther();e.preventDefault()});btns.appendChild(btn3);var btn4=document.createElement("a");btn4.className="resultwhite";btn4.innerHTML="发送消息";btn4.addEventListener("touchstart",function(e){_this.game9g.pk.chat(target);e.preventDefault()});btns.appendChild(btn4);var btn5=document.createElement("a");btn5.className="resultwhite";btn5.innerHTML="加好友";btn5.addEventListener("touchstart",function(e){_this.game9g.utils.prompt("请求加对方为好友：",function(data){_this.game9g.chat.sendFriendRequest(_this.game9g.roleid,target.role_id,data,function(){_this.game9g.utils.tip("好友请求已发送")})})});btns.appendChild(btn5);var btn6=document.createElement("a");btn6.className="resultwhite";btn6.innerHTML="退出";btn6.addEventListener("touchstart",function(e){window.location=_this.game9g.baseurl+"/app/games.html?r="+Math.random()});btns.appendChild(btn6)};Game9GPKUI.prototype.hideResult=function(){var div=document.getElementById("game9gpkresult");if(div)div.parentElement.removeChild(div)};Game9GPKUI.prototype.showPkOther=function(){this.hidePkOther();var _this=this;var mask=document.createElement("div");mask.id="game9gpkothermask";mask.className="game9gpkothermask";mask.addEventListener("touchstart",function(e){_this.hidePkOther();e.preventDefault()});document.getElementsByTagName("body")[0].appendChild(mask);var div=document.createElement("div");div.id="game9gpkother";div.className="game9gpkother";document.getElementsByTagName("body")[0].appendChild(div);var btnWx=document.createElement("a");btnWx.className="game9gpkweixin";btnWx.addEventListener("touchstart",function(e){_this.hidePkOther();_this.game9g.pk.createRoom();e.preventDefault()});div.appendChild(btnWx);var btnRand=document.createElement("a");btnRand.className="game9gpkrandom";btnRand.addEventListener("touchstart",function(e){_this.hidePkOther();window.location=_this.game9g.baseurl+"/gamecenter.html?gameid=pk";e.preventDefault()});div.appendChild(btnRand)};Game9GPKUI.prototype.hidePkOther=function(){var div=document.getElementById("game9gpkother");if(div)div.parentElement.removeChild(div);var mask=document.getElementById("game9gpkothermask");if(mask)mask.parentElement.removeChild(mask)};Game9GPKIO=function(game9g,ui){this.game9g=game9g;this.ui=ui;this.websocket;this.server="182.254.139.113";this.port=9502;this.isConnected=false;this.isReconnect=false;this.keepAliveInterval=null;this.Channel={PRIVATE:10,CHAT:20,GROUP_CHAT:30,GAME:50};this.Command={P_TOKEN:1001,GAME_MATCH:5001,GAME_MATCH_CANCEL:5002,GAME_MATCH_PLAYER:5003,GAME_MATCH_RECOMMEND:5005,GAME_MATCH_IGNORE:5006,GAME_MATCH_RECOMMEND_OK:5007,GAME_MATCH_OFFLINE:5008,GAME_MATCH_RECOMMEND_NOTICE:5009,GAME_MATCH_PLAYER_OFFLINE:5010,GAME_JOIN:5011,GAME_QUIT:5012,GAME_ROOM:5013,GAME_ROOM_OK:5014,GAME_PLAYERS:5015,GAME_JOIN_PRIVATE:5016,GAME_JOIN_PUBLIC:5017,GAME_JOIN_OFFLINE:5018,GAME_ALL_READY:5020,GAME_READY:5021,GAME_START:5022,GAME_SNAPSHOOT:5023,GAME_COUNT_DOWN:5024,GAME_TIME:5025,GAME_SUBMIT:5026,GAME_OVER:5028,GAME_RESULT:5029,GAME_REPLAY:5030,GAME_REPLAY_REQUEST:5031,GAME_REPLAY_REQUEST_CANCEL:5032,GAME_REPLAY_RESPONSE:5033,GAME_EMOJI_LIST:5050,GAME_EMOJI:5051,GAME_ROOM_CREATE:5061,GAME_PK_NOTICE:5065,GAME_ALL_LIST:5070,GAME_RAND_LIST:5071,GAME_ASSIGN:5072,GAME_ASSIGN_TIMEOUT:5073,GAME_RE_ASSIGN:5074,GAME_RAND_PLAYERS:5076}};Game9GPKIO.prototype.socketOpen=function(){try{var _this=this;this.websocket=new WebSocket("ws://"+this.server+":"+this.port);this.websocket.onopen=function(){_this.onOpen()};this.websocket.onclose=function(e){_this.onClose(e)};this.websocket.onmessage=function(e){_this.onMessage(e)};this.websocket.onerror=function(e){_this.onError(e)}}catch(e){}};Game9GPKIO.prototype.socketClose=function(){this.websocket.close();this.isConnected=false;this.game9g.pk.status=this.game9g.pk.Status.OFFLINE};Game9GPKIO.prototype.onOpen=function(){console.log("连接成功 server = "+this.server+", port = "+this.port);this.isConnected=true;clearInterval(this.keepAliveInterval);this.game9g.pk.status=this.game9g.pk.Status.ONLINE;this.doCheckToken();if(this.isReconnect){}};Game9GPKIO.prototype.onReady=function(){this.game9g.pk.onReady()};Game9GPKIO.prototype.onClose=function(e){this.isConnected=false;console.log("已断开连接.");this.game9g.pk.status=this.game9g.pk.Status.OFFLINE};Game9GPKIO.prototype.onError=function(e){console.log("ERROR: "+e.data)};Game9GPKIO.prototype.checkConnect=function(){if(this.isConnected){return true}else{return false}};Game9GPKIO.prototype.keepAlive=function(){var _this=this;this.keepAliveInterval=setInterval(function(){if(!_this.isConnected){_this.isReconnect=true;_this.socketOpen()}},3000)};Game9GPKIO.prototype.onMessage=function(e){try{console.info("%c"+e.data,"color: #489348")}catch(e){console.log("←"+e.data)};var json=null;try{json=JSON.parse(e.data)}catch(e){console.log(e)};if(json!=null){this.execute(json)}};Game9GPKIO.prototype.send=function(json){if(this.isConnected){var message=JSON.stringify(json);try{this.websocket.send(message);try{console.warn("%c"+message,"color: #D34B34")}catch(e){console.log("→"+message)};return true}catch(e){alert(e)}}else{alert("连接已关闭")};return false};Game9GPKIO.prototype.doCheckToken=function(token){return this.send({ch:this.Channel.PRIVATE,cmd:this.Command.P_TOKEN,token:localStorage.token})};Game9GPKIO.prototype.doGameMatch=function(){var json={ch:this.Channel.GAME,cmd:this.Command.GAME_MATCH,role_id:this.game9g.roleid};if(this.game9g.pk.gameid)json.gameid=this.game9g.pk.gameid;return this.send(json)};Game9GPKIO.prototype.doGameMatchCancel=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_MATCH_CANCEL})};Game9GPKIO.prototype.doGameMatchRecommend=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_MATCH_RECOMMEND})};Game9GPKIO.prototype.doGameMatchRecommendOK=function(roleid,gameid){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_MATCH_RECOMMEND_OK,role_id:roleid,gameid:gameid})};Game9GPKIO.prototype.doGameMatchIgnore=function(roleid){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_MATCH_IGNORE,role_id:roleid})};Game9GPKIO.prototype.doGameMatchOffline=function(){var json={ch:this.Channel.GAME,cmd:this.Command.GAME_MATCH_OFFLINE,role_id:this.game9g.roleid};if(this.game9g.pk.gameid)json.gameid=this.game9g.pk.gameid;return this.send(json)};Game9GPKIO.prototype.doGameMatchPlayerOffline=function(roleid){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_MATCH_PLAYER_OFFLINE,role_id:roleid})};Game9GPKIO.prototype.doGameJoinPrivate=function(){var json={ch:this.Channel.GAME,cmd:this.Command.GAME_JOIN_PRIVATE,role_id:this.game9g.roleid,room_id:this.game9g.pk.roomid};if(this.game9g.pk.gameid)json.gameid=this.game9g.pk.gameid;return this.send(json)};Game9GPKIO.prototype.doGameJoinPublic=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_JOIN_PUBLIC,role_id:this.game9g.roleid,gameid:this.game9g.pk.gameid,room_id:this.game9g.pk.room_id})};Game9GPKIO.prototype.doGameJoinOffline=function(logid){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_JOIN_OFFLINE,role_id:this.game9g.roleid,log_id:logid})};Game9GPKIO.prototype.doGameQuit=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_QUIT})};Game9GPKIO.prototype.doGameReady=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_READY})};Game9GPKIO.prototype.doGameSubmit=function(data){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_SUBMIT,score:data.score})};Game9GPKIO.prototype.doGameReplay=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_REPLAY})};Game9GPKIO.prototype.doGameReplayRequest=function(gameid){var json={ch:this.Channel.GAME,cmd:this.Command.GAME_REPLAY_REQUEST};if(gameid)json.gameid=gameid;return this.send(json)};Game9GPKIO.prototype.doGameReplayRequestCancel=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_REPLAY_REQUEST_CANCEL})};Game9GPKIO.prototype.doGameReplayResponse=function(response,gameid){var json={ch:this.Channel.GAME,cmd:this.Command.GAME_REPLAY_RESPONSE,response:response};if(gameid)json.gameid=gameid;return this.send(json)};Game9GPKIO.prototype.doGameEmojiList=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_EMOJI_LIST})};Game9GPKIO.prototype.doGameEmoji=function(id){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_EMOJI,emoji_id:id})};Game9GPKIO.prototype.doGameRoomCreate=function(){var json={ch:this.Channel.GAME,cmd:this.Command.GAME_ROOM_CREATE,role_id:this.game9g.roleid};if(this.game9g.pk.gameid)json.gameid=this.game9g.pk.gameid;return this.send(json)};Game9GPKIO.prototype.doGamePkNotice=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_PK_NOTICE,room_id:this.game9g.pk.roomid})};Game9GPKIO.prototype.doGameAssign=function(gameid){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_ASSIGN,gameid:gameid})};Game9GPKIO.prototype.doGameAssignTimeout=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_ASSIGN_TIMEOUT})};Game9GPKIO.prototype.doGameAllList=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_ALL_LIST})};Game9GPKIO.prototype.doGameRandPlayers=function(){return this.send({ch:this.Channel.GAME,cmd:this.Command.GAME_RAND_PLAYERS})};Game9GPKIO.prototype.execute=function(json){if(json.errcode){this.executeError(json)}else if(!json.ch||!json.cmd){console.log("无效的通道或命令")}else{switch(json.ch){case this.Channel.PRIVATE:this.executePrivate(json);break;case this.Channel.GAME:this.executeGame(json);break;default:console.log("未知的通道消息：ch = "+json.ch);break}}};Game9GPKIO.prototype.executeError=function(json){console.log(json)};Game9GPKIO.prototype.executePrivate=function(json){switch(json.cmd){case this.Command.P_TOKEN:this.onCheckToken(json);break;default:console.log("未知的命令：cmd = "+json.cmd);break}};Game9GPKIO.prototype.onCheckToken=function(json){if(json.uid){this.onReady()}else{alert("token 已失效")}};Game9GPKIO.prototype.executeGame=function(json){switch(json.cmd){case this.Command.GAME_MATCH:this.onGameMatch(json);break;case this.Command.GAME_MATCH_CANCEL:this.onGameMatchCancel(json);break;case this.Command.GAME_MATCH_PLAYER:this.onGameMatchPlayer(json);break;case this.Command.GAME_MATCH_RECOMMEND:this.onGameMatchRecommend(json);break;case this.Command.GAME_MATCH_RECOMMEND_OK:this.onGameMatchRecommendOK(json);break;case this.Command.GAME_MATCH_RECOMMEND_NOTICE:this.onGameMatchRecommendNotice(json);break;case this.Command.GAME_MATCH_PLAYER_OFFLINE:this.onGameMatchPlayerOffline(json);break;case this.Command.GAME_MATCH_IGNORE:this.onGameMatchIgnore(json);break;case this.Command.GAME_JOIN:this.onGameJoin(json);break;case this.Command.GAME_JOIN_PRIVATE:this.onGameJoinPrivate(json);break;case this.Command.GAME_JOIN_PUBLIC:this.onGameJoinPublic(json);break;case this.Command.GAME_JOIN_OFFLINE:this.onGameJoinOffline(json);break;case this.Command.GAME_QUIT:this.onGameQuit(json);break;case this.Command.GAME_ROOM:this.onGameRoom(json);break;case this.Command.GAME_ROOM_OK:this.onGameRoomOK(json);break;case this.Command.GAME_PLAYERS:this.onGamePlayers(json);break;case this.Command.GAME_ALL_READY:this.onGameAllReady(json);break;case this.Command.GAME_READY:this.onGameReady(json);break;case this.Command.GAME_START:this.onGameStart(json);break;case this.Command.GAME_SNAPSHOOT:this.onGameSnapshoot(json);break;case this.Command.GAME_COUNT_DOWN:this.onGameCountDown(json);break;case this.Command.GAME_TIME:this.onGameTime(json);break;case this.Command.GAME_SUBMIT:this.onGameSubmit(json);break;case this.Command.GAME_OVER:this.onGameOver(json);break;case this.Command.GAME_RESULT:this.onGameResult(json);break;case this.Command.GAME_REPLAY:this.onGameReplay(json);break;case this.Command.GAME_REPLAY_REQUEST:this.onGameReplayRequest(json);break;case this.Command.GAME_REPLAY_REQUEST_CANCEL:this.onGameReplayRequestCancel(json);break;case this.Command.GAME_REPLAY_RESPONSE:this.onGameReplayResponse(json);break;case this.Command.GAME_EMOJI_LIST:this.onGameEmojiList(json);break;case this.Command.GAME_EMOJI:this.onGameEmoji(json);break;case this.Command.GAME_ROOM_CREATE:this.onGameRoomCreate(json);break;case this.Command.GAME_PK_NOTICE:this.onGamePkNotice(json);break;case this.Command.GAME_ALL_LIST:this.onGameAllList(json);break;case this.Command.GAME_RAND_LIST:this.onGameRandList(json);break;case this.Command.GAME_ASSIGN:this.onGameAssign(json);break;case this.Command.GAME_RE_ASSIGN:this.onGameReAssign(json);break;case this.Command.GAME_RAND_PLAYERS:this.onGameRandPlayers(json);break;default:console.log("未知的命令：cmd = "+json.cmd);break}};Game9GPKIO.prototype.onGameMatch=function(json){console.log("游戏匹配：gameid = "+(json.gameid||null)+", 人数 = "+json.match)};Game9GPKIO.prototype.onGameMatchCancel=function(json){console.log("取消匹配")};Game9GPKIO.prototype.onGameMatchPlayer=function(json){this.game9g.pk.onMatchPlayer(json.player)};Game9GPKIO.prototype.onGameMatchRecommend=function(json){if(json.player){this.game9g.pk.onMatchRecommend(json.player,json.game)}else{this.game9g.pk.onMatchRecommendFail()}};Game9GPKIO.prototype.onGameMatchRecommendOK=function(json){this.game9g.pk.onMatchRecommendOK(json.role_id,json.gameid)};Game9GPKIO.prototype.onGameMatchRecommendNotice=function(json){this.game9g.pk.onMatchRecommendNotice(json.player)};Game9GPKIO.prototype.onGameMatchIgnore=function(json){console.log("忽略来自 role_id = "+json.role_id+" 的匹配推荐")};Game9GPKIO.prototype.onGameMatchPlayerOffline=function(json){this.game9g.pk.onGameMatchPlayerOffline(json.role_id,json.gameid,json.log_id)};Game9GPKIO.prototype.onGameJoin=function(json){this.game9g.pk.onGameJoin(json.player,json.status)};Game9GPKIO.prototype.onGameJoinPrivate=function(json){if(json.result==1){this.game9g.pk.onJoinPrivate(json.status)}else{this.game9g.pk.onJoinPrivateFail(json.result)}};Game9GPKIO.prototype.onGameJoinPublic=function(json){this.game9g.pk.onJoinPublic(json.status)};Game9GPKIO.prototype.onGameJoinOffline=function(json){this.game9g.pk.onJoinOffline(json.room_id)};Game9GPKIO.prototype.onGameQuit=function(json){this.game9g.pk.onGameQuit(json.player)};Game9GPKIO.prototype.onGameRoom=function(json){this.game9g.pk.onGameRoom(json)};Game9GPKIO.prototype.onGameRoomOK=function(json){this.game9g.pk.onGameRoomOK(json.status)};Game9GPKIO.prototype.onGamePlayers=function(json){this.game9g.pk.onGamePlayers(json.players)};Game9GPKIO.prototype.onGameAllReady=function(json){this.game9g.pk.onGameAllReady(json.status)};Game9GPKIO.prototype.onGameReady=function(json){this.game9g.pk.onGameReady(json.players)};Game9GPKIO.prototype.onGameStart=function(json){this.game9g.pk.gameStart()};Game9GPKIO.prototype.onGameSnapshoot=function(json){this.game9g.pk.parseSnapshoot(json.list)};Game9GPKIO.prototype.onGameCountDown=function(json){this.ui.refreshGameTime(json.time)};Game9GPKIO.prototype.onGameTime=function(json){this.ui.refreshGameTime(json.remain)};Game9GPKIO.prototype.onGameSubmit=function(json){this.game9g.pk.refreshScore(json.role_id,json.score,json.best)};Game9GPKIO.prototype.onGameOver=function(json){this.game9g.pk.gameOver(json.status)};Game9GPKIO.prototype.onGameResult=function(json){this.game9g.pk.onGameResult(json)};Game9GPKIO.prototype.onGameReplay=function(json){this.game9g.pk.onGameReplay(json)};Game9GPKIO.prototype.onGameReplayRequest=function(json){this.game9g.pk.onGameReplayRequest(json.player,json.game||null)};Game9GPKIO.prototype.onGameReplayRequestCancel=function(json){this.game9g.pk.onGameReplayRequestCancel(json.player)};Game9GPKIO.prototype.onGameReplayResponse=function(json){this.game9g.pk.onGameReplayResponse(json.player,json.response,json.game||null)};Game9GPKIO.prototype.onGameEmojiList=function(json){this.game9g.pk.emojis=json.list};Game9GPKIO.prototype.onGameEmoji=function(json){this.ui.showEmoji(json.role_id,json.emoji)};Game9GPKIO.prototype.onGameRoomCreate=function(json){this.game9g.pk.onGameRoomCreate(json.room_id,json.owner)};Game9GPKIO.prototype.onGamePkNotice=function(json){console.log("发送对战通知："+JSON.stringify(json))};Game9GPKIO.prototype.onGameAllList=function(json){this.game9g.pk.onGameAllList(json.list)};Game9GPKIO.prototype.onGameRandList=function(json){this.game9g.pk.onGameRandList(json.list)};Game9GPKIO.prototype.onGameAssign=function(json){this.game9g.pk.onAssignGame(json.role_id,json.game)};Game9GPKIO.prototype.onGameReAssign=function(json){this.game9g.pk.onReAssignGame(json.gameid)};Game9GPKIO.prototype.onGameRandPlayers=function(json){this.game9g.pk.onGameRandPlayers(json.list)};Game9GUtils=function(game9g){this.game9g=game9g};Game9GUtils.prototype.extend=function(target,options){if(target==undefined||target==null){return options}else{if(options){for(var name in options){target[name]=options[name]}};return target}};Game9GUtils.prototype.isMobile=function(){var mobileAgent=new Array("iphone","ipod","ipad","android","mobile","blackberry","webos","incognito","webmate","nokia","ucweb","skyfire");var ua=navigator.userAgent.toLowerCase();for(var i=0;i<mobileAgent.length;i++){if(ua.indexOf(mobileAgent[i])!=-1){return true}};return false};Game9GUtils.prototype.isIOS=function(){return/iPhone|iPod|iPad|Mac/ig.test(navigator.userAgent)};Game9GUtils.prototype.isAndroid=function(){return/android|linux/i.test(navigator.userAgent)};Game9GUtils.prototype.isWindowsWechat=function(){return/WindowsWechat/ig.test(navigator.userAgent)};Game9GUtils.prototype.getAppType=function(){var ua=navigator.userAgent;if(/micromessenger/ig.test(ua)){return"wx";}else if(/\bQQ\/[\d\.]+\b/ig.test(ua)){return"qq";}else if(/game9g/ig.test(ua)){return"9g";}else if(/pengpeng/ig.test(ua)){return"pengpeng";}else if(/ucbrowser/ig.test(ua)){return"uc";}else if(/souyue/ig.test(ua)){return"zhongsou";}else if(/com\.mappn\.gfan/ig.test(ua)){return"gfan";}else if(/KuaiwanHuluxia/ig.test(ua)){return"kwhlx";}else if(/GGModel/ig.test(ua)){return"ggzs";}else{return"other";}};Game9GUtils.prototype.getAppVersion=function(){var result=null;var version=null;var ua=navigator.userAgent;switch(this.getAppType()){case"wx":result=ua.match(/MicroMessenger\/([^\s]+)/i);if(result)version=result[1];break;case"qq":result=ua.match(/\bQQ\/([^\s]+)/i);if(result)version=result[1];break;case"9g":result=ua.match(/Game9G\/([^\s]+)/i);if(result)version=result[1];break;case"pengpeng":result=ua.match(/PengPeng\/([^\s]+)/i);if(result)version=result[1];break;case"uc":result=ua.match(/UCBrowser\/([^\s]+)/i);if(result)version=result[1];break;case"zhongsou":result=ua.match(/souyue\/([^\s]+)/i);if(result)version=result[1];break;case"kwhlx":result=ua.match(/KuaiwanHuluxia\/([^\s]+)/i);if(result)version=result[1];break;case"ggzs":version=0;break};return version};Game9GUtils.prototype.compareVersion=function(version1,version2){var r1=version1.match(/(\d+)(?!\d)/ig);var r2=version2.match(/(\d+)(?!\d)/ig);if(r1==null)return false;if(r2==null)return true;var result=true;for(var i=0;i<99;i++){if(r2.length<i+1){result=true;break};var n1=parseInt(r1[i]);var n2=parseInt(r2[i]);if(n1!=n2){result=(n1>n2);break}};return result};Game9GUtils.prototype.isLocal=function(){if(localStorage.isLocal)return true;if(location.protocol=="file:")return true;if(location.hostname=="localhost"||location.hostname=="127.0.0.1"||location.hostname=="game")return true;return false};Game9GUtils.prototype.getOrigin=function(){if(window.location.origin){return window.location.origin}else{return window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}};Game9GUtils.prototype.getUrl=function(){if(location.origin&&location.pathname){return location.origin+location.pathname}else{return location.href.match(/[^?#]+/i)[0]}};Game9GUtils.prototype.getFullUrl=function(){return location.href.match(/[^#;]+/i)[0]};Game9GUtils.prototype.getPath=function(){if(location.pathname){return location.pathname}else{return location.href.match(/(?:http|https):\/\/[^\/]+([^?#;]+)/i)[1]}};Game9GUtils.prototype.getQueryString=function(){return location.search};Game9GUtils.prototype.getParameter=function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=window.location.search.substr(1).match(reg);if(r!=null)return r[2];return null};Game9GUtils.prototype.setParameter=function(url,name,value){url=url.replace(/(#.*)/ig,"");var reg=new RegExp("([\?&])"+name+"=([^&]*)(?=&|$)","i");if(reg.test(url)){return url.replace(reg,"$1"+name+"="+value)}else{return url+(url.indexOf("?")==-1?"?":"&")+name+"="+value}};Game9GUtils.prototype.removeParameter=function(url,name){url=url.replace(/(#.*)/ig,"");var reg=new RegExp("([\?&])"+name+"=([^&]*)(?=&|$)","i");if(reg.test(url)){url=url.replace(reg,"");if(url.indexOf("?")==-1)url=url.replace("&","?")};return url};Game9GUtils.prototype.location=function(url){window.location=url;var _this=this;setTimeout(function(){document.title+=".";_this.location(url)},3000)};Game9GUtils.prototype.locationReplace=function(url){window.location.replace(url);var _this=this;setTimeout(function(){document.title+=".";_this.locationReplace(url)},3000)};Game9GUtils.prototype.getShortUrl=function(url,callback){this.ajax("http://wx.9g.com/api/getshorturl?url="+encodeURIComponent(url),function(data){if(data&&data.errcode==0){callback&&callback.call(null,data.short_url)}})};Game9GUtils.prototype.getHead64=function(headimgurl){if(!headimgurl)return"http://game.9g.com/default.png";if(headimgurl.indexOf("/0")!=-1){headimgurl=headimgurl.substr(0,headimgurl.length-2)+"/64"};return headimgurl};Game9GUtils.prototype.getHead132=function(headimgurl){if(!headimgurl)return"http://game.9g.com/default.png";if(headimgurl.indexOf("/0")!=-1){headimgurl=headimgurl.substr(0,headimgurl.length-2)+"/132"};return headimgurl};Game9GUtils.prototype.htmlFilter=function(content){if(content==null||content==undefined)return"";var str="";if(typeof content!="string"){try{content=content.toString()}catch(e){}};return content.replace(/<[^>]+>/ig,"")};Game9GUtils.prototype.now=function(){var dt=new Date();dt.setMilliseconds(0);return dt.getTime()/1000};Game9GUtils.prototype.today=function(){var dt=new Date();dt.setHours(0,0,0,0);return dt.getTime()/1000};Game9GUtils.prototype.formatDate=function(){var date=arguments[0];var format=arguments[1]||"yyyy-MM-dd HH:mm:ss";if(typeof date=="number"){date=new Date(date*1000)};var paddNum=function(num){num+="";return num.replace(/^(\d)$/,"0$1")};var config={yyyy:date.getFullYear(),yy:date.getFullYear().toString().substring(2),M:date.getMonth()+1,MM:paddNum(date.getMonth()+1),d:date.getDate(),dd:paddNum(date.getDate()),HH:paddNum(date.getHours()),mm:paddNum(date.getMinutes()),ss:paddNum(date.getSeconds())};return format.replace(/([a-z])(\1)*/ig,function(m){return config[m]})};Game9GUtils.prototype.formatTime=function(){var t=arguments[0];var format=arguments[1]||"yyyy-MM-dd HH:mm:ss";if(t instanceof Date){t=t.getTime()/1000};var dts="";var diff=this.now()-t;if(diff<60){dts="刚刚"}else if(diff<60*60){dts=Math.floor(diff/60)+"分钟前"}else if(diff<60*60*24){dts=Math.floor(diff/60/60)+"小时前"}else{dts=this.formatDate(t,"MM-dd")};return dts};Game9GUtils.prototype.formatMoney=function(credit,options){if(credit===undefined||credit===""||isNaN(credit))return"";var defaults={symbol:true,unit:true,color:null,bold:false,space:false};options=this.extend(defaults,options);var s=(credit/100).toFixed(2);if(options.color)s="<span style='color:"+options.color+"'>"+s+"</span>";if(options.bold)s="<b>"+s+"</b>";s=(options.symbol?"￥":"")+s+(options.space?" ":"")+(options.unit?"元":"");return s};Game9GUtils.prototype.isArray=function(value){if(typeof Array.isArray==="function"){return Array.isArray(value)}else{return Object.prototype.toString.call(value)==="[object Array]"}};Game9GUtils.prototype.getRandomInt=function(min,max){return parseInt((Math.random()*(max-min+1))+min)};Game9GUtils.prototype.getRandomString=function(len){var base="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var str="";for(var i=0;i<len;i++){var n=this.getRandomInt(1,base.length)-1;str+=base.substr(n,1)};return str};Game9GUtils.prototype.getSessionId=function(){if(!sessionStorage.sessionid){sessionStorage.sessionid=this.getRandomString(40)};return sessionStorage.sessionid};Game9GUtils.prototype.shareConfirm=function(content,callback){var _this=this;this.game9g.autoSubmit(function(data){if(_this.game9g.source=="zoo"){window.location=_this.game9g.baseurl+"/zoo/second.html?animalid="+_this.game9g.animalid;return};if(_this.game9g.source=="chat"){var talker=_this.game9g.data.talker;_this.game9g.getRole(talker,function(role){_this.dialog({content:_this.game9g.shareData.title,buttonOK:{label:"分享给"+role.nickname,click:function(){window.location=_this.game9g.baseurl+"/app/chat.html?talker="+talker+"&action=game_play_result&gameid="+_this.game9g.gameid+"&score="+_this.game9g.score+"&scorename="+encodeURIComponent(_this.game9g.scoreName)+"&title="+_this.game9g.shareData.title}},buttonCancel:{label:"返回游戏"}})});return};if(_this.game9g.source=="feed_pk"){var feedId=_this.game9g.data.feed_id;if(feedId){_this.game9g.addFeedComment(feedId,_this.game9g.shareData.title,function(data){_this.debug(data)})}}});if(this.game9g.sp){if(this.game9g.shareData.title.indexOf(this.game9g.sp.spname)==-1)this.game9g.shareData.title+="["+this.game9g.sp.spname+"]";if(this.game9g.shareData.content.indexOf(this.game9g.sp.spname)==-1)this.game9g.shareData.content+="["+this.game9g.sp.spname+"]"};setTimeout(function(){switch(_this.getAppType()){case"wx":_this.game9g.setShareData();break;case"9g":case"pengpeng":_this.game9g.setShareData();break;default:if(_this.game9g.app){if(confirm(content)){callback&&callback.apply(null)}};break}},500)};Game9GUtils.prototype.shareTip=function(force){if(!force)return;if(document.getElementById("game9gshareevent"))return;var img=document.createElement("img");img.id="game9gshareevent";img.src="http://game.9g.com/img/sharetip.gif";img.className="game9gshareevent";document.getElementsByTagName("body")[0].appendChild(img);var mask=document.createElement("div");mask.id="game9gsharemask";mask.className="game9gsharemask";document.getElementsByTagName("body")[0].appendChild(mask);var _this=this;mask.addEventListener("touchstart",function(e){_this.closeShareTip();e.preventDefault()})};Game9GUtils.prototype.closeShareTip=function(){var img=document.getElementById("game9gshareevent");if(img)img.parentElement.removeChild(img);var mask=document.getElementById("game9gsharemask");if(mask)mask.parentElement.removeChild(mask)};Game9GUtils.prototype.dialog=function(options){var defaults={title:null,content:"",buttons:[],buttonOK:null,buttonCancel:null};options=this.extend(defaults,options);this._dialog=new Game9GUtilsDialog(this.game9g,options);this._dialog.open()};Game9GUtils.prototype.closeDialog=function(){this._dialog&&this._dialog.close()};Game9GUtils.prototype.alert=function(content,callback){this.dialog({content:content,buttonOK:{label:"好",click:callback}})};Game9GUtils.prototype.tip=function(content,time){this.dialog({content:content});var _this=this;setTimeout(function(){_this.closeDialog()},time||2000)};Game9GUtils.prototype.confirm=function(content,ok,cancel){this.dialog({content:content,buttonOK:{click:function(){ok&&ok.call(null)}},buttonCancel:{click:function(){cancel&&cancel.call(null)}}})};Game9GUtils.prototype.prompt=function(){var text=arguments[0];var defVal="";var callback=null;if(typeof arguments[1]=="string")defVal=arguments[1];if(typeof arguments[1]=="function")callback=arguments[1];if(typeof arguments[2]=="function")callback=arguments[2];var content=text+"<input id='game9gdialogprompt' value='"+defVal+"' placeholder='请在此输入内容' />";this.dialog({content:content,buttonOK:{click:function(){var value=document.getElementById("game9gdialogprompt").value;callback&&callback.call(null,value)}},buttonCancel:{}})};Game9GUtilsDialog=function(game9g,options){this.game9g=game9g;this.options=options;this.init()};Game9GUtilsDialog.prototype.init=function(){if(this.options.buttonOK){this.options.buttons.push(this.game9g.utils.extend({label:"确定",color:"#FFFFFF",bgcolor:"#FF0000",click:null},this.options.buttonOK))};if(this.options.buttonCancel){this.options.buttons.push(this.game9g.utils.extend({label:"取消",color:"#FFFFFF",bgcolor:"#888888",click:null},this.options.buttonCancel))}};Game9GUtilsDialog.prototype.open=function(){this.close();var div=document.createElement("div");div.id="game9gdialog";div.className="game9gdialog";if(this.options.title!=null){var header=document.createElement("div");header.className="game9gdialogheader";header.innerHTML=this.options.title;div.appendChild(header)};var content=document.createElement("div");content.className="game9gdialogcontent";content.innerHTML=this.options.content.replace(/\n/g,"<br/>");div.appendChild(content);if(this.options.buttons.length>0){var footer=document.createElement("div");footer.className="game9gdialogfooter";div.appendChild(footer);var _this=this;var cls="game9gdialogbutton"+this.options.buttons.length;for(var i=0;i<this.options.buttons.length;i++){(function(btn){var a=document.createElement("a");a.className=cls;a.innerHTML=btn.label;if(btn.color)a.style.color=btn.color;if(btn.bgcolor)a.style.backgroundColor=btn.bgcolor;var onclick=function(e){btn.click&&btn.click.apply(_this.game9g);_this.close();e.preventDefault()};a.addEventListener("touchstart",onclick);a.addEventListener("mousedown",onclick);footer.appendChild(a)})(this.options.buttons[i])}};document.getElementsByTagName("body")[0].appendChild(div);var mask=document.createElement("div");mask.id="game9gmask";mask.className="game9gmask";document.getElementsByTagName("body")[0].appendChild(mask)};Game9GUtilsDialog.prototype.close=function(e){var div=document.getElementById("game9gdialog");if(div)document.getElementsByTagName("body")[0].removeChild(div);var mask=document.getElementById("game9gmask");if(mask)document.getElementsByTagName("body")[0].removeChild(mask);e&&e.preventDefault()};Game9GUtils.prototype.wait=function(time){var mask=document.createElement("div");mask.id="game9gmask";mask.className="game9gmask";document.getElementsByTagName("body")[0].appendChild(mask);var img=document.createElement("img");img.id="game9gwait";img.className="game9gwait";img.src="http://game.9g.com/img/loading3.gif";document.getElementsByTagName("body")[0].appendChild(img);if(time){var _this=this;setTimeout(function(){_this.closeWait()},time)}};Game9GUtils.prototype.closeWait=function(){var img=document.getElementById("game9gwait");if(img)document.getElementsByTagName("body")[0].removeChild(img);var mask=document.getElementById("game9gmask");if(mask)document.getElementsByTagName("body")[0].removeChild(mask)};Game9GUtils.prototype.progress=function(options){this.closeProgress();var defaults={content:"",time:10,showCancel:false,cancelText:"取消",onCancel:null,cancelEvent:null,timeoutText:null,onTimeout:null,closeOnTimeout:false,timeoutBtns:[]};options=this.extend(defaults,options);var _this=this;var text=document.createElement("div");var btns=document.createElement("div");if(options.showCancel){var btn=document.createElement("a");btn.innerHTML=options.cancelText;btn.addEventListener("touchstart",function(e){_this.closeProgress();options.onCancel&&options.onCancel.call(null);e.preventDefault()});btns.appendChild(btn)};if(options.cancelEvent){this.game9g.addEventListener(options.cancelEvent,function(){_this.closeProgress()},true)};var timeoutCallback=function(){if(options.timeoutText){text.innerHTML=options.timeoutText};btns.innerHTML="";if(options.closeOnTimeout){_this.closeProgress()}else{for(var i=0;i<options.timeoutBtns.length;i++){var defaultBtn={label:"",color:"#FFFFFF",bgcolor:"#FBC71B",again:false,cancel:false,click:null};var item=_this.extend(defaultBtn,options.timeoutBtns[i]);(function(item){var btn=document.createElement("a");btn.innerHTML=item.label;btn.style.color=item.color;btn.style.backgroundColor=item.bgcolor;btn.addEventListener("touchstart",function(e){if(item.again){_this.progress(options)}else if(item.cancel){_this.closeProgress();options.onCancel&&options.onCancel.call(null)};item.click&&item.click.call(null);e.preventDefault()});btns.appendChild(btn)})(item)}};options.onTimeout&&options.onTimeout.call(null)};var mask=document.createElement("div");mask.id="game9gprogressmask";mask.className="game9gprogressmask";document.getElementsByTagName("body")[0].appendChild(mask);var div=document.createElement("div");div.id="game9gprogress";div.className="game9gprogress";document.getElementsByTagName("body")[0].appendChild(div);var rightwrap=document.createElement("div");rightwrap.className="game9gprogresswrap rightprogress";div.appendChild(rightwrap);var rightcircle=document.createElement("div");rightcircle.className="game9gprogresscircle rightcircle";rightwrap.appendChild(rightcircle);var leftwrap=document.createElement("div");leftwrap.className="game9gprogresswrap leftprogress";div.appendChild(leftwrap);var leftcircle=document.createElement("div");leftcircle.className="game9gprogresscircle leftcircle";leftwrap.appendChild(leftcircle);text.id="game9gprogresstext";text.className="game9gprogresstext";text.innerHTML=options.content;div.appendChild(text);rightcircle.style.webkitAnimation="circleloadright "+options.time+"s linear";rightcircle.style.webkitAnimationFillMode="forwards";rightcircle.style.animation="circleloadright "+options.time+"s linear";rightcircle.style.animationFillMode="forwards";leftcircle.style.animation="circleloadleft "+options.time+"s linear";leftcircle.style.animationFillMode="forwards";leftcircle.style.webkitAnimation="circleloadleft "+options.time+"s linear";leftcircle.style.webkitAnimationFillMode="forwards";leftcircle.addEventListener("animationend",timeoutCallback);leftcircle.addEventListener("webkitAnimationEnd",timeoutCallback);btns.id="game9gprogressbtns";btns.className="game9gprogressbtns";btns.style.top=(this.vh2px(20)+this.vw2px(60+3))+"px";document.getElementsByTagName("body")[0].appendChild(btns)};Game9GUtils.prototype.closeProgress=function(){var div=document.getElementById("game9gprogress");if(div)div.parentElement.removeChild(div);var btns=document.getElementById("game9gprogressbtns");if(btns)btns.parentElement.removeChild(btns);var mask=document.getElementById("game9gprogressmask");if(mask)mask.parentElement.removeChild(mask)};Game9GUtils.prototype.countDown=function(options){var defaults={name:this.getRandomInt(10000000,20000000)+"",time:60,onTimer:null,onTimeout:null};options=this.extend(defaults,options);var _this=this;var timer=function(){options.onTimer&&options.onTimer.call(null,options.time);if(options.time<=0){options.onTimeout&&options.onTimeout.call(null)}else{_this["countDownTimer_"+options.name]=setTimeout(function(){options.time--;timer()},1000)}};timer()};Game9GUtils.prototype.cancelCountDown=function(name){clearTimeout(this["countDownTimer_"+name])};Game9GUtils.prototype.require=function(list,callback){if(!list)return;if(typeof list=="string")list=[list];if(list.length==0){callback&&callback.call(null);return};var url=list.shift();var head=document.getElementsByTagName("head")[0]||document.documentElement;var node=document.createElement("script");var _this=this;node.addEventListener("load",function(e){_this.require(list,callback)});node.addEventListener("error",function(e){var message="require fail on "+url;_this.debug(message)});node.async=true;node.src=url;head.appendChild(node)};Game9GUtils.prototype.ajax=function(){var options={method:"GET",url:"",data:null,type:"json",success:null,tag:null};switch(arguments.length){case 1:if(typeof arguments[0]=="string")options.url=arguments[0];if(typeof arguments[0]=="object")options=this.extend(options,arguments[0]);break;case 2:options.url=arguments[0];options.success=arguments[1];break;case 3:options.url=arguments[0];options.success=arguments[1];if(typeof arguments[2]=="string")options.tag=arguments[2];break};options.url=this.setParameter(options.url,"_",Math.random());new Game9GUtilsAjax(this.game9g,options.method,options.url,options.data,options.type,options.success,options.tag)};Game9GUtils.prototype.jsonp=function(url,data,jsonparam,success){url=this.setParameter(url,"_",Math.random());new Game9GUtilsJsonp(url,data,jsonparam,success).request()};Game9GUtilsAjax=function(game9g,method,url,data,type,success,tag){this.game9g=game9g;this.url=url;this.type=type;this.success=success;this.xhr=null;if(tag){var xhrTag="xhr_"+tag;this.game9g.utils[xhrTag]=this.game9g.utils[xhrTag]||this.createXHR();this.xhr=this.game9g.utils[xhrTag]}else{this.xhr=this.createXHR()};var _this=this;this.xhr.onreadystatechange=function(){_this.callback.apply(_this)};if(typeof data=="object"&&data!=null){var a=[];for(var p in data){a.push(p+"="+encodeURIComponent(data[p]))};data=a.join("&")};try{this.xhr.open(method,url,true);if(method.toUpperCase()=="POST"){this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")};this.xhr.send(data)}catch(e){console.log(url);console.log(e)}};Game9GUtilsAjax.prototype.createXHR=function(){if(window.XMLHttpRequest){return new XMLHttpRequest()}else{return new ActiveXObject("Microsoft.XMLHTTP")}};Game9GUtilsAjax.prototype.callback=function(){if(this.xhr.readyState==4&&this.xhr.status==200){var data=null;switch(this.type){case"text":data=this.xhr.responseText;break;case"json":try{data=JSON.parse(this.xhr.responseText)}catch(e){data=this.xhr.responseText};break};this.success&&this.success.call(this.xhr,data)}else if(this.xhr.readyState==4&&this.xhr.status!=200){_czc.push(["_trackEvent","ajax","fail","["+this.xhr.readyState+","+this.xhr.status+"]"+this.url])}};Game9GUtilsJsonp=function(url,data,jsonparam,success,timeout){var finish=false;var theHead=document.getElementsByTagName("head")[0]||document.documentElement;var scriptControll=document.createElement("script");var jsonpcallback="jsonpcallback"+(Math.random()+"").substring(2);var collect=function(){if(theHead!=null){theHead.removeChild(scriptControll);try{delete window[jsonpcallback]}catch(ex){};theHead=null}};var init=function(){scriptControll.charset="utf-8";theHead.insertBefore(scriptControll,theHead.firstChild);window[jsonpcallback]=function(responseData){finish=true;success(responseData)};jsonparam=jsonparam||"callback";if(url.indexOf("?")>0){url=url+"&"+jsonparam+"="+jsonpcallback}else{url=url+"?"+jsonparam+"="+jsonpcallback};if(typeof data=="object"&&data!=null){for(var p in data){url=url+"&"+p+"="+escape(data[p])}}};var timer=function(){if(typeof window[jsonpcallback]=="function"){collect()};if(typeof timeout=="function"&&finish==false){timeout()}};this.request=function(){init();scriptControll.src=url;window.setTimeout(timer,10000)}};Game9GUtils.prototype.loading=function(){var div=document.createElement("div");div.id="game9gloading";var isPC=window.innerWidth>window.innerHeight;div.className="game9gloading"+(isPC?" pc":"");if(this.game9g.cpid){div.innerHTML="<img class='game9glogo_up' src='http://game.9g.com/img/slogan.png' /><img class='cplogo' src='http://game.9g.com/"+this.game9g.gameid+"/cplogo.png' />"}else{div.innerHTML="<img class='game9glogo' src='http://game.9g.com/img/slogan.png' />"};if(this.game9g.sp&&this.game9g.sp.logo){div.innerHTML+="<img class='splogo' src='"+this.game9g.sp.logo+"' />"};document.getElementsByTagName("body")[0].appendChild(div);var interval=((this.getAppType()=="9g"||this.getAppType()=="pengpeng")?1000:1500);var _this=this;setTimeout(function(){document.getElementsByTagName("body")[0].removeChild(div);var complete=function(){_this.game9g.loadingComplete=true;_this.game9g.dispatchEvent("loadingComplete")};if(_this.game9g.ui.start){_this.game9g.ui.start.flyIn(complete)}else{complete()}},interval)};Game9GUtils.prototype.loadingSp=function(){var img=document.createElement("img");img.src=this.game9g.sp.loading;img.style.position="fixed";img.style.zIndex=9999;img.style.width="100%";img.style.left=0;img.style.top=0;document.getElementsByTagName("body")[0].appendChild(img);if(this.game9g.sp.spname){document.title=this.game9g.sp.spname};var _this=this;setTimeout(function(){document.getElementsByTagName("body")[0].removeChild(img);if(_this.game9g.sp.spname){document.title=_this.game9g.sp.spname};_this.game9g.loadingComplete=true;_this.game9g.dispatchEvent("loadingComplete")},1500)};Game9GUtils.prototype.showAd=function(){var url;var _this=this;if(this.game9g.game&&this.game9g.game.showAd){url="http://pp.9g.com/ad/getad?token=&url=popupad";this.ajax(url,function(data){if(data&&data.length>0){var ads=data[0].ad_json;var ad=ads[_this.getRandomInt(0,ads.length-1)];var mask=document.createElement("div");mask.className="game9gadpopupmask";document.getElementsByTagName("body")[0].appendChild(mask);var div=document.createElement("div");div.className="game9gadpopup";document.getElementsByTagName("body")[0].appendChild(div);var img=document.createElement("img");img.className="game9gadpopupimg";img.src=ad.img;div.appendChild(img);var goad=function(e){window.location=ad.url;e.preventDefault()};img.addEventListener("touchstart",goad);img.addEventListener("mousedown",goad);var x=document.createElement("img");x.className="game9gadpopupclose";x.src="http://game.9g.com/img/close.png";div.appendChild(x);var close=function(e){div.parentElement.removeChild(div);mask.parentElement.removeChild(mask);e.preventDefault()};x.addEventListener("touchstart",close);x.addEventListener("mousedown",close);mask.addEventListener("touchstart",close);mask.addEventListener("mousedown",close)}})};if(this.game9g.spid=="uc"&&this.getAppType()!="uc"){url="http://wx.9g.com/pm/get.jsp?spid="+this.game9g.spid;this.ajax(url,function(data){if(data.ad){var img=document.createElement("img");img.id="game9gadtop";img.className="game9gadtop";img.src=data.ad.imgurl;img.addEventListener("touchstart",function(e){window.location="http://wx.9g.com/pm/click.jsp?id="+data.ad.id;e.preventDefault()});document.getElementsByTagName("body")[0].appendChild(img)}})};if(this.game9g.spid=="zhongsou"&&this.getAppType()!="zhongsou"){var isZhousouInstalled=(this.getParameter("isappinstalled")=="1");url="http://wx.9g.com/pm/get.jsp?spid="+this.game9g.spid;this.ajax(url,function(data){if(data.ad){var img=document.createElement("img");img.id="game9gadbottom";img.className="game9gadbottom";img.src=data.ad.imgurl;img.addEventListener("touchstart",function(e){if(isZhousouInstalled){if(_this.getAppType()=="wx"){var tip=document.createElement("img");tip.id="game9gzhongsoutip";tip.className="game9gzhongsoutip";tip.src="http://game.9g.com/img/"+(_this.isIOS()?"zhongsou_share_ios.png":"zhongsou_share_android.png");document.getElementsByTagName("body")[0].appendChild(tip)}else{window.location="wx360a9785675a8653://"}}else{window.location="http://wx.9g.com/pm/click.jsp?id="+data.ad.id};e.preventDefault()});document.getElementsByTagName("body")[0].appendChild(img)}})}};Game9GUtils.prototype.vw2px=function(n){return(parseFloat(n)*window.innerWidth/100)};Game9GUtils.prototype.vh2px=function(n){return(parseFloat(n)*window.innerHeight/100)};Game9GUtils.prototype.vw2pxs=function(n){return(parseFloat(n)*window.innerWidth/100)+'px'};Game9GUtils.prototype.vh2pxs=function(n){return(parseFloat(n)*window.innerHeight/100)+'px'};Game9GUtils.prototype.debug=function(obj){if(this.game9g.isTest()){alert("[DEBUG]\n"+this.describe(obj))}};Game9GUtils.prototype.describe=function(obj,tab){tab=tab||"";var content="";if(typeof obj=="object"&&obj!=null){for(var item in obj){if(typeof obj[item]=="object"&&obj[item]!=null)content+=tab+item+" = \n"+tab+"(\n"+this.describe(obj[item],tab+"    ")+tab+")\n";else content+=tab+item+" = "+obj[item]+"\n"}}else{content+=tab+obj};return content};Game9GUtils.prototype.encrypt=function(key,word){var iv=CryptoJS.enc.Utf8.parse(key);var srcs=CryptoJS.enc.Utf8.parse(word);var encrypted=CryptoJS.AES.encrypt(srcs,CryptoJS.enc.Utf8.parse(key),{iv:iv,mode:CryptoJS.mode.CBC});return encrypted.toString()};Game9GUtils.prototype.onCryptoJSReady=function(callback){if(typeof window.CryptoJS=="object"){callback&&callback.call(null)}else{if(!this.isCryptoJSLoading){this.isCryptoJSLoading=true;var _this=this;this.require("http://game.9g.com/js/cryptojs.aes.js",function(){_this.game9g.dispatchEvent("cryptoJSReady")})};this.game9g.addEventListener("cryptoJSReady",callback)}};Game9GUtils.prototype.onQRCodeReady=function(callback){if(typeof window.QRCode=="function"){callback&&callback.call(null)}else{if(!this.isQRCodeLoading){this.isQRCodeLoading=true;var _this=this;this.require("http://game.9g.com/js/qrcode.min.js",function(){_this.game9g.dispatchEvent("qrCodeReady")})};this.game9g.addEventListener("qrCodeReady",callback)}};Game9GUtils.prototype.track=function(){var action=null;var value=null;var memo=null;var callback=null;switch(arguments.length){case 1:action=arguments[0];break;case 2:action=arguments[0];if(!isNaN(arguments[1]))value=arguments[1];if(typeof arguments[1]=="function")callback=arguments[1];break;case 3:action=arguments[0];value=arguments[1];if(typeof arguments[2]=="string")memo=arguments[2];if(typeof arguments[2]=="function")callback=arguments[2];break;case 4:action=arguments[0];value=arguments[1];memo=arguments[2];callback=arguments[3];break};if(action==null){this.debug("track ERROR: 要求 action");return};var url="http://wx.9g.com/open/track?action="+encodeURIComponent(action);if(value!=null)url=this.setParameter(url,"value",value);if(memo!=null)url=this.setParameter(url,"memo",encodeURIComponent(memo));if(this.game9g.gameid)url=this.setParameter(url,"gameid",this.game9g.gameid);if(localStorage.myuid)url=this.setParameter(url,"uid",localStorage.myuid);this.ajax(url,function(data){if(data.success){callback&&callback.call(null,data.track_id)}else{callback&&callback.call(null,0)}})};Game9GUtils.prototype.heartbeat=function(){if(this.isLocal())return;var lastTime=sessionStorage.heartbeatTime||0;var thisTime=new Date().getTime();if(thisTime-lastTime<3000)return;else sessionStorage.heartbeatTime=thisTime;var rnd=this.getRandomString(10);var url="http://log.9g.com/app/heart/"+rnd+"?url="+encodeURIComponent(location.href)+"&path="+encodeURIComponent(this.getPath());if(this.game9g.gameid)url+="&gameid="+this.game9g.gameid;if(localStorage.token)url+="&token="+localStorage.token;if(localStorage.accessToken)url+="&access_token="+localStorage.accessToken;url+="&sessionid="+this.getSessionId();if(this.heartbeatDetailId)url+="&detail_id="+this.heartbeatDetailId;var _this=this;this.ajax(url,function(data){if(data&&data.detail_id){_this.heartbeatDetailId=data.detail_id}},"heartbeat");setTimeout(function(){_this.heartbeat()},10000)};Game9GUtils.prototype.logView=function(){if(this.isLocal())return;var rnd=this.getRandomString(10);var url="http://log.9g.com/log/view/"+rnd+"?url="+encodeURIComponent(location.href)+"&path="+encodeURIComponent(this.getPath())+"&domain="+location.hostname;if(localStorage.myuid)url=this.setParameter(url,"id",localStorage.myuid);if(localStorage.token)url=this.setParameter(url,"token",localStorage.token);if(this.game9g.gameid)url=this.setParameter(url,"gameid",this.game9g.gameid);if(this.game9g.spid)url=this.setParameter(url,"spid",this.game9g.spid);url=this.setParameter(url,"app_type",this.getAppType());if(this.getAppVersion())url=this.setParameter(url,"app_version",this.getAppVersion());if(this.game9g.user){var country=this.game9g.user.country||"";var province=this.game9g.user.province||"";var city=this.game9g.user.city||"";if(country||province||city){url=this.setParameter(url,"country",encodeURIComponent(country));url=this.setParameter(url,"province",encodeURIComponent(province));url=this.setParameter(url,"city",encodeURIComponent(city))}};this.ajax(url,function(data){})};Game9GUtils.prototype.tongji=function(options){var defaults={baidu:{},cnzz:{id:2947366}};options=this.extend(defaults,options);try{}catch(e){console.error(e)}};Game9GWx=function(game9g){this.game9g=game9g;this.version=null;this.ready=false;this.shareOK=null;this.shareCancel=null;this.init()};Game9GWx.prototype.init=function(){this.version=this.game9g.utils.getAppVersion();if(!this.game9g.isInit)return;var _this=this;this.onReady(function(){_this.restrictShare();_this.setShareData();});_this.initJsApi()};Game9GWx.prototype.isVersionOver=function(version){return this.game9g.utils.compareVersion(this.version,version)};Game9GWx.prototype.initWeixinJSBridge=function(){var _this=this;document.addEventListener("WeixinJSBridgeReady",function onBridgeReady(){WeixinJSBridge.on("menu:share:appmessage",function(argv){WeixinJSBridge.invoke("sendAppMessage",{"img_url":_this.game9g.shareData.imgurl,"link":_this.game9g.shareData.link,"desc":_this.game9g.shareData.content,"title":_this.game9g.shareData.title},function(res){if(res.err_msg=="send_app_msg:cancel"){_this.shareCancelHandler()}else{_this.shareOKHandler()}})});WeixinJSBridge.on("menu:share:timeline",function(argv){WeixinJSBridge.invoke("shareTimeline",{"img_url":_this.game9g.shareData.imgurl,"img_width":"640","img_height":"640","link":_this.game9g.shareData.link,"desc":_this.game9g.shareData.content,"title":_this.game9g.shareData.title},function(res){if(res.err_msg=="share_timeline:cancel"){_this.shareCancelHandler()}else{_this.shareOKHandler()}})})},false)};Game9GWx.prototype.initJsApi=function(){var timestamp=this.game9g.utils.now();var noncestr=this.game9g.utils.getRandomString(16);var rnd=this.game9g.utils.getRandomString(10);var url=this.game9g.utils.getFullUrl();var ajaxUrl=this.game9g.getWxServer()+"/api/getjsapisignature/"+rnd+"?noncestr="+noncestr+"&timestamp="+timestamp+"&url="+encodeURIComponent(url);var _this=this;this.game9g.utils.ajax(ajaxUrl,function(data){if(data.signature){var signature=data.signature;wx.config({debug:false,appId:data.appid,timestamp:timestamp,nonceStr:noncestr,signature:signature,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","translateVoice","startRecord","stopRecord","onRecordEnd","playVoice","pauseVoice","stopVoice","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard"]});wx.ready(function(){_this.ready=true;_this.game9g.dispatchEvent("wxReady")});wx.error(function(res){})}})};Game9GWx.prototype.onReady=function(callback){if(this.ready){callback&&callback.call(this)}else{var _this=this;this.game9g.addEventListener("wxReady",function(){callback&&callback.call(_this)})}};Game9GWx.prototype.restrictShare=function(){if(this.game9g.isOpenSp){wx.hideMenuItems({menuList:["menuItem:share:appMessage","menuItem:share:timeline","menuItem:share:email"]})}else{wx.hideMenuItems({menuList:["menuItem:share:timeline","menuItem:share:email"]})}};Game9GWx.prototype.setShareData=function(){var _this=this;wx.onMenuShareTimeline({title:this.game9g.shareData.title,link:this.game9g.shareData.link,imgUrl:this.game9g.shareData.imgurl,success:function(){var options={gameid:_this.game9g.gameid,spid:_this.game9g.spid,id:localStorage.myuid||null,source:1,type:1,domain:(((_this.game9g.shareData.link||"").indexOf(_this.game9g.shareDomain)!=-1)?_this.game9g.shareDomain:null)};_this.game9g.shareLog(options,function(){_this.shareOKHandler()})},cancel:function(){_this.shareCancelHandler()}});wx.onMenuShareAppMessage({title:this.game9g.shareData.title,desc:this.game9g.shareData.content,link:this.game9g.shareData.link,imgUrl:this.game9g.shareData.imgurl,type:"",dataUrl:"",success:function(){var options={gameid:_this.game9g.gameid,spid:_this.game9g.spid,id:localStorage.myuid||null,source:2,type:1,domain:(((_this.game9g.shareData.link||"").indexOf(_this.game9g.shareDomain)!=-1)?_this.game9g.shareDomain:null)};_this.game9g.shareLog(options,function(){_this.shareOKHandler()})},cancel:function(){_this.shareCancelHandler()}})};Game9GWx.prototype.share=function(){this.setShareData();if(this.game9g.gameid){this.game9g.shareFlow()}};Game9GWx.prototype.shareOKHandler=function(){_czc.push(["_trackEvent","分享","成功"]);this.game9g.postShareOK();this.shareOK&&this.shareOK.apply(this.game9g);};Game9GWx.prototype.shareCancelHandler=function(){this.shareCancel&&this.shareCancel.apply(this.game9g);};Game9GWx.prototype.chooseImage=function(callback){wx.chooseImage({count:1,success:function(res){var localIds=res.localIds;callback&&callback.call(null,localIds[0])}})};Game9GWx.prototype.chooseImages=function(callback){wx.chooseImage({count:9,success:function(res){var localIds=res.localIds;callback&&callback.call(null,localIds)}})};Game9GWx.prototype.uploadImage=function(localId,callback){wx.uploadImage({localId:localId,isShowProgressTips:1,success:function(res){var serverId=res.serverId;callback&&callback.call(null,serverId)}})};Game9GWx.prototype.uploadImages=function(localIds,callback){if(!(localIds instanceof Array)||localIds.length==0)return;var a=localIds.slice();var b=[];var _this=this;var loop=function(){if(a.length>0){var localId=a.shift();_this.uploadImage(localId,function(serverId){b.push(serverId);loop()})}else{callback&&callback.call(null,b)}};loop()};Game9GWx.prototype.getMediaUrl=function(mediaId,callback){var url="http://app.9g.com/uploadwx.jsp?media_id="+mediaId;this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data[0])})};Game9GWx.prototype.getMediaUrls=function(mediaIds,callback){if(!(mediaIds instanceof Array)||mediaIds.length==0)return;var url="http://app.9g.com/uploadwx.jsp";for(var i=0;i<mediaIds.length;i++){url+=((i==0?"?":"&")+"media_id="+mediaIds[i])};this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9GWx.prototype.getSquareImage=function(mediaId,callback){var url="http://app.9g.com/cropwx.jsp?media_id="+mediaId;this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data[0])})};Game9GWx.prototype.getSquareImages=function(mediaIds,callback){if(!(mediaIds instanceof Array)||mediaIds.length==0)return;var url="http://app.9g.com/cropwx.jsp";for(var i=0;i<mediaIds.length;i++){url+=((i==0?"?":"&")+"media_id="+mediaIds[i])};this.game9g.utils.ajax(url,function(data){callback&&callback.call(null,data)})};Game9GWx.prototype.startRecord=function(callback){wx.startRecord();wx.onVoiceRecordEnd({complete:function(res){var localId=res.localId;callback&&callback.call(null,localId)}})};Game9GWx.prototype.stopRecord=function(callback){wx.stopRecord({success:function(res){var localId=res.localId;callback&&callback.call(null,localId)}})};Game9GWx.prototype.playVoice=function(localId,callback){wx.playVoice({localId:localId});wx.onVoicePlayEnd({success:function(res){var localId=res.localId;callback&&callback.call(null,localId)}})};Game9GWx.prototype.pauseVoice=function(localId){wx.pauseVoice({localId:localId})};Game9GWx.prototype.stopVoice=function(localId){wx.stopVoice({localId:localId})};Game9GWx.prototype.uploadVoice=function(localId,callback){wx.uploadVoice({localId:localId,isShowProgressTips:1,success:function(res){var serverId=res.serverId;callback&&callback.call(null,serverId)}})};Game9GWx.prototype.chooseWXPay=function(data,callback){wx.chooseWXPay({timestamp:data.timeStamp,nonceStr:data.nonceStr,package:data.package,signType:data.signType,paySign:data.paySign,success:function(res){callback&&callback.call(null,res)}})};Game9GWx.prototype.close=function(){wx.closeWindow()};Game9GQQ=function(game9g){this.game9g=game9g;this.version=null;this.type=null;this.ready=false;this.shareOK=null;this.shareCancel=null;this.init()};Game9GQQ.prototype.init=function(){this.version=this.game9g.utils.getAppVersion();this.type=(this.game9g.utils.isIOS()||/uuid\sios/ig.test(navigator.userAgent))?"iOS":"Android";if(!this.game9g.isInit)return;var _this=this;var qqapi="http://pub.idqqimg.com/qqmobile/qqapi.js?_bid=152";this.game9g.utils.require(qqapi,function(){_this.ready=true;_this.setShareData();_this.game9g.dispatchEvent("qqReady")})};Game9GQQ.prototype.isVersionOver=function(version){return this.game9g.utils.compareVersion(this.version,version)};Game9GQQ.prototype.onReady=function(callback){if(this.ready){callback&&callback.call(this)}else{var _this=this;this.game9g.addEventListener("qqReady",function(){callback&&callback.call(_this)})}};Game9GQQ.prototype.setShareData=function(){var _this=this;this.onReady(function(){var shareInfo={title:_this.game9g.shareData.title,desc:_this.game9g.shareData.content,image_url:_this.game9g.shareData.imgurl,share_url:_this.game9g.shareData.link};window.mqq.data.setShareInfo(shareInfo);})};Game9GQQ.prototype.share=function(){this.setShareData();this.game9g.utils.shareTip()};Game9GQQHall=function(game9g){this.game9g=game9g;this.version=null;this.type=null;this.ready=false;this.shareOK=null;this.shareCancel=null;this.init()};Game9GQQHall.prototype.init=function(){this.version=this.game9g.utils.getAppVersion();this.type=(this.game9g.utils.isIOS()||/uuid\sios/ig.test(navigator.userAgent))?"iOS":"Android"};Game9GQQHall.prototype.startPay=function(data){};Game9GApp=function(game9g){this.game9g=game9g;this.version=null;this.type=null;this.shareOK=null;this.shareCancel=null;this.oldTitle=null;this.init()};Game9GApp.prototype.init=function(){this.version=this.game9g.utils.getAppVersion();this.type=(this.game9g.utils.isIOS()||/uuid\sios/ig.test(navigator.userAgent))?"iOS":"Android";var _this=this;window.game9gWxShareOK=function(){_this.shareOK&&_this.shareOK.apply(_this.game9g)};window.game9gWxShareCancel=function(){_this.shareCancel&&_this.shareCancel.apply(_this.game9g)};document.addEventListener("game9gWxShareOk",function(){if(_this.oldTitle)document.title=_this.oldTitle;_this.shareOK&&_this.shareOK.apply(_this.game9g)})};Game9GApp.prototype.isVersionOver=function(version){return this.game9g.utils.compareVersion(this.version,version)};Game9GApp.prototype.setShareData=function(){if(this.type=="iOS"){window.location="appcall::setwxshare::"+this.game9g.shareData.link+"::"+this.game9g.shareData.title+"::"+this.game9g.shareData.content+"::"+this.game9g.shareData.imgurl}else if(this.type=="Android"){if(this.isVersionOver("2.0")){window.game9gapp&&game9gapp.setShareData(JSON.stringify(this.game9g.shareData))}else{this.oldTitle=document.title;var space="9G............................................................|";document.title=space+this.game9g.shareData.link+"|"+this.game9g.shareData.title+"|"+this.game9g.shareData.content+"|"+this.game9g.shareData.imgurl}}};Game9GApp.prototype.share=function(){if(this.type=="iOS"){this.setShareData();if(this.game9g.gameid){this.game9g.shareFlow()}}else{window.game9gapp&&game9gapp.share(JSON.stringify(this.game9g.shareData))}};Game9GApp.prototype.onInitGame=function(){if(this.type=="iOS"){if(this.game9g.game&&this.game9g.game.gameType==2){location.href="game9g://setfullscreen"}}else{window.game9gapp&&game9gapp.onInitGame(this.game9g.gameid)}};Game9GApp.prototype.onAutoSubmit=function(data){data.score=this.game9g.score;data.scoreName=this.game9g.scoreName;data.title=this.game9g.shareData.title;if(this.type=="iOS"){}else{window.game9gapp&&game9gapp.onAutoSubmit(JSON.stringify(data))}};Game9GApp.prototype.getToken=function(){var token=null;if(this.type=="Android"){if(window.game9gapp)token=game9gapp.getToken()};return token};Game9GApp.prototype.login=function(origin){try{var token=game9gapp.getToken();var url="http://wx.9g.com/app/login?token="+token;var _this=this;this.game9g.utils.ajax(url,function(data){if(data&&data.uid){game9gapp.onLoginSuccess(JSON.stringify(data));var redirect=_this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(origin)+(data.accessToken?"&access_token="+data.accessToken:"")+(token?"&token="+token:"")+(data.wx9guid?"&myuid="+data.wx9guid:"");window.location.replace(redirect)}else{_this.game9g.auth.clear();game9gapp.onLoginFail()}})}catch(e){window.location=this.game9g.baseurl+"/app/login.html?r="+Math.random()}};Game9GApp.prototype.chat=function(roleid){window.game9gapp&&game9gapp.chat(roleid)};Game9GApp.prototype.cssHack=function(url){if(!window.game9gapp)return;var css=game9gapp.cssHack(url,window.innerWidth,window.innerHeight);if(css){var style=document.createElement("style");style.textContent=css;document.getElementsByTagName("head")[0].appendChild(style)}};Game9GApp.prototype.onShowPay=function(){if(this.type=="iOS"){top.location="game9gpay://onShowPay"}else{window.game9gapp&&game9gapp.onShowPay()}};Game9GApp.prototype.postWxpay=function(data){if(this.type=="iOS"){top.location="wxapppay://"+JSON.stringify(data)}else{window.game9gapp&&game9gapp.postWxpay(JSON.stringify(data))}};Game9GApp.prototype.postAlipay=function(data){if(this.type=="iOS"){top.location="aliapppay://"+encodeURIComponent(data)}else{window.game9gapp&&game9gapp.postAlipay(data)}};Game9GPengPeng=function(game9g){this.game9g=game9g;this.version=null;this.type=null;this.shareOK=null;this.shareCancel=null;this.init()};Game9GPengPeng.prototype.init=function(){this.version=this.game9g.utils.getAppVersion();this.type=(/ios\/pengpeng/ig.test(navigator.userAgent)?"iOS":"Android")};Game9GPengPeng.prototype.setShareData=function(){try{if(this.type=="iOS"){location.href="pengpeng.setShareData://"+encodeURIComponent(JSON.stringify(this.game9g.shareData))}else{pengpeng.setShareData(JSON.stringify(this.game9g.shareData))}}catch(e){console.log(e)}};Game9GPengPeng.prototype.share=function(){try{if(this.type=="iOS"){location.href="pengpeng.share://"+encodeURIComponent(JSON.stringify(this.game9g.shareData))}else{pengpeng.share(JSON.stringify(this.game9g.shareData))}}catch(e){console.log(e)}};Game9GPengPeng.prototype.onInitGame=function(){try{if(this.type=="iOS"){location.href="pengpeng.onInitGame://"+this.game9g.gameid}else{pengpeng.onInitGame(this.game9g.gameid)}}catch(e){console.log(e)}};Game9GPengPeng.prototype.onAutoSubmit=function(data){data.score=this.game9g.score;data.scoreName=this.game9g.scoreName;data.title=this.game9g.shareData.title;try{if(this.type=="iOS"){location.href="pengpeng.onAutoSubmit://"+encodeURIComponent(JSON.stringify(data))}else{pengpeng.onAutoSubmit(JSON.stringify(data))}}catch(e){console.log(e)}};Game9GPengPeng.prototype.getToken=function(){var token=null;try{if(this.type=="Android"){token=pengpeng.getToken()}}catch(e){console.log(e)};return token};Game9GPengPeng.prototype.login=function(origin){try{var token=pengpeng.getToken();var url="http://wx.9g.com/app/login?token="+token;var _this=this;this.game9g.utils.ajax(url,function(data){if(data&&data.uid){pengpeng.onLoginSuccess(JSON.stringify(data));var redirect=_this.game9g.baseurl+"/auth/trans.app.html?origin="+encodeURIComponent(origin)+(data.accessToken?"&access_token="+data.accessToken:"")+(token?"&token="+token:"")+(data.wx9guid?"&myuid="+data.wx9guid:"");window.location.replace(redirect)}else{_this.game9g.auth.clear();pengpeng.onLoginFail()}})}catch(e){window.location=this.game9g.baseurl+"/app/login.html?r="+Math.random()}};Game9GPengPeng.prototype.chat=function(roleid){try{pengpeng.chat(roleid)}catch(e){console.log(e)}};Game9GPengPeng.prototype.cssHack=function(url){try{var css=pengpeng.cssHack(url,window.innerWidth,window.innerHeight);if(css){var style=document.createElement("style");style.textContent=css;document.getElementsByTagName("head")[0].appendChild(style)}}catch(e){console.log(e)}};Game9GUC=function(game9g){this.game9g=game9g;this.version=null;window.uc_param_str={};this.init()};Game9GUC.prototype.init=function(){this.version=this.game9g.utils.getAppVersion();var url="http://hao.uc.cn/getucparam.php";var data={uc_param_str:"dnfrpfbivecpbtnt"};this.game9g.utils.jsonp(url,data,null,function(data){window.uc_param_str=data})};Game9GUC.prototype.isVersionOver=function(version){return this.game9g.utils.compareVersion(this.version,version)};Game9GUC.prototype.share=function(){if(uc_param_str.fr==='android'||uc_param_str.fr==='iphone'){if(uc_param_str.fr==='android'){try{ucweb.startRequest("shell.page_share",[this.game9g.shareData.title,this.game9g.shareData.content,this.game9g.shareData.link,''])}catch(e){console.error(e.message)}}else{if(this.isVersionOver("9.9.0.0")){this.createIconImage();ucbrowser.web_share(this.game9g.shareData.title,this.game9g.shareData.content,this.game9g.shareData.link,'','','来自9G游戏','game9gucicon')}else{location.href="ext:web_share:"}}}else{this.game9g.utils.debug("其它分享接口")}};Game9GUC.prototype.createIconImage=function(){var img=document.getElementById("game9gucicon");if(!img){img=document.createElement("img");img.id="game9gucicon";if(this.game9g.gameid)img.src="http://game.9g.com/"+this.game9g.gameid+"/icon.png";else img.src="http://game.9g.com/icon.png";img.className="game9gucicon";document.getElementsByTagName("body")[0].appendChild(img)}};Game9GZhongsou=function(game9g){this.game9g=game9g;this.version=null;this.type=null;this.shareOK=null;this.shareCancel=null;this.init()};Game9GZhongsou.prototype.init=function(){this.type=(navigator.userAgent.match(/(iPhone|iPod|iPad)/ig)?"iOS":"Android")};Game9GZhongsou.prototype.share=function(){var sharedData={category:"share",title:this.game9g.shareData.title,url:this.game9g.shareData.link,image:this.game9g.shareData.imgurl,description:this.game9g.shareData.content};if(this.type=="iOS"){location.href="souyue.onclick://"+encodeURIComponent(JSON.stringify(sharedData))}else if(window.JavascriptInterface&&JavascriptInterface.onJSClick){JavascriptInterface.onJSClick(JSON.stringify(sharedData))}};Game9GGfan=function(game9g){this.game9g=game9g;this.version=null};Game9GGfan.prototype.share=function(){window.android.share2Friends(this.game9g.shareData.link,this.game9g.shareData.title,this.game9g.shareData.imgurl)};Game9GKuaiwanHuluxia=function(game9g){this.game9g=game9g;this.version=null;this.type=null;this.apkid=1006;this.shareOK=null;this.shareCancel=null;this.init();this.initBall()};Game9GKuaiwanHuluxia.prototype.init=function(){this.version=this.game9g.utils.getAppVersion();this.type=(this.game9g.utils.isIOS())?"iOS":"Android";if(!this.game9g.isInit)return;this.game9g.utils.require(this.game9g.baseurl+"/js/kuaiwan-huluxia-jsbridge.js");try{var _this=this;this.onReady(function(bridge){bridge.init(function(message,responseCallback){console.log("JS got a message",message);var data={"Javascript Responds":"测试中文"};console.log("JS responding with",data);responseCallback(data)})})}catch(e){alert(e)}};Game9GKuaiwanHuluxia.prototype.initBall=function(){if(!this.game9g.isInit)return;if(!this.game9g.ui.ball)return;var _this=this;this.game9g.setBallMenuItems([{icon:this.game9g.baseurl+"/img/game_menu_back.png",text:"返回",click:function(){_this.back()}},{icon:this.game9g.baseurl+"/img/game_menu_refresh.png",text:"刷新",click:function(){_this.refresh()}},{icon:this.game9g.baseurl+"/img/game_menu_exit.png",text:"退出",click:function(){_this.quit()}}])};Game9GKuaiwanHuluxia.prototype.onReady=function(callback){try{if(window.WebViewJavascriptBridge){callback&&callback.call(null,window.WebViewJavascriptBridge)}else{document.addEventListener("WebViewJavascriptBridgeReady",function(){callback&&callback.call(null,window.WebViewJavascriptBridge)},false)}}catch(e){alert(e)}};Game9GKuaiwanHuluxia.prototype.getAccess=function(callback){try{var _this=this;this.onReady(function(bridge){bridge.callHandler("access",{apk_id:_this.apkid},function(data){var json=JSON.parse(data);if(json.code==1){callback&&callback.call(null,json.data)}else{alert(json.msg)}})})}catch(e){alert(e)}};Game9GKuaiwanHuluxia.prototype.getUserInfo=function(callback){try{this.onReady(function(bridge){bridge.callHandler("userinfo",{},function(data){var json=JSON.parse(data);if(json.code==1){callback&&callback.call(null,json.data)}else{alert(json.msg)}})})}catch(e){alert(e)}};Game9GKuaiwanHuluxia.prototype.startPay=function(payData,callback){try{this.onReady(function(bridge){bridge.callHandler("pay",payData,function(data){var json=JSON.parse(data);callback&&callback.call(null,json)})})}catch(e){alert(e)}};Game9GKuaiwanHuluxia.prototype.back=function(){try{this.onReady(function(bridge){bridge.callHandler("back",{},function(data){console.log(data)})})}catch(e){alert(e)}};Game9GKuaiwanHuluxia.prototype.refresh=function(){try{this.onReady(function(bridge){bridge.callHandler("refresh",{},function(data){console.log(data)})})}catch(e){alert(e)}};Game9GKuaiwanHuluxia.prototype.quit=function(){try{this.onReady(function(bridge){bridge.callHandler("quit",{},function(data){console.log(data)})})}catch(e){alert(e)}};Game9GGgzs=function(game9g){this.game9g=game9g;this.shareOK=null;this.shareCancel=null;this.init()};Game9GGgzs.prototype.init=function(){};Game9GGgzs.prototype.login=function(options){try{var token=window.loginInfoProviderForH5.getGGTokenToH5();var deviceInfo=window.loginInfoProviderForH5.getDeviceInfoToH5();if(!token){alert("您尚未登录，请在登录后进游戏。");window.location="http://m.9g.com/menu.html?spid=ggzs&menuid=games";return};var _this=this;var url="http://wx.9g.com/ggzs/login?token="+encodeURIComponent(token)+"&device="+encodeURIComponent(deviceInfo);this.game9g.utils.ajax(url,function(data){if(data.error){alert(data.error);return};_this.game9g.auth.save(data);_this.game9g.initSpid("ggzs");options.success&&options.success.call(null)})}catch(e){alert(e)}};window._czc=window._czc||[];window.addEventListener=window.addEventListener||function(e,f){window.attachEvent("on"+e,f)};document.addEventListener=document.addEventListener||function(e,f){document.attachEvent("on"+e,f)};(function(){var lastTime=0;var vendors=['ms','moz','webkit','o'];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+'RequestAnimationFrame'];window.cancelAnimationFrame=window[vendors[x]+'CancelAnimationFrame']||window[vendors[x]+'CancelRequestAnimationFrame']};if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=new Date().getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id)}}());if(/micromessenger/ig.test(navigator.userAgent)){!function(a,b){"function"==typeof define&&(define.amd||define.cmd)?define(function(){return b(a)}):b(a,!0)}(this,function(a,b){function c(b,c,d){a.WeixinJSBridge?WeixinJSBridge.invoke(b,e(c),function(a){h(b,a,d)}):k(b,d)};function d(b,c,d){a.WeixinJSBridge?WeixinJSBridge.on(b,function(a){d&&d.trigger&&d.trigger(a),h(b,a,c)}):d?k(b,d):k(b,c)};function e(a){return a=a||{},a.appId=D.appId,a.verifyAppId=D.appId,a.verifySignType="sha1",a.verifyTimestamp=D.timestamp+"",a.verifyNonceStr=D.nonceStr,a.verifySignature=D.signature,a};function f(a){return{timeStamp:a.timestamp+"",nonceStr:a.nonceStr,"package":a.package,paySign:a.paySign,signType:a.signType||"SHA1"}};function g(a){return a.postalCode=a.addressPostalCode,delete a.addressPostalCode,a.provinceName=a.proviceFirstStageName,delete a.proviceFirstStageName,a.cityName=a.addressCitySecondStageName,delete a.addressCitySecondStageName,a.countryName=a.addressCountiesThirdStageName,delete a.addressCountiesThirdStageName,a.detailInfo=a.addressDetailInfo,delete a.addressDetailInfo,a};function h(a,b,c){var d,e,f;switch("openEnterpriseChat"==a&&(b.errCode=b.err_code),delete b.err_code,delete b.err_desc,delete b.err_detail,d=b.errMsg,d||(d=b.err_msg,delete b.err_msg,d=i(a,d),b.errMsg=d),c=c||{},c._complete&&(c._complete(b),delete c._complete),d=b.errMsg||"",D.debug&&!c.isInnerInvoke&&alert(JSON.stringify(b)),e=d.indexOf(":"),f=d.substring(e+1)){case"ok":c.success&&c.success(b);break;case"cancel":c.cancel&&c.cancel(b);break;default:c.fail&&c.fail(b)};c.complete&&c.complete(b)};function i(a,b){var e,f,c=a,d=q[c];return d&&(c=d),e="ok",b&&(f=b.indexOf(":"),e=b.substring(f+1),"confirm"==e&&(e="ok"),"failed"==e&&(e="fail"),-1!=e.indexOf("failed_")&&(e=e.substring(7)),-1!=e.indexOf("fail_")&&(e=e.substring(5)),e=e.replace(/_/g," "),e=e.toLowerCase(),("access denied"==e||"no permission to execute"==e)&&(e="permission denied"),"config"==c&&"function not exist"==e&&(e="ok"),""==e&&(e="fail")),b=c+":"+e};function j(a){var b,c,d,e;if(a){for(b=0,c=a.length;c>b;++b)d=a[b],e=p[d],e&&(a[b]=e);return a}};function k(a,b){if(!(!D.debug||b&&b.isInnerInvoke)){var c=q[a];c&&(a=c),b&&b._complete&&delete b._complete,console.log('"'+a+'",',b||"")}};function l(){if(!(v||w||D.debug||"6.0.2">A||C.systemType<0)){var b=new Image;C.appId=D.appId,C.initTime=B.initEndTime-B.initStartTime,C.preVerifyTime=B.preVerifyEndTime-B.preVerifyStartTime,G.getNetworkType({isInnerInvoke:!0,success:function(a){C.networkType=a.networkType;var c="https://open.weixin.qq.com/sdk/report?v="+C.version+"&o="+C.isPreVerifyOk+"&s="+C.systemType+"&c="+C.clientVersion+"&a="+C.appId+"&n="+C.networkType+"&i="+C.initTime+"&p="+C.preVerifyTime+"&u="+C.url;b.src=c}})}};function m(){return(new Date).getTime()};function n(b){x&&(a.WeixinJSBridge?b():r.addEventListener&&r.addEventListener("WeixinJSBridgeReady",b,!1))};function o(){G.invoke||(G.invoke=function(b,c,d){a.WeixinJSBridge&&WeixinJSBridge.invoke(b,e(c),d)},G.on=function(b,c){a.WeixinJSBridge&&WeixinJSBridge.on(b,c)})};var p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;if(!a.jWeixin)return p={config:"preVerifyJSAPI",onMenuShareTimeline:"menu:share:timeline",onMenuShareAppMessage:"menu:share:appmessage",onMenuShareQQ:"menu:share:qq",onMenuShareWeibo:"menu:share:weiboApp",onMenuShareQZone:"menu:share:QZone",previewImage:"imagePreview",getLocation:"geoLocation",openProductSpecificView:"openProductViewWithPid",addCard:"batchAddCard",openCard:"batchViewCard",chooseWXPay:"getBrandWCPayRequest",openEnterpriseRedPacket:"getRecevieBizHongBaoRequest",startSearchBeacons:"startMonitoringBeacons",stopSearchBeacons:"stopMonitoringBeacons",onSearchBeacons:"onBeaconsInRange",consumeAndShareCard:"consumedShareCard",openAddress:"editAddress"},q=function(){var b,a={};for(b in p)a[p[b]]=b;return a}(),r=a.document,s=r.title,t=navigator.userAgent.toLowerCase(),u=navigator.platform.toLowerCase(),v=!(!u.match("mac")&&!u.match("win")),w=-1!=t.indexOf("wxdebugger"),x=-1!=t.indexOf("micromessenger"),y=-1!=t.indexOf("android"),z=-1!=t.indexOf("iphone")||-1!=t.indexOf("ipad"),A=function(){var a=t.match(/micromessenger\/(\d+\.\d+\.\d+)/)||t.match(/micromessenger\/(\d+\.\d+)/);return a?a[1]:""}(),B={initStartTime:m(),initEndTime:0,preVerifyStartTime:0,preVerifyEndTime:0},C={version:1,appId:"",initTime:0,preVerifyTime:0,networkType:"",isPreVerifyOk:1,systemType:z?1:y?2:-1,clientVersion:A,url:encodeURIComponent(location.href)},D={},E={_completes:[]},F={state:0,data:{}},n(function(){B.initEndTime=m()}),G={config:function(a){D=a,k("config",a);var b=D.check===!1?!1:!0;n(function(){var a,d,e;if(b)c(p.config,{verifyJsApiList:j(D.jsApiList)},function(){E._complete=function(a){B.preVerifyEndTime=m(),F.state=1,F.data=a},E.success=function(){C.isPreVerifyOk=0},E.fail=function(a){E._fail?E._fail(a):F.state=-1};var a=E._completes;return a.push(function(){l()}),E.complete=function(){for(var c=0,d=a.length;d>c;++c)a[c]();E._completes=[]},E}()),B.preVerifyStartTime=m();else{for(F.state=1,a=E._completes,d=0,e=a.length;e>d;++d)a[d]();E._completes=[]}}),D.beta&&o()},ready:function(a){0!=F.state?a():(E._completes.push(a),!x&&D.debug&&a())},error:function(a){"6.0.2">A||(-1==F.state?a(F.data):E._fail=a)},checkJsApi:function(a){var b=function(a){var c,d,b=a.checkResult;for(c in b)d=q[c],d&&(b[d]=b[c],delete b[c]);return a};c("checkJsApi",{jsApiList:j(a.jsApiList)},function(){return a._complete=function(a){if(y){var c=a.checkResult;c&&(a.checkResult=JSON.parse(c))};a=b(a)},a}())},onMenuShareTimeline:function(a){d(p.onMenuShareTimeline,{complete:function(){c("shareTimeline",{title:a.title||s,desc:a.title||s,img_url:a.imgUrl||"",link:a.link||location.href,type:a.type||"link",data_url:a.dataUrl||""},a)}},a)},onMenuShareAppMessage:function(a){d(p.onMenuShareAppMessage,{complete:function(){c("sendAppMessage",{title:a.title||s,desc:a.desc||"",link:a.link||location.href,img_url:a.imgUrl||"",type:a.type||"link",data_url:a.dataUrl||""},a)}},a)},onMenuShareQQ:function(a){d(p.onMenuShareQQ,{complete:function(){c("shareQQ",{title:a.title||s,desc:a.desc||"",img_url:a.imgUrl||"",link:a.link||location.href},a)}},a)},onMenuShareWeibo:function(a){d(p.onMenuShareWeibo,{complete:function(){c("shareWeiboApp",{title:a.title||s,desc:a.desc||"",img_url:a.imgUrl||"",link:a.link||location.href},a)}},a)},onMenuShareQZone:function(a){d(p.onMenuShareQZone,{complete:function(){c("shareQZone",{title:a.title||s,desc:a.desc||"",img_url:a.imgUrl||"",link:a.link||location.href},a)}},a)},startRecord:function(a){c("startRecord",{},a)},stopRecord:function(a){c("stopRecord",{},a)},onVoiceRecordEnd:function(a){d("onVoiceRecordEnd",a)},playVoice:function(a){c("playVoice",{localId:a.localId},a)},pauseVoice:function(a){c("pauseVoice",{localId:a.localId},a)},stopVoice:function(a){c("stopVoice",{localId:a.localId},a)},onVoicePlayEnd:function(a){d("onVoicePlayEnd",a)},uploadVoice:function(a){c("uploadVoice",{localId:a.localId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},downloadVoice:function(a){c("downloadVoice",{serverId:a.serverId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},translateVoice:function(a){c("translateVoice",{localId:a.localId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},chooseImage:function(a){c("chooseImage",{scene:"1|2",count:a.count||9,sizeType:a.sizeType||["original","compressed"],sourceType:a.sourceType||["album","camera"]},function(){return a._complete=function(a){if(y){var b=a.localIds;b&&(a.localIds=JSON.parse(b))}},a}())},previewImage:function(a){c(p.previewImage,{current:a.current,urls:a.urls},a)},uploadImage:function(a){c("uploadImage",{localId:a.localId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},downloadImage:function(a){c("downloadImage",{serverId:a.serverId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},getNetworkType:function(a){var b=function(a){var c,d,e,b=a.errMsg;if(a.errMsg="getNetworkType:ok",c=a.subtype,delete a.subtype,c)a.networkType=c;else switch(d=b.indexOf(":"),e=b.substring(d+1)){case"wifi":case"edge":case"wwan":a.networkType=e;break;default:a.errMsg="getNetworkType:fail"};return a};c("getNetworkType",{},function(){return a._complete=function(a){a=b(a)},a}())},openLocation:function(a){c("openLocation",{latitude:a.latitude,longitude:a.longitude,name:a.name||"",address:a.address||"",scale:a.scale||28,infoUrl:a.infoUrl||""},a)},getLocation:function(a){a=a||{},c(p.getLocation,{type:a.type||"wgs84"},function(){return a._complete=function(a){delete a.type},a}())},hideOptionMenu:function(a){c("hideOptionMenu",{},a)},showOptionMenu:function(a){c("showOptionMenu",{},a)},closeWindow:function(a){a=a||{},c("closeWindow",{},a)},hideMenuItems:function(a){c("hideMenuItems",{menuList:a.menuList},a)},showMenuItems:function(a){c("showMenuItems",{menuList:a.menuList},a)},hideAllNonBaseMenuItem:function(a){c("hideAllNonBaseMenuItem",{},a)},showAllNonBaseMenuItem:function(a){c("showAllNonBaseMenuItem",{},a)},scanQRCode:function(a){a=a||{},c("scanQRCode",{needResult:a.needResult||0,scanType:a.scanType||["qrCode","barCode"]},function(){return a._complete=function(a){var b,c;z&&(b=a.resultStr,b&&(c=JSON.parse(b),a.resultStr=c&&c.scan_code&&c.scan_code.scan_result))},a}())},openAddress:function(a){c(p.openAddress,{},function(){return a._complete=function(a){a=g(a)},a}())},openProductSpecificView:function(a){c(p.openProductSpecificView,{pid:a.productId,view_type:a.viewType||0,ext_info:a.extInfo},a)},addCard:function(a){var e,f,g,h,b=a.cardList,d=[];for(e=0,f=b.length;f>e;++e)g=b[e],h={card_id:g.cardId,card_ext:g.cardExt},d.push(h);c(p.addCard,{card_list:d},function(){return a._complete=function(a){var c,d,e,b=a.card_list;if(b){for(b=JSON.parse(b),c=0,d=b.length;d>c;++c)e=b[c],e.cardId=e.card_id,e.cardExt=e.card_ext,e.isSuccess=e.is_succ?!0:!1,delete e.card_id,delete e.card_ext,delete e.is_succ;a.cardList=b,delete a.card_list}},a}())},chooseCard:function(a){c("chooseCard",{app_id:D.appId,location_id:a.shopId||"",sign_type:a.signType||"SHA1",card_id:a.cardId||"",card_type:a.cardType||"",card_sign:a.cardSign,time_stamp:a.timestamp+"",nonce_str:a.nonceStr},function(){return a._complete=function(a){a.cardList=a.choose_card_info,delete a.choose_card_info},a}())},openCard:function(a){var e,f,g,h,b=a.cardList,d=[];for(e=0,f=b.length;f>e;++e)g=b[e],h={card_id:g.cardId,code:g.code},d.push(h);c(p.openCard,{card_list:d},a)},consumeAndShareCard:function(a){c(p.consumeAndShareCard,{consumedCardId:a.cardId,consumedCode:a.code},a)},chooseWXPay:function(a){c(p.chooseWXPay,f(a),a)},openEnterpriseRedPacket:function(a){c(p.openEnterpriseRedPacket,f(a),a)},startSearchBeacons:function(a){c(p.startSearchBeacons,{ticket:a.ticket},a)},stopSearchBeacons:function(a){c(p.stopSearchBeacons,{},a)},onSearchBeacons:function(a){d(p.onSearchBeacons,a)},openEnterpriseChat:function(a){c("openEnterpriseChat",{useridlist:a.userIds,chatname:a.groupName},a)}},b&&(a.wx=a.jWeixin=G),G})};var Base64={table:['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','0','1','2','3','4','5','6','7','8','9','+','/'],UTF16ToUTF8:function(str){var res=[],len=str.length;for(var i=0;i<len;i++){var code=str.charCodeAt(i);if(code>0x0000&&code<=0x007F){res.push(str.charAt(i))}else if(code>=0x0080&&code<=0x07FF){var byte1=0xC0|((code>>6)&0x1F);var byte2=0x80|(code&0x3F);res.push(String.fromCharCode(byte1),String.fromCharCode(byte2))}else if(code>=0x0800&&code<=0xFFFF){var byte1=0xE0|((code>>12)&0x0F);var byte2=0x80|((code>>6)&0x3F);var byte3=0x80|(code&0x3F);res.push(String.fromCharCode(byte1),String.fromCharCode(byte2),String.fromCharCode(byte3))}else if(code>=0x00010000&&code<=0x001FFFFF){}else if(code>=0x00200000&&code<=0x03FFFFFF){}else{}};return res.join('')},UTF8ToUTF16:function(str){var res=[],len=str.length;var i=0;for(var i=0;i<len;i++){var code=str.charCodeAt(i);if(((code>>7)&0xFF)==0x0){res.push(str.charAt(i))}else if(((code>>5)&0xFF)==0x6){var code2=str.charCodeAt(++i);var byte1=(code&0x1F)<<6;var byte2=code2&0x3F;var utf16=byte1|byte2;res.push(Sting.fromCharCode(utf16))}else if(((code>>4)&0xFF)==0xE){var code2=str.charCodeAt(++i);var code3=str.charCodeAt(++i);var byte1=(code<<4)|((code2>>2)&0x0F);var byte2=((code2&0x03)<<6)|(code3&0x3F);var utf16=((byte1&0x00FF)<<8)|byte2;res.push(String.fromCharCode(utf16))}else if(((code>>3)&0xFF)==0x1E){}else if(((code>>2)&0xFF)==0x3E){}else{}};return res.join('')},encode:function(str){if(!str){return''};var utf8=this.UTF16ToUTF8(str);var i=0;var len=utf8.length;var res=[];while(i<len){var c1=utf8.charCodeAt(i++)&0xFF;res.push(this.table[c1>>2]);if(i==len){res.push(this.table[(c1&0x3)<<4]);res.push('==');break};var c2=utf8.charCodeAt(i++);if(i==len){res.push(this.table[((c1&0x3)<<4)|((c2>>4)&0x0F)]);res.push(this.table[(c2&0x0F)<<2]);res.push('=');break};var c3=utf8.charCodeAt(i++);res.push(this.table[((c1&0x3)<<4)|((c2>>4)&0x0F)]);res.push(this.table[((c2&0x0F)<<2)|((c3&0xC0)>>6)]);res.push(this.table[c3&0x3F])};return res.join('')},decode:function(str){if(!str){return''};var len=str.length;var i=0;var res=[];while(i<len){code1=this.table.indexOf(str.charAt(i++));code2=this.table.indexOf(str.charAt(i++));code3=this.table.indexOf(str.charAt(i++));code4=this.table.indexOf(str.charAt(i++));c1=(code1<<2)|(code2>>4);c2=((code2&0xF)<<4)|(code3>>2);c3=((code3&0x3)<<6)|code4;res.push(String.fromCharCode(c1));if(code3!=64){res.push(String.fromCharCode(c2))};if(code4!=64){res.push(String.fromCharCode(c3))}};return this.UTF8ToUTF16(res.join(''))}};